<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Fixline — Pro Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
<!-- Fonts for login + brand -->
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Concert+One&display=swap" rel="stylesheet" />
<style>
:root{
  --bg:#0b0f1e; --bg2:#0e1430;
  --panel:#111739; --panel2:#151c46; --border:#1f2757;
  --text:#e9ecf3; --muted:#a0a6c0;
  --ring:#3b82f6aa; --shadow:#0009; --r:16px;
  --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;

  /* neon palette reused from login */
  --neo:#26e7ff; --neo2:#1fd1ff;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--text);
  /* Use Orbitron everywhere to match login */
  font-family:"Orbitron", Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif;
  background:
    radial-gradient(1200px 600px at 10% 10%, #16204b 0%, transparent 55%),
    radial-gradient(900px 500px at 90% 0%, #1b2458 0%, transparent 50%),
    linear-gradient(135deg, var(--bg), var(--bg2));
  animation:bgMove 22s linear infinite alternate;
}
body::before{
  content:""; position:fixed; inset:0; z-index:-1;
  background:url('https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExNDcyaHVsMTY3N2l3NWkzZDB3aWw2MmlxY3RtbzRtbTc2MHNzejAwdiZlcD12MV9naWZzX3NlYXJjaCZjdD1n/7AtHoQ9XWbpwLRxs0t/giphy.gif')
           center/cover no-repeat fixed;
  opacity:.18; filter:saturate(1.05) contrast(1.05);
}
@keyframes bgMove{ 0%{background-position:0 0,0 0,0 0} 100%{background-position:40px -20px,-60px 30px,0 0} }
.hidden{display:none !important}

/* ===================== FLAG ICONS (data-URI) ===================== */
.flag{width:20px;height:14px;display:inline-block;border-radius:2px;box-shadow:0 0 0 1px #0005 inset;background-size:cover;background-repeat:no-repeat}
.flag-gb{background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 60 40'><rect width='60' height='40' fill='%23012169'/><path d='M0 0 L60 40 M60 0 L0 40' stroke='%23ffffff' stroke-width='8'/><path d='M0 0 L60 40 M60 0 L0 40' stroke='%23c8102e' stroke-width='4'/><path d='M30 0 v40 M0 20 h60' stroke='%23ffffff' stroke-width='10'/><path d='M30 0 v40 M0 20 h60' stroke='%23c8102e' stroke-width='6'/></svg>");}
.flag-cn{background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 60 40'><rect width='60' height='40' fill='%23DE2910'/><polygon fill='%23FFDE00' points='12,4 13.8,9.5 20,9.5 15,12.5 17,18 12,14.5 7,18 9,12.5 4,9.5 10.2,9.5'/><circle cx='22' cy='7' r='1.6' fill='%23FFDE00'/><circle cx='25' cy='10' r='1.6' fill='%23FFDE00'/><circle cx='25' cy='14' r='1.6' fill='%23FFDE00'/><circle cx='22' cy='17' r='1.6' fill='%23FFDE00'/></svg>");}

/* ===================== TOP APP CHROME (neon skin) ===================== */
.wrap{max-width:1280px;margin:28px auto;padding:0 16px}
.brand{
  display:flex; gap:12px; align-items:center; padding:12px 16px; border-radius:var(--r);
  background:linear-gradient(180deg, rgba(17,34,60,.6), rgba(10,19,36,.55));
  border:1px solid rgba(38,231,255,.35);
  box-shadow:
    0 0 0 1px rgba(38,231,255,.22) inset,
    0 10px 32px rgba(0,0,0,.45),
    0 0 36px rgba(31,209,255,.28);
}
.brand .logo{width:40px;height:40px;border-radius:12px;object-fit:contain;filter:drop-shadow(0 0 8px #60a5fa60)}
.brand small{color:var(--muted); letter-spacing:.06em}
.brand-controls{margin-left:auto; display:flex; gap:8px; align-items:center}

/* flag inside app select */
.lang-wrap{position:relative; display:inline-block}
.lang-wrap .flag{position:absolute; left:10px; top:50%; transform:translateY(-50%); pointer-events:none}
.brand-controls .lang{
  background:rgba(9,18,36,.55); color:var(--text);
  border:1px solid rgba(38,231,255,.35); border-radius:10px;
  padding:8px 10px; padding-left:34px; letter-spacing:.06em;
}
.brand-controls .logout{
  background:#2b376f; color:#fff; border:0; border-radius:10px; padding:8px 12px; cursor:pointer;
}

/* cards + headers in neon */
.card{
  background:linear-gradient(180deg, rgba(17,34,60,.6), rgba(10,19,36,.55));
  border:1px solid rgba(38,231,255,.35); border-radius:var(--r);
  box-shadow:
    0 0 0 1px rgba(38,231,255,.2) inset,
    0 10px 28px var(--shadow), inset 0 0 0 1px #0004;
}
.card .hd{
  padding:12px 16px; border-bottom:1px solid rgba(38,231,255,.28);
  display:flex; justify-content:space-between; align-items:center; gap:12px;
}
.card .bd{padding:12px 16px}

/* controls to match login inputs */
.controls{display:flex; gap:8px; flex-wrap:wrap}
.controls input,.controls select{
  background:rgba(9,18,36,.55);
  color:var(--text);
  border:1px solid rgba(38,231,255,.35);
  border-radius:12px; padding:10px 12px; min-width:240px; outline:none;
  box-shadow: 0 0 0 1px rgba(38,231,255,.15) inset, 0 0 16px rgba(38,231,255,.18);
}
.controls input:focus,.controls select:focus{
  border-color:var(--neo);
  box-shadow:0 0 0 1px rgba(38,231,255,.35) inset, 0 0 22px rgba(38,231,255,.45);
}

button{border:0;color:#fff;font-weight:700;border-radius:12px;padding:10px 14px;cursor:pointer;background:linear-gradient(180deg,#3b82f6,#1d4ed8)}
button.secondary{background:#2b376f}
/* keep action colors EXACTLY the same */
button.ok{background:linear-gradient(180deg,#10b981,#059669)}
button.warn{background:linear-gradient(180deg,#f59e0b,#b45309)}
button.danger{background:linear-gradient(180deg,#ef4444,#b91c1c)}
button.ghost{background:transparent;border:1px solid #29408a;color:#9cc3ff}

.kpis{display:flex; gap:10px; flex-wrap:wrap}
.kpi{
  flex:1; min-width:200px; background:rgba(9,18,36,.55);
  border:1px dashed rgba(38,231,255,.35); border-radius:12px; padding:10px 12px;
  position:relative; /* for gauge placement */
}
.kpi small{color:var(--muted)}

/* actions bar matches login panel chrome */
.actions{
  display:flex; gap:8px; align-items:center; flex-wrap:wrap; padding:10px 12px;
  background:rgba(9,18,36,.55); border:1px solid rgba(38,231,255,.35); border-radius:12px;
  box-shadow:inset 0 0 40px #0a1138, 0 0 30px rgba(31,209,255,.12);
}
.actions .title{font-weight:800; letter-spacing:.3px}

/* table */
table{width:100%; border-collapse:collapse}
th,td{padding:10px; border-bottom:1px solid rgba(38,231,255,.18); font-size:14px}
th{
  text-align:left; color:#c9e9ff;
  background:linear-gradient(180deg, rgba(14,21,51,.95), rgba(13,20,49,.85));
  letter-spacing:.06em
}
tbody tr:hover{background:rgba(38,231,255,.07)}

/* keep action buttons on one line */
#tbl td:last-child{ white-space:nowrap; }

/* status pills */
.pill{padding:4px 10px; border-radius:999px; font-weight:800; font-size:12px; display:inline-flex; align-items:center; gap:6px}
.p-run{background:#0a3a29; color:#34d399; animation:pulse 1.6s ease-in-out infinite}
.p-exited{background:#3a0a0a; color:#fca5a5}
.p-stalled{background:#3f2a06; color:#fbbf24; animation:pulse 1.2s ease-in-out infinite}
.p-unknown{background:#2a2a2a; color:#bbb}
@keyframes pulse{0%,100%{filter:brightness(1)}50%{filter:brightness(1.2)}}

/* legend dots */
.dot{width:8px;height:8px;border-radius:999px;display:inline-block}
.dot.run{background:#34d399}.dot.stalled{background:#fbbf24}.dot.exited{background:#f87171}.dot.unknown{background:#9aa}

/* Logs dialog */
dialog{border:0;border-radius:16px;padding:0;max-width:920px;width:90%}
.modal{
  background:linear-gradient(180deg, rgba(17,34,60,.92), rgba(10,19,36,.92));
  border:1px solid rgba(38,231,255,.35); box-shadow:0 30px 120px #000c
}
.modal header{display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid rgba(38,231,255,.28)}
.logbox{padding:12px 16px; background:#0c122a; font-family:ui-monospace,Consolas,Menlo,monospace; white-space:pre-wrap; max-height:65vh; overflow:auto}

/* Toasts (raise above login panel) */
.toast{position:fixed; right:16px; bottom:16px; display:grid; gap:8px; z-index:200}
.toast .t{background:#0c122a; border:1px solid #2c3d82; color:#cfe4ff; padding:10px 12px; border-radius:10px;
  box-shadow:0 10px 26px #000a; animation:slideIn .2s ease, fadeOut 5s forwards}
@keyframes slideIn{from{transform:translateY(6px); opacity:0}to{transform:translateY(0); opacity:1}}
@keyframes fadeOut{0%,80%{opacity:1}100%{opacity:0}}

/* Confirm bar */
#confirmWrap{position:fixed; top:14px; left:50%; transform:translateX(-50%); z-index:60}
#confirmBar{display:none; min-width:380px; max-width:92vw; background:linear-gradient(180deg, rgba(17,34,60,.95), rgba(10,19,36,.95)); border:1px solid rgba(38,231,255,.35); border-radius:14px; box-shadow:0 18px 60px #000c}
#confirmBar header{padding:10px 14px; border-bottom:1px solid rgba(38,231,255,.28); font-weight:800}
#confirmBar .body{padding:12px 14px}
#confirmBar .actions{display:flex; gap:8px; justify-content:flex-end; padding:10px 14px; border-top:1px solid rgba(38,231,255,.28)}

/* ===== 3D glow “FixLine” brand (scoped) ===== */
.brand-title { position:relative; height:34px; display:flex; align-items:center }
.brand-title figure{
  margin:0; position:relative; height:34px; transform-style:preserve-3d; animation:wobbleBrand 5s ease-in-out infinite;
}
.brand-title h1{
  margin:0; position:absolute; inset:0 auto auto 0;
  display:block; padding:0; line-height:34px;
  font:900 26px 'Concert One', sans-serif;
  color:#0a0a0a; text-transform:uppercase;
  animation:glowBrand 10s ease-in-out infinite;
}
@keyframes glowBrand{
  0%,100%{ text-shadow:0 0 18px red; }
  25%{ text-shadow:0 0 18px orange; }
  50%{ text-shadow:0 0 18px forestgreen; }
  75%{ text-shadow:0 0 18px cyan; }
}
@keyframes wobbleBrand{
  0%,100%{ transform:rotate3d(1,1,0,20deg); }
  25%{ transform:rotate3d(-1,1,0,20deg); }
  50%{ transform:rotate3d(-1,-1,0,20deg); }
  75%{ transform:rotate3d(1,-1,0,20deg); }
}
.brand-title h1:nth-child(2){ transform:translateZ(1px); }
.brand-title h1:nth-child(3){ transform:translateZ(2px);}
.brand-title h1:nth-child(4){ transform:translateZ(3px); }
.brand-title h1:nth-child(5){ transform:translateZ(4px); }
.brand-title h1:nth-child(6){ transform:translateZ(5px); }
.brand-title h1:nth-child(7){ transform:translateZ(6px); }
.brand-title h1:nth-child(8){ transform:translateZ(7px); }
.brand-title h1:nth-child(9){ transform:translateZ(8px); }
.brand-title h1:nth-child(10){ transform:translateZ(9px); }

/* ===================== NEON LOGIN (scoped to #login) ===================== */
#login{
  position:fixed; inset:0; z-index:80;
  font-family:"Orbitron",system-ui,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
  color:#cfefff; overflow:hidden;
  --bg:#070b14; --bg2:#0b1222; --grid:#0e1a2f; --neo:#26e7ff; --neo2:#1fd1ff; --text:#cfefff; --muted:#7fbad1;
  background:
    radial-gradient(1600px 800px at 28% 70%, #0c1b2f 0%, #08111f 55%, var(--bg) 100%),
    linear-gradient(180deg, var(--bg2), var(--bg));
}
#login::before{
  content:""; position:fixed; inset:0; pointer-events:none; opacity:.55;
  background:
    radial-gradient(circle at 1px 1px, #0f223d 1px, transparent 1px) 0 0/22px 22px,
    radial-gradient(circle at 1px 1px, #0f223d 1px, transparent 1px) 11px 11px/22px 22px;
}
#login .neon-wrap{
  height:100%;
  display:grid;
  grid-template-columns: 1.15fr 0.85fr;
  gap:2.4rem;
  padding:2.6rem 3rem;
}
#login .scene{ position:relative; display:flex; align-items:center; justify-content:flex-start; padding-left:1.4rem; }
#login .net{ position:absolute; left:0; top:8%; width:min(860px, 65vw); height:min(620px, 60vh); filter: drop-shadow(0 0 12px rgba(31,209,255,.35)); opacity:.9; }
#login .bulb{ position:relative; width:min(560px, 46vw); height:auto; margin-left:2.4rem;
  filter: drop-shadow(0 0 10px rgba(31,209,255,.6)) drop-shadow(0 0 26px rgba(31,209,255,.35));
}
#login #bulbOutline{ stroke-dasharray: 4 10; animation:dash 12s linear infinite } @keyframes dash{ to{ stroke-dashoffset:-420 } }
#login .node{ animation:twinkle 3.2s linear infinite var(--d,0s) } @keyframes twinkle{ 0%,100%{opacity:.45} 50%{opacity:1} }
#login .rings{ position:absolute; left:3.2rem; bottom:5%; width:min(680px, 55vw); height:180px; pointer-events:none; filter: drop-shadow(0 0 22px rgba(31,209,255,.3)); }

/* Panel */
#login .panel{
  align-self:center;
  background: linear-gradient(180deg, rgba(17,34,60,.6), rgba(10,19,36,.55));
  border:1px solid rgba(38,231,255,.35);
  border-radius:14px;
  padding:28px 26px 24px;
  position:relative;
  backdrop-filter: blur(6px);
  box-shadow:
    0 0 0 1px rgba(38,231,255,.22) inset,
    0 10px 32px rgba(0,0,0,.45),
    0 0 36px rgba(31,209,255,.28);
}
#login .panel::before,
#login .panel::after{ content:""; position:absolute; inset:10px; pointer-events:none; border-radius:10px; }
#login .panel::before{ box-shadow: 0 0 30px rgba(38,231,255,.35) inset; }
#login .panel::after{
  background:
    linear-gradient(90deg, transparent, rgba(38,231,255,.25), transparent) 0 0/100% 2px no-repeat,
    linear-gradient(0deg, transparent, rgba(38,231,255,.22), transparent) 0 100%/2px 100% no-repeat;
  opacity:.55;
}
#login .hdr{ display:flex; align-items:center; gap:12px; margin-bottom:14px; }
#login .badge{ width:34px; height:34px; border:2px solid var(--neo); border-radius:8px; display:grid; place-items:center; color:var(--neo); text-shadow:0 0 10px rgba(31,209,255,.8); }
#login .title{ font-weight:800; letter-spacing:.14em; text-transform:uppercase; font-size:1.05rem }
#login .sub{ font-size:.7rem; letter-spacing:.22em; color:var(--muted); margin-top:2px }

/* Inputs */
#login .field{ position:relative; margin:16px 0 18px }
#login .input{
  width:100%; background:rgba(9,18,36,.55);
  border:1px solid rgba(38,231,255,.35);
  border-radius:9px; padding:14px 44px; color:var(--text);
  letter-spacing:.06em; outline:none;
  box-shadow: 0 0 0 1px rgba(38,231,255,.15) inset, 0 0 16px rgba(38,231,255,.18);
}
#login .input:focus{
  border-color:var(--neo);
  box-shadow:0 0 0 1px rgba(38,231,255,.35) inset, 0 0 22px rgba(38,231,255,.45);
}
#login .ico{ position:absolute; left:14px; top:50%; transform:translateY(-50%); color:var(--neo); opacity:.95; font-size:.95rem; text-shadow:0 0 12px rgba(31,209,255,.9); }
#login .hint{ display:flex; justify-content:space-between; align-items:center; gap:8px; font-size:.75rem; color:var(--muted); margin-top:4px; }
#login .hint a{ color:var(--neo); text-decoration:none } #login .hint a:hover{text-decoration:underline}
#login .btn{
  width:100%; margin-top:18px; cursor:pointer;
  background:
    radial-gradient(220px 80px at 50% 0%, rgba(38,231,255,.35), transparent 60%),
    linear-gradient(180deg, rgba(38,231,255,.25), rgba(38,231,255,.08));
  border:1px solid rgba(38,231,255,.62); border-radius:12px;
  padding:14px 16px; letter-spacing:.22em; text-transform:uppercase; font-weight:800;
  color:#00161a; text-shadow:0 0 12px rgba(255,255,255,.65);
  box-shadow:0 0 22px rgba(31,209,255,.45), inset 0 0 14px rgba(31,209,255,.35);
  position:relative;
}
#login .btn::before,#login .btn::after{ content:""; position:absolute; top:50%; width:18px; height:2px; background:var(--neo); box-shadow:0 0 8px var(--neo); }
#login .btn::before{ left:14px; transform:translateY(-50%) }
#login .btn::after{ right:14px; transform:translateY(-50%) }
#login .btn:hover{ filter:brightness(1.05); box-shadow:0 0 28px rgba(31,209,255,.6), inset 0 0 16px rgba(31,209,255,.5) }
#login .brand{ margin-top:18px; font-size:.7rem; letter-spacing:.25em; color:#8fb9e4; text-align:center }

/* Login flags dropdown */
#login .login-lang{ position:absolute; top:12px; right:12px; z-index:2; }
#login .login-lang .btnX{
  display:flex; align-items:center; gap:8px;
  background:rgba(9,18,36,.55); color:#e9ecf3; border:1px solid rgba(38,231,255,.35);
  border-radius:10px; padding:8px 10px; cursor:pointer; font-family:inherit;
}
#login .login-lang .panelX{
  position:absolute; top:40px; right:0; display:grid; gap:6px;
  background:rgba(9,18,36,.85); border:1px solid rgba(38,231,255,.35); border-radius:10px;
  padding:8px; min-width:160px; box-shadow:0 16px 40px #000a;
}
#login .login-lang .optX{ display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:8px; cursor:pointer; }
#login .login-lang .optX:hover{ background:#10183a }
#login .login-lang .caret{ margin-left:6px; opacity:.8 }

#lg_err{display:none; margin-top:10px; color:#fecaca; background:#3a0a0a; border:1px solid #7f1d1d; padding:8px 10px; border-radius:10px}

@media (max-width: 1024px){
  #login .neon-wrap{ grid-template-columns:1fr; padding:2rem }
  #login .scene{ order:2; justify-content:center; padding-left:0 }
  #login .bulb{ margin-left:0 }
  #login .rings{ left:50%; transform:translateX(-50%) }
}

/* ---------- Live clock (no box) ---------- */
.live-clock{display:grid; gap:2px; text-align:right; line-height:1; margin-right:6px}
.live-clock .lc-date{font-size:12px; color:#9fdcff; letter-spacing:.18em; opacity:.9; text-shadow:0 0 10px rgba(31,209,255,.45)}
.live-clock .lc-time{font-size:18px; font-weight:800; letter-spacing:.12em; text-shadow:0 0 14px rgba(31,209,255,.55)}
.live-clock .lc-label{font-size:10px; opacity:.7; letter-spacing:.2em}

/* ---------- Compact gauges inside KPI ---------- */
.kpi{ position:relative }
.gauge{
  position:absolute;
  right:6px;
  bottom:4px;
  width:110px;
  height:50px;
  pointer-events:none;
  opacity:.95;
}
.gauge canvas{
  width:110px;
  height:50px;
  display:block;
  filter:drop-shadow(0 0 5px rgba(31,209,255,.2));
}
.gauge .pct{
  position:absolute;
  left:50%;
  bottom:2px;
  transform:translateX(-50%);
  font-size:9px;
  color:#bfe4ff;
  letter-spacing:.06em;
}
</style>
</head>
<body>

<!-- =============== LOGIN (Neon) =============== -->
<div id="login">
  <div class="neon-wrap">
    <!-- LEFT Visuals -->
    <div class="scene">
      <svg class="net" viewBox="0 0 900 640" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs><linearGradient id="line" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="rgba(38,231,255,.35)"/><stop offset="1" stop-color="rgba(38,231,255,.15)"/></linearGradient></defs>
        <g stroke="url(#line)" stroke-width="1.2">
          <line x1="40" y1="560" x2="280" y2="320"/><line x1="280" y1="320" x2="520" y2="180"/><line x1="520" y1="180" x2="800" y2="80"/>
          <line x1="520" y1="180" x2="840" y2="280"/><line x1="280" y1="320" x2="100" y2="120"/><line x1="100" y1="120" x2="420" y2="60"/>
          <line x1="420" y1="60"  x2="760" y2="200"/><line x1="120" y1="460" x2="380" y2="260"/><line x1="380" y1="260" x2="680" y2="160"/>
          <line x1="220" y1="240" x2="540" y2="120"/><line x1="160" y1="380" x2="460" y2="220"/>
        </g>
        <g fill="var(--neo)"><circle cx="100" cy="120" r="3"/><circle cx="420" cy="60" r="3"/><circle cx="760" cy="200" r="3"/><circle cx="800" cy="80" r="3"/><circle cx="840" cy="280" r="3"/><circle cx="520" cy="180" r="3"/><circle cx="280" cy="320" r="3"/><circle cx="40"  cy="560" r="3"/><circle cx="120" cy="460" r="3"/><circle cx="380" cy="260" r="3"/><circle cx="680" cy="160" r="3"/></g>
      </svg>

      <svg class="bulb" viewBox="0 0 560 720" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs>
          <clipPath id="bulbClip">
            <path d="M280,40 C175,40, 90,120, 90,220 C90,320,150,360,180,420 C205,468,210,520,210,560 L350,560 C350,520,355,468,380,420 C410,360,470,320,470,220 C470,120,385,40,280,40Z"/>
          </clipPath>
          <filter id="glow" x="-50%" y="-50%" width="200%" height="200%"><feGaussianBlur stdDeviation="3" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
          <linearGradient id="strokeGrad" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="var(--neo)"/><stop offset="1" stop-color="var(--neo2)"/></linearGradient>
        </defs>
        <path id="bulbOutline" d="M280,40 C175,40,90,120,90,220 C90,320,150,360,180,420 C205,468,210,520,210,560 L350,560 C350,520,355,468,380,420 C410,360,470,320,470,220 C470,120,385,40,280,40Z" fill="none" stroke="url(#strokeGrad)" stroke-width="3.5" filter="url(#glow)"/>
        <g clip-path="url(#bulbClip)" stroke="rgba(38,231,255,.55)" stroke-width="1.2">
          <line x1="120" y1="220" x2="220" y2="120"/><line x1="220" y1="120" x2="340" y2="120"/><line x1="340" y1="120" x2="440" y2="220"/>
          <line x1="120" y1="220" x2="200" y2="260"/><line x1="200" y1="260" x2="280" y2="180"/><line x1="280" y1="180" x2="360" y2="260"/>
          <line x1="360" y1="260" x2="440" y2="220"/><line x1="200" y1="260" x2="220" y2="340"/><line x1="220" y1="340" x2="300" y2="300"/>
          <line x1="300" y1="300" x2="360" y2="260"/><line x1="220" y1="340" x2="260" y2="420"/><line x1="260" y1="420" x2="320" y2="420"/>
          <line x1="320" y1="420" x2="340" y2="340"/><line x1="340" y1="340" x2="300" y2="300"/>
          <g fill="var(--neo)">
            <circle class="node" cx="220" cy="120" r="3" style="--d:.2s"/><circle class="node" cx="340" cy="120" r="3" style="--d:.8s"/>
            <circle class="node" cx="120" cy="220" r="3"/><circle class="node" cx="440" cy="220" r="3" style="--d:1.1s"/>
            <circle class="node" cx="200" cy="260" r="3" style="--d:.6s"/><circle class="node" cx="360" cy="260" r="3" style="--d:1.4s"/>
            <circle class="node" cx="280" cy="180" r="3" style="--d:.4s"/><circle class="node" cx="220" cy="340" r="3" style="--d:1.8s"/>
            <circle class="node" cx="300" cy="300" r="3" style="--d:1.2s"/><circle class="node" cx="340" cy="340" r="3" style="--d:.9s"/>
            <circle class="node" cx="260" cy="420" r="3" style="--d:1.6s"/><circle class="node" cx="320" cy="420" r="3" style="--d:2.1s"/>
          </g>
        </g>
        <rect x="210" y="560" width="140" height="40" rx="6" fill="rgba(38,231,255,.08)" stroke="var(--neo)" stroke-width="2"/>
        <rect x="210" y="600" width="140" height="40" rx="6" fill="rgba(38,231,255,.08)" stroke="var(--neo)" stroke-width="2"/>
      </svg>
      <svg class="rings" viewBox="0 0 700 180" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs><radialGradient id="ringGrad"><stop offset="0" stop-color="rgba(38,231,255,.45)"/><stop offset="0.65" stop-color="rgba(38,231,255,.15)"/><stop offset="1" stop-color="rgba(38,231,255,0)"/></radialGradient></defs>
        <ellipse cx="260" cy="150" rx="150" ry="15" fill="url(#ringGrad)"/>
        <ellipse cx="260" cy="128" rx="200" ry="22" fill="url(#ringGrad)"/>
        <ellipse cx="260" cy="112" rx="260" ry="28" fill="url(#ringGrad)"/>
        <ellipse cx="260" cy="96"  rx="310" ry="34" fill="none" stroke="rgba(38,231,255,.25)" stroke-width="2"/>
        <ellipse cx="260" cy="96"  rx="340" ry="40" fill="none" stroke="rgba(38,231,255,.18)" stroke-width="2" stroke-dasharray="6 10"/>
      </svg>
    </div>

    <!-- RIGHT Panel -->
    <form id="loginForm" class="panel" autocomplete="off">
      <!-- login language dropdown with flags -->
      <div class="login-lang" id="loginLang">
        <button type="button" class="btnX" id="loginLangBtn">
          <span id="loginLangText"><span class="flag flag-gb"></span> English</span>
          <span class="caret">▾</span>
        </button>
        <div class="panelX hidden" id="loginLangPanel">
          <div class="optX" data-val="en"><span class="flag flag-gb"></span><span>English</span></div>
          <div class="optX" data-val="zh"><span class="flag flag-cn"></span><span>中文</span></div>
        </div>
      </div>

      <div class="hdr">
        <div class="badge">🌐</div>
        <div>
          <div class="title" id="lg_title">Welcome to Fixline</div>
          <div class="sub" id="lg_sub">Enter your Fixline credentials to continue.</div>
        </div>
      </div>

      <div class="field">
        <span class="ico">👤</span>
        <input id="lg_user" class="input" type="text" placeholder="Username" required />
      </div>

      <div class="field">
        <span class="ico">🔑</span>
        <input id="lg_pass" class="input" type="password" placeholder="Password" required />
      </div>

      <div class="hint">
        <label><input id="lg_rem" type="checkbox" style="accent-color:#19e3ff"> <span id="lg_rem_txt">Remember me</span></label>
        <a href="#" id="lg_forgot">Forgot password?</a>
      </div>

      <button id="lg_btn" class="btn" type="submit">LOGIN</button>
      <div id="lg_err">Invalid username or password.</div>
      <div class="brand">© 2025 Secure Systems Lab</div>
    </form>
  </div>
</div>

<!-- =============== APP =============== -->
<div id="app" class="wrap hidden">
  <div class="brand">
    <img class="logo" alt="Fixline logo"
      src="https://media.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3bWwwaWhjYnhoeXZnaXJud3R5bnQwa3hhYWxzZzNsYXByZXZ1b2E0NSZlcD12MV9zdGlja2Vyc19zZWFyY2gmY3Q9cw/N46SQxBFH9qXv6vq21/giphy.gif" />
    <div>
      <div class="brand-title" aria-label="Fixline">
        <figure>
          <h1>FixLine</h1><h1>FixLine</h1><h1>FixLine</h1><h1>FixLine</h1><h1>FixLine</h1>
          <h1>FixLine</h1><h1>FixLine</h1><h1>FixLine</h1><h1>FixLine</h1><h1>FixLine</h1>
        </figure>
      </div>
      <small id="brand_subtitle">Operate scripts with confidence</small>
    </div>
    <div class="brand-controls">
      <!-- Live clock (added) -->
      <div id="liveClock" class="live-clock">
        <div class="lc-date">—</div>
        <div class="lc-time">—</div>
        <div class="lc-label">Current Live Time</div>
      </div>
      <div class="lang-wrap">
        <span id="topFlag" class="flag flag-gb" aria-hidden="true"></span>
        <select id="langSel" class="lang" title="Language">
          <option value="en">English</option>
          <option value="zh">中文</option>
        </select>
      </div>
      <button id="logout" class="logout" title="Logout">Logout</button>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="hd">
      <strong id="connTitle">Connection</strong>
      <div class="controls">
        <input id="base" placeholder="(API Link Based)" />
        <input id="token" placeholder="(Token Name)" />
        <select id="interval">
          <option value="0">Auto-refresh: Off</option>
          <option value="1000">Auto-refresh: On</option>
        </select>
        <button id="connect">Connect</button>
        <button id="refresh" class="secondary">Refresh</button>
      </div>
    </div>
    <div class="bd">
      <div class="kpis">
        <div class="kpi">
          <small id="kpi_total_lbl">Total Scripts</small>
          <div><strong id="k_total">—</strong></div>
          <div class="gauge" id="g_total"><canvas width="110" height="50"></canvas><div class="pct">0%</div></div>
        </div>
        <div class="kpi">
          <small id="kpi_run_lbl">Running</small>
          <div><strong id="k_run">—</strong></div>
          <div class="gauge" id="g_run"><canvas width="110" height="50"></canvas><div class="pct">0%</div></div>
        </div>
        <div class="kpi">
          <small id="kpi_stalled_lbl">Stalled</small>
          <div><strong id="k_stalled">—</strong></div>
          <div class="gauge" id="g_stall"><canvas width="110" height="50"></canvas><div class="pct">0%</div></div>
        </div>
        <div class="kpi">
          <small id="kpi_exited_lbl">Exited</small>
          <div><strong id="k_exited">—</strong></div>
          <div class="gauge" id="g_exit"><canvas width="110" height="50"></canvas><div class="pct">0%</div></div>
        </div>
      </div>
      <legend>
        <span class="dot run"></span> <span id="legend_running">Running</span>
        <span class="dot stalled" style="margin-left:12px"></span> <span id="legend_stalled">Stalled</span>
        <span class="dot exited" style="margin-left:12px"></span> <span id="legend_exited">Exited</span>
        <span class="dot unknown" style="margin-left:12px"></span> <span id="legend_unknown">Unknown</span>
      </legend>
    </div>
  </div>

  <div class="actions" style="margin:12px 0">
    <div class="title" id="importantActions">IMPORTANT ACTIONS</div>
    <button class="ok" id="adopt" title="Not used in Sheets mode">Auto Running</button>
    <button class="warn" id="restartAll" title="Requires Commands endpoint">Restart All</button>
    <button class="danger" id="stopAll" title="Requires Commands endpoint">Stop All</button>
    <button class="ghost" id="copyCurl">Copy Data URL</button>
  </div>

  <div class="card">
    <div class="bd" style="overflow:auto">
      <table id="tbl">
        <thead>
          <tr>
            <th id="th_script" style="min-width:280px">Script</th>
            <th id="th_pid">PID</th>
            <th id="th_cpu">CPU%</th>
            <th id="th_ram">RAM%</th>
            <th id="th_uptime">Uptime</th>
            <th id="th_status">Status</th>
            <th id="th_actions" style="min-width:280px">Actions</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td id="no_data_text" colspan="7">No data yet. Click <b>Connect</b>.</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Logs -->
<dialog id="logDlg" class="modal">
  <header>
    <strong id="logTitle">Logs</strong>
    <div>
      <button class="secondary" id="copyLog">Copy</button>
      <button id="closeLog">Close</button>
    </div>
  </header>
  <div id="logBox" class="logbox"></div>
</dialog>

<!-- Confirm -->
<div id="confirmWrap">
  <div id="confirmBar" role="dialog" aria-modal="true" aria-labelledby="cfTitle">
    <header id="cfTitle">Fixline says</header>
    <div class="body" id="cfMsg">Are you sure?</div>
    <div class="actions">
      <button id="cfOk" class="ok">OK</button>
      <button id="cfCancel" class="secondary">Cancel</button>
    </div>
  </div>
</div>

<!-- Toasts -->
<div id="toast" class="toast"></div>

<script>
/* ====== i18n ====== */
const LANG_KEY='fixline_lang', AUTH_KEY='fixline_logged';
const i18n = {
  en:{ login_title:'Welcome to Fixline',login_sub:'Enter your Fixline credentials to continue.',
       username:'Username',password:'Password',remember:'Remember me',login:'Login',invalid:'Invalid username or password.',forgot:'Forgot password?',logout:'Logout',
       subtitle:'Operate scripts with confidence',
       connection:'Connection',connect:'Connect',refresh:'Refresh',
       auto_off:'Auto-refresh: Off',auto_on:'Auto-refresh: On',
       total:'Total Scripts',running:'Running',stalled:'Stalled',exited:'Exited',unknown:'Unknown',
       important:'IMPORTANT ACTIONS',auto_run:'Auto Running',restart_all:'Restart All',stop_all:'Stop All',copy_url:'Copy Data URL',
       th_script:'Script',th_pid:'PID',th_cpu:'CPU%',th_ram:'RAM%',th_uptime:'Uptime',th_status:'Status',th_actions:'Actions',
       start:'Start',restart:'Restart',stop:'Stop',logs:'Logs',no_data:'No data yet. Click <b>Connect</b>.',
       says:'Fixline says',cf_ok:'OK',cf_cancel:'Cancel',
       q_start:'Start "{name}"?',q_restart:'Restart "{name}"?',q_stop:'STOP "{name}"?',
       q_auto:'Enable Auto Running via Agent?\\n\\n(Info: in Google Sheets mode this is a no-op.)',
       q_restart_all:'Restart ALL scripts?',q_stop_all:'STOP ALL scripts?',
       connected:'Connected.',refresh_fail:'Refresh failed: ',sheets_na:'Not used in Sheets mode.',need_cmd:'Requires Commands endpoint.',copied:'Data URL copied.',auto_upd:'Auto-refresh updated.',logs_na:'Logs not available in Sheets-only mode.' },
  zh:{ login_title:'登录',login_sub:'请输入 Fixline 账号以继续。',username:'用户名',password:'密码',remember:'记住我',login:'登录',invalid:'账号或密码错误。',forgot:'忘记密码？',logout:'退出登录',
       subtitle:'自信地管理脚本',
       connection:'连接',connect:'连接',refresh:'刷新',
       auto_off:'自动刷新：关闭',auto_on:'自动刷新：开启',
       total:'脚本总数',running:'运行中',stalled:'卡住',exited:'已退出',unknown:'未知',
       important:'重要操作',auto_run:'自动运行',restart_all:'全部重启',stop_all:'全部停止',copy_url:'复制数据链接',
       th_script:'脚本',th_pid:'PID',th_cpu:'CPU%',th_ram:'内存%',th_uptime:'运行时间',th_status:'状态',th_actions:'操作',
       start:'启动',restart:'重启',stop:'停止',logs:'日志',no_data:'暂无数据。请点击 <b>连接</b>。',
       says:'Fixline 提示',cf_ok:'确定',cf_cancel:'取消',
       q_start:'启动“{name}”？',q_restart:'重启“{name}”？',q_stop:'停止“{name}”？',
       q_auto:'通过 Agent 启用自动运行？\\n\\n（提示：在表格模式下无效。）',
       q_restart_all:'重启所有脚本？',q_stop_all:'停止所有脚本？',
       connected:'已连接。',refresh_fail:'刷新失败：',sheets_na:'在表格模式下不可用。',need_cmd:'需要 Commands 端点。',copied:'数据链接已复制。',auto_upd:'自动刷新已更新。',logs_na:'在表格模式下没有日志。' }
};
let lang = localStorage.getItem(LANG_KEY) || 'en';
document.documentElement.lang = lang;
const t = (k,vars={}) => (i18n[lang][k]||k).replace(/\{(\w+)\}/g,(_,m)=>vars[m]??'');

/* helpers */
const $ = s => document.querySelector(s);
function toast(msg){ const box=$('#toast'); const d=document.createElement('div'); d.className='t'; d.innerHTML=msg; box.appendChild(d); setTimeout(()=>d.remove(),5200); }

/* top app flag */
function setTopBarFlag(){ const f=$('#topFlag'); if(f) f.className='flag '+(lang==='zh'?'flag-cn':'flag-gb'); }

/* Login text bindings */
const USER='admin', PASS='Fixline@123';
function setLoginTexts(){
  $('#lg_title').textContent=t('login_title');
  $('#lg_sub').textContent=t('login_sub');
  $('#lg_user').placeholder=t('username');
  $('#lg_pass').placeholder=t('password');
  $('#lg_rem_txt').textContent=t('remember');
  $('#lg_btn').textContent=t('login');
  $('#lg_err').textContent=t('invalid');
  $('#lg_forgot').textContent=t('forgot');
  const btn = $('#loginLangText');
  if(btn) btn.innerHTML = (lang==='zh'
    ? "<span class='flag flag-cn'></span> 中文"
    : "<span class='flag flag-gb'></span> English");
}
function setAppTexts(){
  $('#brand_subtitle').textContent=t('subtitle');
  $('#connTitle').textContent=t('connection');
  $('#connect').textContent=t('connect');
  $('#refresh').textContent=t('refresh');
  const sel=$('#interval'); sel.options[0].text=t('auto_off'); sel.options[1].text=t('auto_on');
  $('#kpi_total_lbl').textContent=t('total'); $('#kpi_run_lbl').textContent=t('running'); $('#kpi_stalled_lbl').textContent=t('stalled'); $('#kpi_exited_lbl').textContent=t('exited');
  $('#legend_running').textContent=t('running'); $('#legend_stalled').textContent=t('stalled'); $('#legend_exited').textContent=t('exited'); $('#legend_unknown').textContent=t('unknown');
  $('#importantActions').textContent=t('important');
  $('#adopt').textContent=t('auto_run'); $('#restartAll').textContent=t('restart_all'); $('#stopAll').textContent=t('stop_all'); $('#copyCurl').textContent=t('copy_url');
  $('#th_script').textContent=t('th_script'); $('#th_pid').textContent=t('th_pid'); $('#th_cpu').textContent=t('th_cpu'); $('#th_ram').textContent=t('th_ram'); $('#th_uptime').textContent=t('th_uptime'); $('#th_status').textContent=t('th_status'); $('#th_actions').textContent=t('th_actions');
  $('#no_data_text').innerHTML=t('no_data');
  $('#logout').textContent=t('logout');
  $('#cfTitle').textContent=t('says'); $('#cfOk').textContent=t('cf_ok'); $('#cfCancel').textContent=t('cf_cancel');
  setTopBarFlag();
}
function showApp(){ $('#login').classList.add('hidden'); $('#app').classList.remove('hidden'); setAppTexts(); loadOverview().catch(()=>{}); }
function showLogin(){ $('#app').classList.add('hidden'); $('#login').classList.remove('hidden'); setLoginTexts(); $('#lg_user').focus(); }
setLoginTexts();

/* Login language dropdown */
(function initLoginLang(){
  const wrap = $('#loginLang'), btn = $('#loginLangBtn'), panel = $('#loginLangPanel');
  function setBtn(){ $('#loginLangText').innerHTML = (lang==='zh' ? "<span class='flag flag-cn'></span> 中文" : "<span class='flag flag-gb'></span> English"); }
  setBtn();
  btn.addEventListener('click', (e)=>{ e.stopPropagation(); panel.classList.toggle('hidden'); });
  panel.querySelectorAll('.optX').forEach(opt=>{
    opt.addEventListener('click', ()=>{
      lang = opt.dataset.val || 'en';
      localStorage.setItem(LANG_KEY, lang);
      document.documentElement.lang = lang;
      setBtn(); setLoginTexts(); setAppTexts(); updateTableLanguage();
      panel.classList.add('hidden');
      const sel = $('#langSel'); if(sel) sel.value = lang;
    });
  });
  document.addEventListener('click', (e)=>{ if(!wrap.contains(e.target)) panel.classList.add('hidden'); });
})();

/* table labels instant relabel */
function updateTableLanguage(){
  document.querySelectorAll('button[data-start]').forEach(b => b.textContent = t('start'));
  document.querySelectorAll('button[data-restart]').forEach(b => b.textContent = t('restart'));
  document.querySelectorAll('button[data-stop]').forEach(b => b.textContent = t('stop'));
  document.querySelectorAll('button[data-logs]').forEach(b => b.textContent = t('logs'));
  document.querySelectorAll('#tbody .pill').forEach(el => {
    let key = 'unknown';
    if (el.classList.contains('p-run')) key='running';
    else if (el.classList.contains('p-stalled')) key='stalled';
    else if (el.classList.contains('p-exited')) key='exited';
    else if (el.classList.contains('p-unknown')) key='unknown';
    el.textContent = t(key);
  });
}

/* login submit */
document.querySelector('#loginForm').addEventListener('submit',e=>{
  e.preventDefault();
  const u=$('#lg_user').value.trim(), p=$('#lg_pass').value;
  if(u===USER && p===PASS){ $('#lg_err').style.display='none'; if($('#lg_rem').checked) localStorage.setItem(AUTH_KEY,'1'); showApp(); }
  else { $('#lg_err').style.display='block'; }
});
$('#logout').addEventListener('click',()=>{ localStorage.removeItem(AUTH_KEY); if(timer) clearInterval(timer); showLogin(); });
$('#lg_forgot').addEventListener('click',e=>{ e.preventDefault(); toast('Contact to BA Support'); });

/* top select language (app) */
const langSel = $('#langSel'); if(langSel) langSel.value = lang;
function applyLanguage(){
  localStorage.setItem(LANG_KEY, lang);
  document.documentElement.lang = lang;
  setLoginTexts(); setAppTexts(); updateTableLanguage();
}
if(langSel){
  langSel.addEventListener('change', () => {
    lang = langSel.value || 'en';
    applyLanguage();
    const loginBtn = $('#loginLangText');
    if(loginBtn) loginBtn.innerHTML = (lang==='zh'
      ? "<span class='flag flag-cn'></span> 中文"
      : "<span class='flag flag-gb'></span> English");
  });
}

/* -------- Live clock logic -------- */
(function startClock(){
  const d=$('#liveClock .lc-date'), tm=$('#liveClock .lc-time');
  if(!d||!tm) return;
  const wk=['SUN','MON','TUE','WED','THU','FRI','SAT'];
  const pad=(n,l)=>String(n).padStart(l,'0');
  const tick=()=>{ const cd=new Date();
    d.textContent = `${cd.getFullYear()}-${pad(cd.getMonth()+1,2)}-${pad(cd.getDate(),2)} ${wk[cd.getDay()]}`;
    tm.textContent = `${pad(cd.getHours(),2)}:${pad(cd.getMinutes(),2)}:${pad(cd.getSeconds(),2)}`;
  };
  tick(); setInterval(tick,1000);
})();

/* dashboard core */
let timer=null, currentRows=[];
function pill(status){
  const cls={running:'p-run',stalled:'p-stalled',exited:'p-exited',unknown:'p-unknown',adopted:'p-run'}[status]||'p-unknown';
  const text=(i18n[lang][status]||status);
  return `<span class="pill ${cls}">${text}</span>`;
}
function fmtUptime(s){ s=Math.max(0,s|0); const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), ss=s%60; return `${h}h ${m}m ${ss}s`; }
function confirmFix(message){
  return new Promise(res=>{
    $('#cfTitle').textContent=t('says'); $('#cfMsg').textContent=message||''; const bar=$('#confirmBar'); bar.style.display='block';
    let done=false; const close=v=>{ if(done) return; done=true; bar.style.display='none'; document.removeEventListener('keydown',onKey); res(v); };
    const onKey=e=>{ if(e.key==='Escape') close(false); if(e.key==='Enter') close(true); };
    document.addEventListener('keydown',onKey); $('#cfOk').onclick=()=>close(true); $('#cfCancel').onclick=()=>close(false);
  });
}
function runCmd(action, id, name){
  const base = ($('#base')?.value || '').trim();
  if (!base){ toast('Set Base URL first.'); return; }

  (async () => {
    try{
      if (action==='START'){
        await apiPost('/api/run', { script_id:id, args:[] });
      } else if (action==='STOP'){
        await apiPost('/api/stop/' + encodeURIComponent(id));
      } else if (action==='RESTART'){
        await apiPost('/api/restart/' + encodeURIComponent(id));
      }
      toast(action+' sent for "'+name+'".');
      loadOverview();
    }catch(e){
      toast('Command failed: ' + e.message);
    }
  })();
}

function openLogs(id, name){
  const base = ($('#base')?.value || '').trim();
  const tk   = ($('#token')?.value || '').trim();

  // API mode when Base is set
  if (base){
    let wsUrl;
    try {
      const u = new URL(base);
      wsUrl = (u.protocol==='https:'?'wss://':'ws://') + u.host + '/api/logs/' + encodeURIComponent(id) + '?token=' + encodeURIComponent(tk);
    } catch {
      wsUrl = (base.startsWith('https')?'wss://':'ws://') + base.replace(/^https?:\/\//,'') + '/api/logs/' + encodeURIComponent(id) + '?token=' + encodeURIComponent(tk);
    }

    $('#logTitle').textContent = t('logs') + ' — ' + name;
    $('#logBox').textContent = '';
    $('#logDlg').showModal();

    const ws = new WebSocket(wsUrl);
    ws.onmessage = (e)=>{ const box=$('#logBox'); box.textContent += (e.data||'')+'\n'; box.scrollTop = box.scrollHeight; };
    ws.onerror   = ()=> toast('Log stream error');
    return;
  }

  // Sheets fallback
  if (window.google && window.google.script && window.google.script.run){
    toast(t('logs_na'));
    return;
  }

  toast('Set Base URL first.');
}

/* ------- Compact gauges drawing ------- */
const gauges = {
  g_total: { el: document.querySelector('#g_total'), v: 0 },
  g_run:   { el: document.querySelector('#g_run'),   v: 0 },
  g_stall: { el: document.querySelector('#g_stall'), v: 0 },
  g_exit:  { el: document.querySelector('#g_exit'),  v: 0 },
};
function drawMiniGauge(canvas, pct){
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);
  const cx = Math.floor(W/2), cy = H;
  const rOuter = Math.min(W/2-4, H-2);
  const start = Math.PI, end = Math.PI + Math.PI;
  const mid = start + (pct/100)*Math.PI;

  ctx.strokeStyle = 'rgba(53,255,255,0.25)';
  ctx.lineWidth = 2;
  ctx.beginPath(); ctx.arc(cx,cy,rOuter,start,end); ctx.stroke();

  ctx.strokeStyle = pct >= 75 ? '#FF9421' : '#35FFFF';
  ctx.lineWidth = 2.5;
  ctx.beginPath(); ctx.arc(cx,cy,rOuter,start,mid); ctx.stroke();

  const ticks = 60;
  for(let i=0;i<=ticks;i++){
    const a = start + (i/ticks)*Math.PI;
    const rr = rOuter - 10;
    const x = cx + rr*Math.cos(a), y = cy + rr*Math.sin(a);
    const active = a <= mid;
    const col =
      pct >= 75 ? (active ? '#FF9421' : 'rgba(249,114,114,0.6)')
                : (active ? 'rgba(53,255,255,1)' : 'rgba(170,212,212,0.6)');
    ctx.beginPath();
    ctx.fillStyle = col;
    ctx.arc(x,y, 1.3, 0, Math.PI*2);
    ctx.fill();
  }
}
function animateGauge(key, target){
  const g = gauges[key]; if(!g || !g.el) return;
  const canvas = g.el.querySelector('canvas');
  const label  = g.el.querySelector('.pct');
  target = Math.max(0, Math.min(100, target));
  const step = () => {
    g.v += (target - g.v) * 0.12;
    if (Math.abs(target - g.v) < 0.2) g.v = target;
    drawMiniGauge(canvas, g.v);
    label.textContent = Math.round(g.v) + '%';
    if (g.v !== target) requestAnimationFrame(step);
  };
  requestAnimationFrame(step);
}
function updateGauges(rows){
  const all = rows || [];
  const running = all.filter(x => x.status==='running' || x.status==='adopted');
  const stalled = all.filter(x => x.status==='stalled');
  const exited  = all.filter(x => x.status==='exited');
  const avg = arr => !arr.length ? 0 : arr.reduce((s,x)=>s+(+x.cpu||0),0)/arr.length;

  animateGauge('g_total', avg(all));
  animateGauge('g_run',   avg(running));
  animateGauge('g_stall', avg(stalled));
  animateGauge('g_exit',  avg(exited));
}

/* render */
function renderRows(rows){
  currentRows = rows||[];
  $('#k_total').textContent=currentRows.length;
  $('#k_run').textContent=currentRows.filter(x=>x.status==='running'||x.status==='adopted').length;
  $('#k_stalled').textContent=currentRows.filter(x=>x.status==='stalled').length;
  $('#k_exited').textContent=currentRows.filter(x=>x.status==='exited').length;

  const tb=$('#tbody'); tb.innerHTML='';
  if(currentRows.length===0){ const tr=document.createElement('tr'); tr.innerHTML=`<td colspan="7">${t('no_data')}</td>`; tb.appendChild(tr); updateGauges(currentRows); return; }

  currentRows.forEach(x=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><strong>${x.name}</strong><div class="muted">${x.path}</div></td>
      <td>${x.pid??'—'}${x.adopted?' <small class="muted">(adopted)</small>':''}</td>
      <td>${(x.cpu??0).toFixed(1)}</td>
      <td>${(x.mem??0).toFixed(1)}</td>
      <td>${fmtUptime(x.uptime||0)}</td>
      <td>${pill(x.status)}</td>
      <td>
        <button class="ok" data-start="${x.id}" data-name="${x.name}">${t('start')}</button>
        <button class="warn" data-restart="${x.id}" data-name="${x.name}">${t('restart')}</button>
        <button class="danger" data-stop="${x.id}" data-name="${x.name}">${t('stop')}</button>
        <button class="secondary" data-logs="${x.id}" data-name="${x.name}">${t('logs')}</button>
      </td>`;
    tb.appendChild(tr);
  });

  document.querySelectorAll('[data-start]').forEach(b=>b.onclick=async()=>{
    if(!(await confirmFix(t('q_start',{name:b.dataset.name})))) return;
    runCmd('START', b.dataset.start, b.dataset.name);
  });
  document.querySelectorAll('[data-restart]').forEach(b=>b.onclick=async()=>{
    if(!(await confirmFix(t('q_restart',{name:b.dataset.name})))) return;
    runCmd('RESTART', b.dataset.restart, b.dataset.name);
  });
  document.querySelectorAll('[data-stop]').forEach(b=>b.onclick=async()=>{
    if(!(await confirmFix(t('q_stop',{name:b.dataset.name})))) return;
    runCmd('STOP', b.dataset.stop, b.dataset.name);
  });
  document.querySelectorAll('[data-logs]').forEach(b=>b.onclick=()=>{
    openLogs(b.dataset.logs, b.dataset.name);
  });

  updateTableLanguage();
  updateGauges(currentRows);
}

/* Data loader */
function loadOverview(){
  if (window.google && google.script && google.script.run){
    return new Promise((resolve,reject)=>{
      google.script.run
        .withSuccessHandler(rows=>{ renderRows(rows); resolve(); })
        .withFailureHandler(err=>{ console.error(err); toast(t('refresh_fail')+(err?.message||err)); reject(err); })
        .getLiveRows();
    });
  }
  const base = ($('#base')?.value || '').trim();
  const tk   = ($('#token')?.value || '').trim();
  if (!base) { toast('Set Base URL first.'); return Promise.resolve(); }
  return fetch(base + '/api/overview', {
    headers: { 'Authorization': 'Bearer ' + tk }
  })
  .then(r => r.json())
  .then(rows => { renderRows(rows || []); })
  .catch(e=>{ console.error(e); toast(t('refresh_fail')+e.message); });
}

/* --------- Mixed-content guard --------- */
function httpsHttpGuard(){
  const base = ($('#base')?.value || '').trim();
  if (location.protocol === 'https:' && base.startsWith('http://')) {
    toast('Blocked by browser (HTTPS page → HTTP API). Open the page via http://localhost:8088 OR use a local /api proxy.');
    return false;
  }
  return true;
}

function getApi(){
  const base = ($('#base')?.value || '').trim();
  const tk   = ($('#token')?.value || '').trim();
  if(!base){ toast('Set Base URL first.'); return null; }
  if (location.protocol === 'https:' && base.startsWith('http://')){
    toast('Blocked (HTTPS→HTTP). Use http://localhost:8088 for this page or a local proxy at /api.');
    return null;
  }
  return { base, tk, h: { 'Authorization':'Bearer '+tk, 'Content-Type':'application/json' } };
}

/* ---------- UPDATED: POST with CORS-friendly fallback ---------- */
async function apiPost(path, body){
  const A = getApi(); if(!A) throw new Error('no-base');

  const build = (useQueryToken=false) => {
    const url = A.base + path + (useQueryToken ? (path.includes('?')?'&':'?') + 'token=' + encodeURIComponent(A.tk) : '');
    const headers = useQueryToken ? {} : { 'Authorization':'Bearer '+A.tk };
    const opt = { method:'POST', headers, mode:'cors', cache:'no-store' };
    if (body !== undefined){
      headers['Content-Type'] = 'application/json';
      opt.body = JSON.stringify(body);
    }
    return { url, opt };
  };

  try{
    const {url,opt} = build(false);
    const r = await fetch(url, opt);
    if(!r.ok) throw new Error((await r.text()) || r.statusText);
    return r.json().catch(()=> ({}));
  }catch(err){
    if (body === undefined){
      const {url,opt} = build(true);
      const r2 = await fetch(url, opt);
      if(!r2.ok) throw new Error((await r2.text()) || r2.statusText);
      return r2.json().catch(()=> ({}));
    }
    throw err;
  }
}

async function toggleAutoAll(on=true){
  await loadOverview();
  let ok=0, fail=0;
  for(const s of currentRows){
    try { await apiPost('/api/scripts/'+encodeURIComponent(s.id)+'/toggle', {autorestart:on}); ok++; }
    catch { fail++; }
  }
  toast(`Auto Running ${on?'enabled':'disabled'} for ${ok} script(s).` + (fail? ` ${fail} failed.` : ''));
  setTimeout(()=>loadOverview(), 400);
}

/* -------- Fallback-aware bulk actions (already present) -------- */
async function restartAll(){
  try{
    let r;
    try { r = await apiPost('/api/restart-all'); }
    catch(e){ if(String(e).includes('404')) r = await apiPost('/api/restart_all'); else throw e; }
    toast(`Restarted ${r.ok} script(s).` + (r.fail ? ` ${r.fail} failed.` : ''));
    setTimeout(()=>loadOverview(), 700);
  }catch(e){ toast('Restart-all failed: ' + e.message); }
}

async function stopAll(){
  try{
    let r;
    try { r = await apiPost('/api/stop-all'); }
    catch(e){ if(String(e).includes('404')) r = await apiPost('/api/stop_all'); else throw e; }
    toast(`Stopped ${r.ok} script(s).` + (r.fail ? ` ${r.fail} failed.` : ''));
    setTimeout(()=>loadOverview(), 700);
  }catch(e){ toast('Stop-all failed: ' + e.message); }
}

/* Controls */
$('#connect').onclick = ()=>{
  if(!httpsHttpGuard()) return;
  loadOverview().then(()=>{ setupAuto(); toast(t('connected')); }).catch(()=>{});
};
$('#refresh').onclick = ()=> loadOverview().catch(e=>toast(t('refresh_fail')+e.message));

// Auto Running (ALL). Hold Alt to DISABLE for all.
$('#adopt').title = 'Enable Auto Running for all (Alt+Click to disable)';
$('#adopt').onclick = async (e)=>{
  if(!(await confirmFix( e.altKey ? 'Disable Auto Running for ALL scripts?' : 'Enable Auto Running for ALL scripts?' ))) return;
  const A = getApi(); if(!A) return;
  try{
    await toggleAutoAll(!e.altKey);
  }catch(err){
    toast('Auto Running failed: ' + err.message);
  }
};

$('#restartAll').onclick = async ()=>{
  if(!(await confirmFix(t('q_restart_all')))) return;
  await restartAll();
};

$('#stopAll').onclick = async ()=>{
  if(!(await confirmFix(t('q_stop_all')))) return;
  await stopAll();
};

// Copy Data URL
$('#copyCurl').onclick = ()=>{
  const base = ($('#base')?.value || '').trim();
  const u = base ? (base + '/api/overview') : (location.href.split('?')[0]+'?api=live');
  navigator.clipboard.writeText(u);
  toast(t('copied'));
};

function setupAuto(){
  if(timer) clearInterval(timer);
  const ms=+$('#interval').value||0;
  if(ms>0){ timer=setInterval(()=>loadOverview().catch(()=>{}),ms); }
}
$('#interval').addEventListener('change',()=>{ setupAuto(); toast(t('auto_upd')); });

/* enable log dialog buttons */
$('#copyLog').onclick = ()=>{ navigator.clipboard.writeText($('#logBox').textContent||''); toast(t('copied')); };
$('#closeLog').onclick = ()=> $('#logDlg').close();

/* Boot */
if(localStorage.getItem(AUTH_KEY)==='1') { showApp(); }
applyLanguage(); // ensure lang applied on first load
</script>
</body>
</html>
