<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FixLine ‚Äî Combined (Login ‚Üí Dashboard)</title>

<style>
  /* Wrapper only (no styles leak into the two pages) */
  html,body{height:100%;margin:0;background:#000}
  #stage{position:fixed;inset:0}
  .full {position:fixed; inset:0; width:100%; height:100%; border:0; display:block}

  /* === Loading overlay (outer wrapper) === */
  #fxLoader{
    position:fixed; inset:0; z-index:99999;
    display:none; align-items:center; justify-content:center;
    background:#000000;
  }
  #fxLoader.on{ display:flex; }
  #fxLoader .spinner-container{ position:relative; width:200px; height:200px; animation:fx-rotate 10s linear infinite; }
  #fxLoader .orbit{
    position:absolute; top:50%; left:50%;
    width:180px; height:180px; transform:translate(-50%,-50%);
    border-radius:50%; border:2px solid rgba(255,255,255,.1);
    animation:fx-pulse 2s ease-in-out infinite;
  }
  #fxLoader .orbit:nth-child(2){ width:140px; height:140px; animation-delay:.3s; }
  #fxLoader .orbit:nth-child(3){ width:100px; height:100px; animation-delay:.6s; }
  #fxLoader .particle{ position:absolute; width:16px; height:16px; border-radius:50%; box-shadow:0 0 40px currentColor; }
  #fxLoader .particle-1{ top:0; left:50%; transform:translateX(-50%); background:pink;      animation:fx-orbit1 3s linear infinite; }
  #fxLoader .particle-2{ top:50%; right:0; transform:translateY(-50%); background:lightblue; animation:fx-orbit2 2.5s linear infinite; }
  #fxLoader .particle-3{ bottom:0; left:50%; transform:translateX(-50%); background:lightgreen; animation:fx-orbit3 3.5s linear infinite; }
  #fxLoader .particle-4{ top:50%; left:0; transform:translateY(-50%); background:orange;      animation:fx-orbit4 2.8s linear infinite; }
  #fxLoader .core{
    position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    width:40px; height:40px; background:wheat; border-radius:50%;
    box-shadow:0 0 30px rgba(255,255,255,.5), inset 0 0 20px rgba(255,255,255,.3);
    animation:fx-coreGlow 2s ease-in-out infinite alternate;
  }
  @keyframes fx-rotate{ 100%{ transform:rotate(360deg); } }
  @keyframes fx-pulse{
    0%,100%{ transform:translate(-50%,-50%) scale(1);   opacity:.3; }
    50%    { transform:translate(-50%,-50%) scale(1.1); opacity:.6; }
  }
  @keyframes fx-orbit1{
    from{ transform:translateX(-50%) rotate(0deg)   translateX(90px) rotate(0deg); }
    to  { transform:translateX(-50%) rotate(360deg) translateX(90px) rotate(-360deg); }
  }
  @keyframes fx-orbit2{
    from{ transform:translateY(-50%) rotate(0deg)   translateX(70px) rotate(0deg); }
    to  { transform:translateY(-50%) rotate(360deg) translateX(70px) rotate(-360deg); }
  }
  @keyframes fx-orbit3{
    from{ transform:translateX(-50%) rotate(0deg)   translateX(50px) rotate(0deg); }
    to  { transform:translateX(-50%) rotate(360deg) translateX(50px) rotate(-360deg); }
  }
  @keyframes fx-orbit4{
    from{ transform:translateY(-50%) rotate(0deg)   translateX(70px) rotate(0deg); }
    to  { transform:translateY(-50%) rotate(360deg) translateX(70px) rotate(-360deg); }
  }
  @keyframes fx-coreGlow{
    0%  { box-shadow:0 0 30px rgba(255,255,255,.5), inset 0 0 20px rgba(255,255,255,.3); }
    100%{ box-shadow:0 0 60px rgba(255,255,255,.8), inset 0 0 30px rgba(255,255,255,.6); }
  }
</style>
</head>
<body>
<div id="stage">
  <!-- Always show login first -->
  <iframe id="loginFrame" class="full"
    sandbox="allow-scripts allow-forms allow-same-origin"
    referrerpolicy="no-referrer" title="FixLine Login"></iframe>

  <!-- Dashboard (hidden until login ok) -->
  <iframe id="dashFrame" class="full" style="display:none"
    sandbox="allow-scripts allow-forms allow-same-origin allow-popups"
    referrerpolicy="no-referrer" title="FixLine Dashboard"></iframe>
</div>

<!-- Loading overlay (outer wrapper) -->
<div id="fxLoader" aria-hidden="true">
  <div class="spinner-container">
    <div class="orbit"></div>
    <div class="orbit"></div>
    <div class="orbit"></div>
    <div class="particle particle-1"></div>
    <div class="particle particle-2"></div>
    <div class="particle particle-3"></div>
    <div class="particle particle-4"></div>
    <div class="core"></div>
  </div>
</div>

<!-- ===== Templates hold your original pages UNCHANGED ===== -->
<template id="loginTpl">
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>FixLine ‚Äî Sign In</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#000;
      --tile:#181818;
      --accent:#ff2a2a;
      --text:#e8e8e8;
      --muted:#aaaaaa;
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Quicksand',sans-serif}
    body{ min-height:100vh;background:var(--bg); display:flex;align-items:center;justify-content:center;overflow:hidden; }
    /* grid/scan */
    section{ position:absolute;inset:0;display:flex;flex-wrap:wrap;gap:2px; justify-content:center;align-items:center;overflow:hidden; }
    section::before{
      content:""; position:absolute; inset:0;
      background:linear-gradient(to bottom,transparent 0%,rgba(255,42,42,0.12) 35%,rgba(255,42,42,0.55) 50%,rgba(255,42,42,0.12) 65%,transparent 100%);
      animation:scan 2s linear infinite;
    }
    @keyframes scan{0%{transform:translateY(-100%)}100%{transform:translateY(100%)}}
    section span{ display:block;position:relative;z-index:2; width:calc(6.25vw - 2px);height:calc(6.25vw - 2px); background:var(--tile);transition:background .18s ease; }
    section span:hover{background:var(--accent)}
    @media (max-width:900px){ section span{width:calc(10vw - 2px);height:calc(10vw - 2px)} }
    @media (max-width:600px){ section span{width:calc(20vw - 2px);height:calc(20vw - 2px)} }
    /* headline */
    .headline{ position:absolute;top:6vh;left:50%;transform:translateX(-50%); z-index:1001;pointer-events:none; }
    .reveal{ position:relative;display:flex;gap:.05em; color:#ffd9d9;letter-spacing:.12em;text-transform:uppercase; font-weight:700;font-size:clamp(1.1rem,2.6vw,1.7rem); text-shadow:0 0 22px rgba(255,42,42,.35); white-space:pre; }
    .reveal span{opacity:0;transform:scale(0);animation:rfade 2.4s forwards}
    .reveal::before,.reveal::after{ content:"";position:absolute;top:0;height:100%;width:2px;background:#fff; opacity:0;transform:scale(0); }
    .reveal::before{left:50%;animation:rleft 1.5s cubic-bezier(.7,-.6,.3,1.5) forwards}
    .reveal::after{right:50%;animation:rright 1.5s cubic-bezier(.7,-.6,.3,1.5) forwards}
    @keyframes rfade{to{opacity:1;transform:scale(1)}}
    @keyframes rleft{to{left:-6%;opacity:1;transform:scale(.9)}}
    @keyframes rright{to{right:-6%;opacity:1;transform:scale(.9)}}
    /* card */
    .signin{ position:absolute;z-index:1000;width:min(400px,92vw); background:#222;border-radius:6px;padding:40px; box-shadow:0 15px 35px rgba(0,0,0,.9); outline:1px solid rgba(255,255,255,.04); }
    .content{display:flex;flex-direction:column;gap:28px;align-items:center}
    h2{ font-size:2rem;letter-spacing:.06em;text-transform:uppercase;color:var(--accent); text-shadow:0 0 12px color-mix(in srgb, var(--accent) 50%, transparent); }
    .sub{ color:#fff; }
    .form{width:100%;display:flex;flex-direction:column;gap:22px}
    .inputBox{position:relative;width:100%}
    .inputBox input[type="text"], .inputBox input[type="password"]{
      width:100%;background:#333;color:#fff;border:0;outline:0;border-radius:6px;
      padding:24px 40px 10px 12px;font-size:1rem;font-weight:500; box-shadow:inset 0 0 0 1px rgba(255,255,255,.06);
    }
    .inputBox i{position:absolute;left:10px;top:10px;font-style:normal;color:var(--muted);transition:.35s}
    .inputBox input:focus + i,.inputBox input:valid + i{transform:translateY(-9px);font-size:.8rem;color:#fff}

    /* password eye button */
    .toggle-pass{
      position:absolute;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      border:none;
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      font-size:.95rem;
      padding:0;
    }
    .toggle-pass:hover{color:#fff}

    .links{width:100%;display:flex;justify-content:space-between;align-items:center;font-size:.95rem}
    .links a{color:#fff;text-decoration:none;opacity:.9}
    .links a#forgot{color:#ffb3b3;font-weight:600}
    .links a#forgot:hover{color:#ffd0d0;text-decoration:underline}
    .remember{display:inline-flex;align-items:center;gap:8px;color:#ddd;user-select:none}
    .remember input{accent-color:var(--accent)}
    /* voltage button */
    .form .voltage-button{align-self:center;}
    .voltage-button{ position:relative;display:inline-block;width:max-content;margin:0 auto; border-radius:9999px;overflow:hidden; }
    .voltage-button button{
      color:#fff;background:var(--accent); padding:1rem 3.2rem 1.1rem;border-radius:5rem;
      border:4px solid #ff5a5a; font-size:1.1rem;letter-spacing:.075em;line-height:1; transition:background .3s,transform .06s,filter .2s;display:block;
    }
    .voltage-button button:hover{cursor:pointer;background:#e02121}
    .voltage-button button:active{transform:translateY(1px)}
    .voltage-button svg{ display:block;position:absolute;top:-0.75em;left:-0.25em; width:calc(100% + 0.5em);height:calc(100% + 1.5em); pointer-events:none;opacity:0;transition:opacity .4s;transition-delay:.1s; }
    .voltage-button svg path{stroke-dasharray:100;filter:url('#glow')}
    .voltage-button svg .line-1{stroke:#f6de8d;stroke-dashoffset:0;animation:spark-1 3s linear infinite}
    .voltage-button svg .line-2{stroke:#6bfeff;stroke-dashoffset:500;animation:spark-2 3s linear infinite}
    .voltage-button .dots{opacity:0;transition:opacity .3s;transition-delay:.4s}
    .voltage-button .dot{width:.9rem;height:.9rem;background:#fff;border-radius:50%;position:absolute;opacity:0}
    .voltage-button .dot-1{top:0;left:20%;animation:fly-up 3s linear infinite}
    .voltage-button .dot-2{top:0;left:55%;animation:fly-up 3s linear infinite .5s}
    .voltage-button .dot-3{top:0;left:80%;animation:fly-up 3s linear infinite 1s}
    .voltage-button .dot-4{bottom:0;left:30%;animation:fly-down 3s linear infinite 2.5s}
    .voltage-button .dot-5{bottom:0;left:65%;animation:fly-down 3s linear infinite 1.5s}
    .voltage-button button:hover + svg, .voltage-button button:hover + svg + .dots{opacity:1}
    .voltage-button.play svg, .voltage-button.play .dots{opacity:1}
    @keyframes spark-1{to{stroke-dashoffset:-1000}}
    @keyframes spark-2{to{stroke-dashoffset:-500}}
    @keyframes fly-up{ 0%{opacity:0;transform:translateY(0) scale(.2)} 5%{opacity:1;transform:translateY(-1.5rem) scale(.4)} 10%,100%{opacity:0;transform:translateY(-3rem) scale(.2)} }
    @keyframes fly-down{ 0%{opacity:0;transform:translateY(0) scale(.2)} 5%{opacity:1;transform:translateY(1.5rem) scale(.4)} 10%,100%{opacity:0;transform:translateY(3rem) scale(.2)} }
    /* toasts */
    .toast{position:fixed;right:16px;bottom:16px;display:grid;gap:10px;z-index:2000}
    .notification{ min-width:22rem;border-radius:.375rem;background:var(--bgX);color:var(--fgX); box-shadow:0 1px 10px rgba(0,0,0,.5);transform:translateY(30px); opacity:0;visibility:hidden;animation:fade-in 3s linear forwards;position:relative; }
    .notification__body{display:flex;align-items:center;gap:.5rem;padding:1rem .75rem}
    .notification__progress{
      position:absolute;left:.4rem;bottom:.4rem;height:.2rem;width:calc(100% - .8rem);
      transform:scaleX(0);transform-origin:left;background:linear-gradient(to right,var(--bgX),var(--fgX));
      border-radius:inherit;animation:progress 2.5s .3s linear forwards;opacity:.9;
    }
    .notification--warning{--bgX:#512e08;--fgX:#ffa536}
    .notification--info{--bgX:#111827;--fgX:#38bdf8}
    @keyframes fade-in{5%{opacity:1;visibility:visible;transform:translateY(0)}95%{opacity:1;transform:translateY(0)}}
    @keyframes progress{to{transform:scaleX(1)}}
  </style>
</head>
<body>

  <section id="stage"></section>

  <div class="headline">
    <div class="reveal" id="revealText">Welcome To FixLine Dashboard System</div>
  </div>

  <div class="signin">
    <div class="content">
      <h2>Login üîí</h2>
      <div class="sub" id="lg_sub" style="color:#fff">Enter your Fixline credentials to continue.</div>
      <form id="loginForm" class="form" action="#" method="post">
        <div class="inputBox">
          <input id="user" type="text" name="username" required>
          <i>üë§ Username</i>
        </div>
        <div class="inputBox">
          <input id="pass" type="password" name="password" required>
          <i>üîë Password</i>
          <button type="button" id="togglePass" class="toggle-pass" aria-label="Show password">üëÅÔ∏è</button>
        </div>

        <div class="links">
          <a id="forgot" href="#">Forgot Password</a>
          <label class="remember"><input id="remember" type="checkbox"> Remember me</label>
        </div>

        <div class="voltage-button" id="vbtn">
          <button type="submit">Login</button>

          <svg viewBox="0 0 234.6 61.3" preserveAspectRatio="none" aria-hidden="true">
            <filter id="glow">
              <feGaussianBlur class="blur" result="coloredBlur" stdDeviation="2"></feGaussianBlur>
              <feTurbulence type="fractalNoise" baseFrequency="0.075" numOctaves="2" result="turbulence"></feTurbulence>
              <feDisplacementMap in="SourceGraphic" in2="turbulence" scale="30" xChannelSelector="R" yChannelSelector="G" result="displace"></feDisplacementMap>
              <feMerge>
                <feMergeNode in="coloredBlur"></feMergeNode>
                <feMergeNode in="coloredBlur"></feMergeNode>
                <feMergeNode in="coloredBlur"></feMergeNode>
                <feMergeNode in="displace"></feMergeNode>
                <feMergeNode in="SourceGraphic"></feMergeNode>
              </feMerge>
            </filter>
            <path class="voltage line-1" d="m216.3 51.2c-3.7 0-3.7-1.1-7.3-1.1-3.7 0-3.7 6.8-7.3 6.8-3.7 0-3.7-4.6-7.3-4.6-3.7 0-3.7 3.6-7.3 3.6-3.7 0-3.7-0.9-7.3-0.9-3.7 0-3.7-2.7-7.3-2.7-3.7 0-3.7 7.8-7.3 7.8-3.7 0-3.7-4.9-7.3-4.9-3.7 0-3.7-7.8-7.3-7.8-3.7 0-3.7-1.1-7.3-1.1-3.7 0-3.7 3.1-7.3 3.1-3.7 0-3.7 10.9-7.3 10.9-3.7 0-3.7-12.5-7.3-12.5-3.7 0-3.7 4.6-7.3 4.6-3.7 0-3.7 4.5-7.3 4.5-3.7 0-3.7 3.6-7.3 3.6-3.7 0-3.7-10-7.3-10-3.7 0-3.7-0.4-7.3-0.4-3.7 0-3.7 2.3-7.3 2.3-3.7 0-3.7 7.1-7.3 7.1-3.7 0-3.7-11.2-7.3-11.2-3.7 0-3.7 4.6-7.3 4.6-3.7 0-3.7 3.6-7.3 3.6-3.7 0-3.7-2.9-7.3-2.9-3.7 0-3.7 8.4-7.3 8.4-3.7 0-3.7-14.6-7.3-14.6-3.7 0-3.7 5.8-7.3 5.8-2.2 0-3.8-0.4-5.5-1.5-1.8-1.1-1.8-2.9-2.9-4.8-1-1.8 1.9-2.7 1.9-4.8 0-3.4-2.1-3.4-2.1-6.8s-9.9-3.4-9.9-6.8 8-3.4 8-6.8c0-2.2 2.1-2.4 3.1-4.2 1.1-1.8 0.2-3.9 2-5 1.8-1 3.1-7.9 5.3-7.9 3.7 0 3.7 0.9 7.3 0.9 3.7 0 3.7 6.7 7.3 6.7 3.7 0 3.7-1.8 7.3-1.8 3.7 0 3.7-0.6 7.3-0.6 3.7 0 3.7-7.8 7.3-7.8h7.3c3.7 0 3.7 4.7 7.3 4.7 3.7 0 3.7-1.1 7.3-1.1 3.7 0 3.7 11.6 7.3 11.6 3.7 0 3.7-2.6 7.3-2.6 3.7 0 3.7-12.9 7.3-12.9 3.7 0 3.7 10.9 7.3 10.9 3.7 0 3.7 1.3 7.3 1.3 3.7 0 3.7-8.7 7.3-8.7 3.7 0 3.7 11.5 7.3 11.5 3.7 0 3.7-1.4 7.3-1.4 3.7 0 3.7-2.6 7.3-2.6 3.7 0 3.7-5.8 7.3-5.8 3.7 0 3.7-1.3 7.3-1.3 3.7 0 3.7 6.6 7.3 6.6s3.7-9.3 7.3-9.3c3.7 0 3.7 0.2 7.3 0.2 3.7 0 3.7 8.5 7.3 8.5 3.7 0 3.7 0.2 7.3 0.2 3.7 0 3.7-1.5 7.3-1.5 3.7 0 3.7 1.6 7.3 1.6s3.7-5.1 7.3-5.1c2.2 0 0.6 9.6 2.4 10.7s4.1-2 5.1-0.1c1 1.8 10.3 2.2 10.3 4.3 0 3.4-10.7 3.4-10.7 6.8s1.2 3.4 1.2 6.8 1.9 3.4 1.9 6.8c0 2.2 7.2 7.7 6.2 9.5-1.1 1.8-12.3-6.5-14.1-5.5-1.7 0.9-0.1 6.2-2.2 6.2z" fill="transparent" stroke="#fff"/>
            <path class="voltage line-2" d="m216.3 52.1c-3 0-3-0.5-6-0.5s-3 3-6 3-3-2-6-2-3 1.6-6 1.6-3-0.4-6-0.4-3-1.2-6-1.2-3 3.4-6 3.4-3-2.2-6-2.2-3-3.4-6-3.4-3-0.5-6-0.5-3 1.4-6 1.4-3 4.8-6 4.8-3-5.5-6-5.5-3 2-6 2-3 2-6 2-3 1.6-6 1.6-3-4.4-6-4.4-3-0.2-6-0.2-3 1-6 1-3 3.1-6 3.1-3-4.9-6-4.9-3 1.5-6 1.5-3 1.6-6 1.6-3-1.3-6-1.3-3 3.7-6 3.7-3-6.4-6-6.4-3 2.5-6 2.5h-6c-3 0-3-0.6-6-0.6s-3-1.4-6-1.4-3 0.9-6 0.9-3 4.3-6 4.3-3-3.5-6-3.5c-2.2 0-3.4-1.3-5.2-2.3-1.8-1.1-3.6-1.5-4.6-3.3s-4.4-3.5-4.4-5.7c0-3.4 0.4-3.4 0.4-6.8s2.9-3.4 2.9-6.8-0.8-3.4-0.8-6.8c0-2.2 0.3-4.2 1.3-5.9 1.1-1.8 0.8-6.2 2.6-7.3 1.8-1 5.5-2 7.7-2 3 0 3 2 6 2s3-0.5 6-0.5 3 5.1 6 5.1 3-1.1 6-1.1 3-5.6 6-5.6 3 4.8 6 4.8 3 0.6 6 0.6 3-3.8 6-3.8 3 5.1 6 5.1 3-0.6 6-0.6 3-1.2 6-1.2 3-2.6 6-2.6 3-0.6 6-0.6 3 2.9 6 2.9 3-4.1 6-4.1 3 0.1 6 0.1 3 3.7 6 3.7 3 0.1 6 0.1 3-0.6 6-0.6 3 0.7 6 0.7 3-2.2 6-2.2 3 4.4 6 4.4 3-1.7 6-1.7 3-4 6-4 3 4.7 6 4.7 3-0.5 6-0.5 3-0.8 6-0.8 3-3.8 6-3.8 3 6.3 6 6.3 3-4.8 6-4.8 3 1.9 6 1.9 3-1.9 6-1.9 3 1.3 6 1.3c2.2 0 5-0.5 6.7 0.5 1.8 1.1 2.4 4 3.5 5.8 1 1.8 0.3 3.7 0.3 5.9 0 3.4 3.4 3.4 3.4 6.8s-3.3 3.4-3.3 6.8 4 3.4 4 6.8c0 2.2-6 2.7-7 4.4-1.1 1.8 1.1 6.7-0.7 7.7-1.6 0.8-4.7-1.1-6.8-1.1z" fill="transparent" stroke="#fff"/>
          </svg>

          <div class="dots" aria-hidden="true">
            <div class="dot dot-1"></div><div class="dot dot-2"></div><div class="dot dot-3"></div>
            <div class="dot dot-4"></div><div class="dot dot-5"></div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const stage = document.getElementById('stage');
    function fillTiles(){const need=600;if(stage.children.length<need){const f=document.createDocumentFragment();for(let i=stage.children.length;i<need;i++)f.appendChild(document.createElement('span'));stage.appendChild(f)}}
    fillTiles();addEventListener('resize',fillTiles);

    (function(){
      const el=document.getElementById('revealText');
      const letters=el.textContent.split(''); el.textContent='';
      const middle=letters.filter(c=>c!==' ').length/2;
      let count=-1;
      letters.forEach(ch=>{
        const s=document.createElement('span');
        s.textContent=ch;
        if(ch!==' ') count++;
        const idx = (ch===' ')? middle : Math.abs(count - middle);
        s.style.animationDelay = (0.3 + idx*0.1) + 's';
        el.appendChild(s);
      });
    })();

    function toast(type,text){
      const wrap=document.getElementById('toast');
      const n=document.createElement('div');
      const map={warning:'notification--warning',info:'notification--info',success:'notification--info',failure:'notification--warning'};
      n.className=`notification ${map[type]||'notification--info'}`;
      n.innerHTML=`<div class="notification__body">${text}</div><div class="notification__progress"></div>`;
      wrap.appendChild(n); setTimeout(()=>n.remove(),3200);
    }
    document.getElementById('forgot').addEventListener('click',e=>{
      e.preventDefault();
      toast('info','‚ú® Contact to <b>BA Support</b> for password help.');
    });

    document.querySelectorAll('.voltage-button').forEach(wrap=>{
      const btn=wrap.querySelector('button');
      btn.addEventListener('click',()=>{wrap.classList.add('play');setTimeout(()=>wrap.classList.remove('play'),900)});
    });

    // Password eye toggle
    (function(){
      const pass = document.getElementById('pass');
      const btn  = document.getElementById('togglePass');
      if(!pass || !btn) return;
      btn.addEventListener('click', ()=>{
        const isPw = pass.type === 'password';
        pass.type  = isPw ? 'text' : 'password';
        btn.textContent = isPw ? 'üôà' : 'üëÅÔ∏è';
      });
    })();

    // Original in-frame submit (parent wrapper will override with capture)
    document.getElementById('loginForm').addEventListener('submit',e=>{
      e.preventDefault();
      const wrap=document.getElementById('vbtn');
      wrap.classList.add('play'); setTimeout(()=>wrap.classList.remove('play'),900);

      const u=document.getElementById('user').value.trim();
      const p=document.getElementById('pass').value;
      if(u==='admin' && p==='Fixline@123'){
        location.href='index.html';
      }else{
        toast('warning','Invalid username or password. ‚ö†Ô∏è');
      }
    });
  </script>
</body>
</html>
</template>

<template id="dashTpl">
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FixLine ‚Äî Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

<style>
/* ===== Global look (PotatoNAS base) ===== */
html { overflow:auto; }
*{ margin:0; padding:0; font-size:16px; font-family:sans-serif; box-sizing:border-box; scrollbar-width:thin; scrollbar-color:#aa4755 #5c5c5c; scrollbar-gutter:stable; }
*::-webkit-scrollbar{ width:6px } *::-webkit-scrollbar-track{ background:#5c5c5c } *::-webkit-scrollbar-thumb{ background:#aa4755; border-radius:12px }

/* Full-screen layout when Settings is opened as its own page */
#settingsPanel.fullscreen{
  margin:0 -1em;                 /* eat the .content padding so it touches edges */
  border-radius:0;
  border-left:0;
  border-right:0;
  padding:24px 24px 32px;
  min-height:calc(100vh - 4em - 2em); /* full height minus header + footer */
}

/* Full-screen layout when Settings is opened as its own page */
#settingsPanel.fullscreen{
  margin:0 -1em;
  border-radius:0;
  border-left:0;
  border-right:0;
  padding:24px 24px 32px;
  min-height:calc(100vh - 4em - 2em);
}

/* Full-screen layout when FILES page is opened */
#filesPanel.fullscreen{
  margin:0 -1em;
  border-radius:0;
  border-left:0;
  border-right:0;
  padding:24px 24px 32px;
  min-height:calc(100vh - 4em - 2em);
}

/* Full-screen layout when MONITOR page is opened */
#monitorPanel.fullscreen{
  margin:0 -1em;
  border-radius:0;
  border-left:0;
  border-right:0;
  padding:24px 24px 32px;
  min-height:calc(100vh - 4em - 2em);
}

/* ===== Settings layout (clean two-column) ===== */
.settings-layout{
  display:flex;
  flex-wrap:wrap;
  gap:18px;
}

.settings-footer{
  display:flex;
  justify-content:flex-end;
  margin-top:12px;
}

.set-section{
  flex:1 1 260px;
  padding:12px 14px 14px;
  border-radius:10px;
  background:rgba(0,0,0,.45);
  border:1px solid #2e2e2e;
}

.set-section h4{
  margin-bottom:8px;
  font-size:1rem;
  color:#f1f5f9;
}

.set-field{
  width:100%;
  margin-bottom:10px;
}

.set-label{
  display:block;
  font-size:.85rem;
  margin-bottom:4px;
  opacity:.9;
}

.set-control{
  width:100%;
  background:#141414;
  color:#e8e8e8;
  border:1px solid #3b3b3b;
  border-radius:8px;
  padding:8px 10px;
}

.set-note{
  font-size:.8rem;
  opacity:.75;
}

/* ===== Files layout / editor ===== */
.files-layout{
  align-items:flex-start;
}

.files-table-wrap{
  margin-top:6px;
  max-height:320px;
  overflow:auto;
}

.files-upload-row{
  display:flex;
  align-items:center;
  flex-wrap:wrap;
  gap:8px;
}

#filesTable td .file-path{
  font-size:.75rem;
  opacity:.7;
}

.code-editor{
  width:100%;
  /* make the editor much taller by default */
  min-height:520px;
  /* let it grow inside the flex column (Editor section) */
  flex:1 1 auto;

  background:#050608;
  color:#e5e7eb;
  border-radius:8px;
  border:1px solid #27272f;
  font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,"Liberation Mono","Courier New",monospace;
  font-size:.85rem;
  padding:10px 12px;
  resize:vertical;
  line-height:1.4;
  box-shadow:inset 0 0 0 1px rgba(0,0,0,.45);
}

body.fx-light .code-editor{
  background:#f9fafb;
  color:#111827;
  border-color:#d1d5db;
  box-shadow:none;
}

/* === Theme switch on header === */
.theme-switch{
  display:flex;
  align-items:center;
  justify-content:center;
  margin-left:.75rem;
}

.theme-checkbox{
  opacity:0;
  position:absolute;
  pointer-events:none;
}

.theme-label{
  display:flex;
  align-items:center;
  justify-content:space-between;
  position:relative;
  width:60px;
  height:28px;
  padding:4px 6px;
  border-radius:999px;
  cursor:pointer;
  box-shadow:0 0 0 1px rgba(0,0,0,.55), 0 0 10px rgba(0,0,0,.4) inset;
  background:#111827;
  color:#facc6b;
  transition:all .3s cubic-bezier(0.76,0,0.24,1);
}

.theme-label .moon,
.theme-label .sun{
  transform-origin:center center;
  transition:transform .5s cubic-bezier(0.76,0,0.24,1);
}

.theme-label:hover .moon,
.theme-label:hover .sun{
  transform:rotate(360deg);
}

.theme-ball{
  position:absolute;
  top:3px;
  left:3px;
  width:22px;
  height:22px;
  border-radius:50%;
  background:#facc6b;
  transition:all .3s cubic-bezier(0.76,0,0.24,1);
}

/* Ball position for light mode */
body.fx-light .theme-ball{
  transform:translateX(30px);
}

/* Light look for the switch itself */
body.fx-light .theme-label{
  background:#e5e7eb;
  color:#f97316;
  box-shadow:0 0 0 1px rgba(148,163,184,.7), 0 0 10px rgba(148,163,184,.5) inset;
}

/* === Light theme (applies when body has .fx-light) === */
body.fx-light{
  background-image:none;
  background-color:#f3f4f6;
  color:#111827;
}

body.fx-light .header{
  background:#f9fafb;
  border-bottom:2px solid #e5e7eb;
  filter:drop-shadow(0 0 .5rem rgba(0,0,0,.25));
}

body.fx-light #clock .date,
body.fx-light #clock .time,
body.fx-light #welcomeUser{
  color:#111827;
}

body.fx-light .fx-card{
  background:#ffffff;
  border-color:#e5e7eb;
  color:#111827;
}

body.fx-light .fx-kpi{
  background:#f9fafb;
  border-color:#e5e7eb;
}

body.fx-light table.fx-table th{
  background:#e5e7eb;
  color:#111827;
}
body.fx-light table.fx-table td{
  border-bottom:1px solid #e5e7eb;
  color:#111827;
}

body.fx-light footer{
  background:#f9fafb;
  color:#6b7280;
}

body.fx-light .sideNav,
body.fx-light #cog,
body.fx-light .powerMenu{
  color:#111827;
}

body.fx-light .lang-toggle{
  background:#e5e7eb;
  color:#111827;
  border-color:#d1d5db;
}

/* compact table density option */
body.fx-compact-table table.fx-table th,
body.fx-compact-table table.fx-table td{
  padding:6px 6px;
}

body{
  position:relative;
  background-image:url("https://cdn.wallpapersafari.com/18/37/3DnTgd.jpg");
  background-size:cover; background-position:center; color:#e8e8e8;
}

.header{
  position:sticky; top:0; z-index:5;
  filter: drop-shadow(0 0 .5rem crimson);
  width:100vw; height:4em; background:#1f1f1f; display:flex; align-items:center; gap:.75rem; padding:0 1rem;
  border-bottom:2px solid #7a0f1f;
}
.sideNav{ border:none; background:transparent; color:#fff; font-size:16px; cursor:pointer; transition:.25s }
.sideNav i{ font-size:1.4rem }
.sideNav:hover{ color:#bbb }

.fx-logo{ display:flex; align-items:center; gap:.5rem; margin:0 auto 0 .5rem; }
.fx-logo .badge{
  width:28px;height:28px;border-radius:50%;display:grid;place-items:center;background:#0f172a;border:1px solid #39e0ff;color:#39e0ff;
  position:relative; box-shadow:0 0 18px rgba(57,224,255,.35);
}
.fx-logo .badge::after{
  content:""; position:absolute; inset:-6px; border-radius:50%; border:2px solid rgba(57,224,255,.25);
  animation:spinPulse 3s linear infinite;
}
@keyframes spinPulse{ 0%{ transform:scale(1) rotate(0) } 50%{ transform:scale(1.06) rotate(180deg) } 100%{ transform:scale(1) rotate(360deg) } }

/* === Animated FixLine logo (Python-like) === */
.fx-logo .badge svg{
  width:22px;
  height:22px;
  display:block;
}

#python-logo path{
  fill:transparent;
  stroke-width:5px;
  transition:transform .2s ease-in-out, filter .2s ease-in-out;
}

#python-logo path:first-child{
  stroke:#3670A0;
  animation:border-move 2s linear forwards, fill-first 1s 2s linear forwards;
}

#python-logo path:last-child{
  stroke:#FED140;
  animation:border-move 2s linear forwards, fill-second 1s 2s linear forwards;
}

#python-logo:hover path:first-child{
  transform:translate(-2%, -2%);
  filter:drop-shadow(0 0 10px #3670A0);
}
#python-logo:hover path:last-child{
  transform:translate(2%, 2%);
  filter:drop-shadow(0 0 10px #FED140);
}

@keyframes border-move{
  0%   { stroke-dasharray:0 1600; }
  100% { stroke-dasharray:1600 1600; }
}
@keyframes fill-first{
  0%   { fill:transparent; }
  100% { fill:#3670A0; }
}
@keyframes fill-second{
  0%   { fill:transparent; }
  100% { fill:#FED140; }
}

/* === TYPING ANIMATION ‚Äî NO CURSOR === */
.fx-logo h1{ 
  font-size:1.9rem; font-weight:800; letter-spacing:.04em; text-shadow:0 0 10px rgba(255,255,255,.15);
  white-space: nowrap; overflow: hidden; width: 0; animation: typing 2.5s steps(7) forwards;
}
@keyframes typing { from { width: 0; } to { width: 7ch; } }

#clock{ margin-left:auto; text-align:right; line-height:1; padding-right:.5rem }
#clock .date{ font-size:.78rem; opacity:.85 }
#clock .time{ font-size:1.05rem; font-weight:700 }

#welcomeUser{
  font-size:.85rem;
  font-weight:700;
  color:#facc6b;              /* nice gold-ish text */
  text-align:right;
  margin-bottom:2px;
  text-shadow:0 0 6px rgba(0,0,0,.7);
}

/* Language dropdown with flags */
.lang-dd{ position:relative; margin-left:.5rem }
.lang-toggle{
  display:flex; align-items:center; gap:.45rem;
  background:#2a2a2a; color:#ddd; border:1px solid #3b3b3b;
  border-radius:999px; padding:.25rem .6rem; font-size:.85rem; cursor:pointer;
}
.lang-menu{
  position:absolute; right:0; top:calc(100% + 6px);
  background:#1f1f1f; border:1px solid #3b3b3b; border-radius:10px;
  padding:6px; min-width:150px; display:none; box-shadow:0 8px 24px #0008; z-index:30;
}
.lang-dd.open .lang-menu{ display:block }
.lang-item{
  width:100%; display:flex; align-items:center; gap:.55rem;
  background:transparent; color:#ddd; border:0; cursor:pointer;
  padding:.5rem .6rem; border-radius:8px; text-align:left;
}
.lang-item:hover{ background:#2a2a2a }
.lang-item.active{ background:#7a0f1f; color:#fff; border:1px solid #962a2a }

#cog, .powerMenu{ background:transparent; border:none; color:#fff; cursor:pointer; transition:.25s; padding:.35rem .5rem }
#cog:hover, .powerMenu:hover{ color:#962a2a }
#cog i, .powerMenu i{ font-size:1.2rem }

/* Side panel */
#sideNav{ display:none; background:#1f1f1f; width:18em; height:100%; position:fixed; top:0; left:0; z-index:10 }
#sideNav ul{ list-style:none; text-align:center; text-transform:uppercase; font-weight:bold; width:100% }
#sideNav ul li:hover:not(.nasName, .nasURL){ background:#5e5e5e }
#sideNav ul li a:not(.nasURL){ text-decoration:none; color:white; font-size:1.35em; border:1px solid #3b3b3b; display:inline-block; width:100%; padding:.6em 0 }
.nasName{ color:#fff; padding:1em 0; font-size:1.2rem }
.nasURL{ color:#fff; text-decoration:none; transition:.25s } .nasURL:hover{ color:crimson }

/* Power & options menus */
#powerMenu{ position:fixed; right:.5em; top:4em; background:#1f1f1f; display:none; z-index:20 }
#powerMenu ul{ list-style:none } #powerMenu ul li button{ width:100%; border:1px solid #3b3b3b; background:transparent; color:#fff; padding:.5em 1.5em; font-size:1.1em; cursor:pointer; text-transform:uppercase; font-weight:bold }
#powerMenu ul li button:hover{ background:#962a2a }
#options{ display:none; width:12em; background:#1f1f1f; position:absolute; top:4em; right:4em; z-index:20 }
#options ul{ list-style:none; text-align:center } #options ul li a{ display:inline-block; width:100%; font-size:1em; text-decoration:none; color:white; border:1px solid #3b3b3b; padding:1em; transition:.25s }
#options ul li a:hover{ background:#404040 }

/* Content + cards */
.content{ position:relative; z-index:1; min-height:calc(100vh - 4em - 2em); padding:1em }
.fx-card{
  background: rgba(0,0,0,.5); border:1px solid #3b3b3b; border-radius:12px; padding:12px; margin:12px 0; color:#e8e8e8; backdrop-filter: blur(2px);
}
.fx-card h3{ margin-bottom:8px; font-size:1.1rem; color:#fff; }
.fx-row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
.fx-row input,.fx-row select{ background:#141414; color:#e8e8e8; border:1px solid #3b3b3b; border-radius:8px; padding:8px 10px; min-width:260px }

/* small filter box */
#filter{ min-width:220px }

/* Buttons */
.fx-btn{ border:0; border-radius:10px; padding:10px 14px; font-weight:800; cursor:pointer; color:#fff; position:relative; overflow:hidden; transform:translateZ(0); }
.fx-btn.secondary{ background:#3b3b3b }
.fx-btn.ok{ background:#38761d }
.fx-btn.warn{ background:#ee7a00 }
.fx-btn.danger{ background:#cc0000 }
.fx-btn.ghost{ background:transparent; color:#cbd5e1; border:1px solid #3b3b3b }

/* shimmer sweep (existing) */
.fx-btn::after{
  content:"";
  position:absolute; top:0; left:-120%;
  width:120%; height:100%;
  background:linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent);
  transform:skewX(-18deg);
  transition:.45s ease;
}
.fx-btn:hover::after{ left:120% }

/* Lift + expanding halo & entrance animation (matches sample) */
.fx-btn{ transition: transform .2s ease, box-shadow .2s ease; }
.fx-btn::before{
  content:""; position:absolute; inset:0; border-radius:inherit;
  background:rgba(255,255,255,.22); transform:scale(0.98); opacity:0;
  transition:transform .4s ease, opacity .4s ease; z-index:0;
}
.fx-btn > * { position:relative; z-index:1; }
.fx-btn:hover{ transform:translateY(-3px); box-shadow:0 10px 20px rgba(0,0,0,0.2); }
.fx-btn:active{ transform:translateY(-1px); box-shadow:0 5px 10px rgba(0,0,0,0.2); }
.fx-btn:hover::before{ transform:scale(1.15); opacity:0; }

.btn-animated{ animation:moveInBottom .6s ease-out; animation-fill-mode:backwards; }
@keyframes moveInBottom{
  0%{ opacity:0; transform:translateY(30px); }
  100%{ opacity:1; transform:translateY(0); }
}

/* Specific button color overrides */
#adopt.fx-btn{   background:#f1c232 }
#connect.fx-btn{ background:#1155cc }

/* KPIs + table */
.fx-kpis{ display:flex; gap:10px; flex-wrap:wrap }
.fx-kpi{ flex:1; min-width:160px; background:#141414; border:1px dashed #3b3b3b; border-radius:10px; padding:10px }
.fx-kpi small{ color:#bfbfbf; display:block }
.fx-actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }

table.fx-table{ width:100%; border-collapse:collapse }
table.fx-table th, table.fx-table td{ padding:10px; border-bottom:1px solid #3b3b3b; color:#e8e8e8; font-size:14px }
table.fx-table th{ background:#1f1f1f; text-align:left }
#tbl td:last-child{ white-space:nowrap }

/* sortable headers */
th.sortable{ cursor:pointer; position:relative; user-select:none }
th.sortable::after{
  content:"";
  position:absolute; right:8px; top:50%; transform:translateY(-50%);
  opacity:.45; font-size:.8rem;
}
th.sortable.asc::after{ content:"‚ñ≤" }
th.sortable.desc::after{ content:"‚ñº" }

/* light bars behind CPU & RAM values */
td.pct{ position:relative; }
td.pct::before{
  content:""; position:absolute; inset:0 0 0 0; width:var(--w,0%); height:100%;
  background:linear-gradient(90deg, #ff2a2a, transparent); opacity:.18; pointer-events:none;
}
td.pct > span{ position:relative }

/* status pills */
.pill{display:inline-block;padding:.2rem .5rem;border-radius:999px;font-size:.78rem;font-weight:700}
.p-run{background:#0b4;color:#eaff}
.p-stalled{background:#512e08;color:#ffa536}
.p-exited{background:#4d0f16;color:#ff8899}
.p-unknown{background:#333;color:#ddd}

/* Footer */
footer{ width:100%; height:2em; background:black; display:flex; justify-content:center; align-items:center; position:sticky; bottom:0; color:gray }

/* Flags */
.flag{width:20px;height:14px;display:inline-block;border-radius:2px;box-shadow:0 0 0 1px #0005 inset;background-size:cover;background-repeat:no-repeat}
.flag-gb{background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 60 40'><rect width='60' height='40' fill='%23012169'/><path d='M0 0 L60 40 M60 0 L0 40' stroke='%23ffffff' stroke-width='8'/><path d='M0 0 L60 40 M60 0 L0 40' stroke='%23c8102e' stroke-width='4'/><path d='M30 0 v40 M0 20 h60' stroke='%23ffffff' stroke-width='10'/><path d='M30 0 v40 M0 20 h60' stroke='%23c8102e' stroke-width='6'/></svg>");}
.flag-cn{background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 60 40'><rect width='60' height='40' fill='%23DE2910'/><polygon fill='%23FFDE00' points='12,4 13.8,9.5 20,9.5 15,12.5 17,18 12,14.5 7,18 9,12.5 4,9.5 10.2,9.5'/><circle cx='22' cy='7' r='1.6' fill='%23FFDE00'/><circle cx='25' cy='10' r='1.6' fill='%23FFDE00'/><circle cx='25' cy='14' r='1.6' fill='%23FFDE00'/><circle cx='22' cy='17' r='1.6' fill='%23FFDE00'/></svg>");}

/* ======= TOASTS ======= */
.toast{ position:fixed; right:16px; bottom:16px; display:grid; gap:10px; z-index:2000 }
.notification{
  --bg:#313e2c; --primary:#aaec8a;
  min-width:22rem; margin-left:auto; margin-right:auto;
  border-radius:.375rem; background:var(--bg); color:var(--primary);
  box-shadow:0 1px 10px rgba(0,0,0,.6);
  transform:translateY(30px); opacity:0; visibility:hidden;
  animation:dash-fade-in 3s linear forwards; position:relative;
}
.notification__body{ display:flex; align-items:center; gap:.5rem; padding:1rem .75rem }
.notification__progress{
  position:absolute; left:.4rem; bottom:.4rem; height:.2rem; width:calc(100% - .8rem);
  transform:scaleX(0); transform-origin:left;
  background:linear-gradient(to right, var(--bg), var(--primary));
  border-radius:inherit; animation:dash-progress 2.5s .3s linear forwards; opacity:.9;
}
.notification--success{ --bg:#313e2c; --primary:#aaec8a }
.notification--failure{ --bg:#371818; --primary:#ff4d4d }
.notification--warning{ --bg:#512e08; --primary:#ffa536 }
.notification--info   { --bg:#1a1a2e; --primary:#8b8bda }
@keyframes dash-fade-in{5%{opacity:1;visibility:visible;transform:translateY(0)}95%{opacity:1;transform:translateY(0)}}
@keyframes dash-progress{ to{transform:scaleX(1)} }

/* ======= CONFIRM MODAL (top drop) ======= */
#fxConfirm{
  position:fixed; inset:0; z-index:4000;
  display:none; align-items:flex-start; justify-content:center;
  padding-top:calc(4em + 16px);
  background:rgba(0,0,0,.35); backdrop-filter:blur(1.5px);
}
#fxConfirm.on{ display:flex; }
#fxConfirm .panel{
  width:min(440px,92vw);
  background:linear-gradient(180deg,#0e0e10 0%, #141418 55%, #1a1a1f 100%) !important;
  color:#e7eaf0; border:1px solid #2a2a2f; border-radius:14px;
  box-shadow:0 28px 80px rgba(0,0,0,.65), inset 0 0 0 1px rgba(255,255,255,.03);
  overflow:hidden; animation:fx-drop .28s ease-out both;
}
#fxConfirm .hd{ padding:12px 16px; font-weight:800; letter-spacing:.02em; background:linear-gradient(180deg,#101014 0%, #15151a 100%) !important; border-bottom:1px solid #2a2a2f; }
#fxConfirm .msg{ padding:16px; font-size:1.05rem }
#fxConfirm .bar{ padding:12px 14px; display:flex; gap:10px; justify-content:flex-end; background:rgba(20,20,24,.65); border-top:1px solid #2a2a2f; }
.fxbtn{ border:0; padding:.6rem 1.1rem; border-radius:10px; font-weight:800; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,.35); transition:transform .1s ease, box-shadow .2s ease; }
.fxbtn.ok{ background:#0ba97b; color:#fff }
.fxbtn.cancel{ background:#2b2b35; color:#e5e8f0 }
.fxbtn:hover{ transform:translateY(-2px); box-shadow:0 10px 22px rgba(0,0,0,.45) }
.fxbtn:active{ transform:translateY(0) }
@keyframes fx-drop{ from{ transform:translateY(-20px); opacity:0 } to{ transform:translateY(0); opacity:1 } }

/* ======= In-dashboard loading overlay (for fetch) ======= */
#loading{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); backdrop-filter:blur(1px); z-index:3500; }
#loading.on{ display:flex; }
#loading .ring{ width:64px; height:64px; border:6px solid #fff; border-color:#fff transparent #fff transparent; border-radius:50%; animation:ring 1.2s linear infinite; }
@keyframes ring{ to{ transform:rotate(360deg) } }
</style>
</head>
<body>

<div class="header">
  <button class="sideNav" onclick="sideNav()"><i class="fa-solid fa-bars"></i></button>

<div class="fx-logo">
  <div class="badge">
    <svg
      id="python-logo"
      viewBox="0 0 512 512"
      aria-hidden="true"
    >
      <path
        d="m116 296c0-30.328125 24.671875-55 55-55h170c13.785156 0 25-11.214844 25-25v-141c0-41.355469-33.644531-75-75-75h-70c-41.355469 0-75 33.644531-75 75v41h110c8.285156 0 15 6.714844 15 15s-6.714844 15-15 15h-181c-41.355469 0-75 33.644531-75 75v70c0 41.355469 33.644531 75 75 75h41zm105-220c-8.285156 0-15-6.714844-15-15s6.714844-15 15-15 15 6.714844 15 15-6.714844 15-15 15zm0 0" />
      <path
        d="m437 146h-41v70c0 30.328125-24.671875 55-55 55h-170c-13.785156 0-25 11.214844-25 25v141c0 41.355469 33.644531 75 75 75h70c41.355469 0 75-33.644531 75-75v-41h-110c-8.285156 0-15-6.714844-15-15s6.714844-15 15-15h181c41.355469 0 75-33.644531 75-75v-70c0-41.355469-33.644531-75-75-75zm-146 290c8.285156 0 15 6.714844 15 15s-6.714844 15-15 15-15-6.714844-15-15 6.714844-15 15-15zm0 0" />
    </svg>
  </div>
  <h1>FixLine</h1>
</div>

<div id="clock">
  <div id="welcomeUser" class="welcome-user"></div>
  <div class="date">‚Äî</div>
  <div class="time">‚Äî</div>
  <div id="i_livetime_label" style="font-size:.65rem;opacity:.7">Live time</div>
</div>

<!-- Light / Dark theme switch -->
<div class="theme-switch" title="Toggle light / dark">
  <input type="checkbox" class="theme-checkbox" id="themeToggle" />
  <label for="themeToggle" class="theme-label">
    <svg class="moon" width="20" height="20" viewBox="0 0 24 24" fill="none"
         xmlns="http://www.w3.org/2000/svg">
      <path d="M3 11.5066C3 16.7497 7.25034 21 12.4934 21C16.2209 21 19.4466 18.8518 21 15.7259C12.4934 15.7259 8.27411 11.5066 8.27411 3C5.14821 4.55344 3 7.77915 3 11.5066Z"
            stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <svg class="sun" width="20" height="20" viewBox="0 0 24 24" fill="none"
         xmlns="http://www.w3.org/2000/svg">
      <path d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
            stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <div class="theme-ball"></div>
  </label>
</div>

<div id="lang" class="lang-dd">
    <button id="langToggle" class="lang-toggle" aria-haspopup="true" aria-expanded="false">
      <span id="langFlag" class="flag flag-gb" aria-hidden="true"></span>
      <span id="langLabel">English</span>
      <i class="fa-solid fa-caret-down" style="margin-left:.25rem"></i>
    </button>
    <div class="lang-menu">
      <button class="lang-item" data-lang="en">
        <span class="flag flag-gb" aria-hidden="true"></span><span>English</span>
      </button>
      <button class="lang-item" data-lang="zh">
        <span class="flag flag-cn" aria-hidden="true"></span><span>chinese</span>
      </button>
    </div>
  </div>

  <button id="cog" onclick="options()"><i class="fa-solid fa-gear"></i></button>
  <button class="powerMenu" onclick="powerMenu()"><i class="fa-solid fa-power-off"></i></button>
</div>

<div id="sideNav">
  <ul>
    <li class="nasName">FixLine
      <p style="font-size:.6em;"><a href="#" class="nasURL">server.Monitor.com</a></p>
    </li>
    <li><a href="#" id="navOverview">OVERVIEW</a></li>
    <li><a href="#" id="navFiles">FILES</a></li>
    <li><a href="#" id="navSetting">SETTING</a></li>
    <li><a href="#" id="navMonitor">Monitor</a></li>
    <li><a href="#" id="navNotif">NOTIFICATION</a></li>
  </ul>
</div>

<div id="powerMenu">
  <ul>
    <li><button onclick="logout()"><i class="fa-solid fa-arrow-right-from-bracket"></i>&nbsp;Logout</button></li>
  </ul>
</div>

<div id="options">
  <ul>
    <li><a href="#" id="topChangePass"><i class="fa-solid fa-unlock"></i> Change Password</a></li>
  </ul>
</div>

<div class="content">
  <!-- ===== NEW OVERVIEW DASHBOARD (default when opening FixLine) ===== -->
  <div id="overviewPanel" class="fx-card">
    <div style="display:flex;flex-wrap:wrap;gap:18px;align-items:stretch;">
      <!-- Left: intro + shortcuts -->
      <div style="flex:1.7 1 260px;min-width:260px;">
        <h2 id="i_overview_title" style="margin-bottom:6px;">FixLine Overview</h2>
        <p id="i_overview_sub" style="opacity:.85;margin-bottom:10px;">
          Summary of your scripts and quick shortcuts.
        </p>

        <p id="i_overview_intro"
           style="font-size:.9rem;opacity:.9;margin-bottom:8px;">
          Use this page as a quick overview. For full control go to the Monitor page.
        </p>

        <ul style="font-size:.85rem;opacity:.9;margin-left:1rem;list-style:disc;">
          <li id="i_overview_tip1">Monitor and control automation scripts in real time.</li>
          <li id="i_overview_tip2">Open Monitor to start / stop scripts and view logs.</li>
          <li id="i_overview_tip3">Use the Files page to upload and edit scripts on the agent.</li>
        </ul>

        <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap;">
          <button class="fx-btn ok btn-animated" id="btnGoMonitor" type="button">
            <i class="fa-solid fa-display" style="margin-right:.35rem;"></i>
            <span id="i_overview_go_monitor">Open Monitor</span>
          </button>
          <button class="fx-btn secondary btn-animated" id="btnGoFiles" type="button">
            <i class="fa-solid fa-file-code" style="margin-right:.35rem;"></i>
            <span id="i_overview_go_files">Script files</span>
          </button>
          <button class="fx-btn secondary btn-animated" id="btnGoSettings" type="button">
            <i class="fa-solid fa-gear" style="margin-right:.35rem;"></i>
            <span id="i_overview_go_settings">Settings</span>
          </button>
        </div>
      </div>

      <!-- Right: high-level stats (mirror of Monitor counters) -->
      <div style="flex:1.2 1 240px;min-width:220px;">
        <div class="fx-kpis">
          <div class="fx-kpi">
            <small id="i_k_total_ov">Total Scripts</small>
            <strong id="ov_total">‚Äî</strong>
          </div>
          <div class="fx-kpi">
            <small id="i_k_running_ov">Running</small>
            <strong id="ov_run">‚Äî</strong>
          </div>
          <div class="fx-kpi">
            <small id="i_k_stalled_ov">Stalled</small>
            <strong id="ov_stalled">‚Äî</strong>
          </div>
          <div class="fx-kpi">
            <small id="i_k_exited_ov">Exited</small>
            <strong id="ov_exited">‚Äî</strong>
          </div>
        </div>
        <p id="i_overview_stats_hint"
           style="font-size:.78rem;opacity:.75;margin-top:8px;">
          Stats are updated when you connect to an agent on the Monitor page.
        </p>
      </div>
    </div>
  </div>

  <!-- === MONITOR PANEL (OLD MAIN DASHBOARD MOVED HERE) === -->
  <div id="monitorPanel" class="fx-card" style="display:none; margin-top:10px;">
    <h3 id="i_monitor_title" style="margin-bottom:6px;">Monitor</h3>
    <p id="i_monitor_sub" style="margin-bottom:12px; opacity:.85;">
      Detailed view for script status, actions and live CMD / logs.
    </p>

    <!-- The original main dashboard is now inside MONITOR -->
    <h2 id="i_title" style="margin-bottom:6px;">Welcome to Fixline Dashboard</h2>
    <p id="i_sub" style="margin-bottom:12px; opacity:.85;">
      Real-time Managing Automation Scripts System.
    </p>

    <div class="fx-card">
      <h3 id="i_agent">Agent Connection</h3>
      <div class="fx-row" style="margin-bottom:8px;">
        <input id="base" placeholder="API Base URL (e.g. https://win-xxxx.ts.net)" style="min-width:320px;">
        <input id="token" placeholder="Token (Bearer or ?token=)" style="min-width:260px;">
        <select id="interval">
          <option value="0">Auto-refresh: Off</option>
          <option value="1000">Auto-refresh: 1s</option>
          <option value="2000">Auto-refresh: 2s</option>
          <option value="5000">Auto-refresh: 5s</option>
          <option value="10000">Auto-refresh: 10s</option>
          <option value="30000">Auto-refresh: 30s</option>
        </select>
        <input id="filter" placeholder="Filter scripts‚Ä¶ (type)">
        <button id="connect" class="fx-btn ok btn-animated">Connect</button>
        <button id="refresh" class="fx-btn secondary btn-animated">Refresh</button>
      </div>
      <div class="fx-kpis">
        <div class="fx-kpi"><small id="i_k_total">Total Scripts</small><strong id="k_total">‚Äî</strong></div>
        <div class="fx-kpi"><small id="i_k_running">Running</small><strong id="k_run">‚Äî</strong></div>
        <div class="fx-kpi"><small id="i_k_stalled">Stalled</small><strong id="k_stalled">‚Äî</strong></div>
        <div class="fx-kpi"><small id="i_k_exited">Exited</small><strong id="k_exited">‚Äî</strong></div>
      </div>
    </div>

    <div class="fx-card">
      <div class="fx-actions">
        <span id="i_actions_title" style="font-weight:800; color:#fff;">IMPORTANT ACTIONS</span>
        <button class="fx-btn ok btn-animated" id="adopt" title="Enable Auto Running for ALL">Auto Running</button>
        <button class="fx-btn warn btn-animated" id="restartAll">Restart All</button>
        <button class="fx-btn danger btn-animated" id="stopAll">Stop All</button>
        <button class="fx-btn ghost btn-animated" id="copyCurl">Copy Data URL</button>
      </div>
    </div>

    <div class="fx-card" style="overflow:auto;">
      <table id="tbl" class="fx-table">
        <thead>
          <tr>
            <th id="th_script"  class="sortable" data-key="name">Script</th>
            <th id="th_pid">CMD</th>
            <th id="th_cpu"     class="sortable" data-key="cpu">CPU%</th>
            <th id="th_ram"     class="sortable" data-key="mem">RAM%</th>
            <th id="th_uptime"  class="sortable" data-key="uptime">Uptime</th>
            <th id="th_status"  class="sortable" data-key="status">Status</th>
            <th id="th_actions">Actions</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="settings-footer" style="margin-top:10px;">
      <button class="fx-btn secondary" id="btnBackMonitor" type="button">Back</button>
    </div>
  </div>
  <!-- === END MONITOR PANEL === -->

  <!-- === SETTINGS PANEL (ACCOUNT + PREFS + ADMIN) === -->
  <div id="settingsPanel" class="fx-card" style="display:none; margin-top:10px;">
    <h3 id="i_settings_title">Settings</h3>
    <p id="i_settings_sub" style="margin-bottom:12px; opacity:.85;">
      Account security and personal preferences for this device.
    </p>

    <div class="settings-layout">
      <!-- ===== My password ===== -->
      <section class="set-section">
        <h4 id="i_settings_mypass">My password</h4>

        <div class="set-field">
          <span class="set-label" id="i_settings_loggedin">Logged in as</span>
          <div class="set-note"><b id="settingsUser">-</b></div>
        </div>

        <div class="set-field">
          <label class="set-label" for="setCur" id="i_settings_curpwd">Current password</label>
          <input type="password" id="setCur" class="set-control">
        </div>

        <div class="set-field">
          <label class="set-label" for="setNew" id="i_settings_newpwd">New password</label>
          <input type="password" id="setNew" class="set-control">
        </div>

        <div class="set-field">
          <label class="set-label" for="setNew2" id="i_settings_confirmpwd">Confirm new password</label>
          <input type="password" id="setNew2" class="set-control">
        </div>

        <div id="pwStrength" class="set-note" style="margin-top:2px;"></div>

        <!-- Save stays here (left) -->
        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;">
          <button class="fx-btn ok" id="btnSavePass">Save</button>
        </div>

        <p class="set-note" id="i_settings_storage_note" style="margin-top:8px;">
          ‚ö† Passwords are stored only in this browser (localStorage).
          For each PC / browser you may need to update again.
        </p>
      </section>

      <!-- ===== Preferences ===== -->
      <section class="set-section">
        <h4 id="i_settings_prefs">Preferences</h4>

        <div class="set-field">
          <label class="set-label" for="prefLang" id="i_settings_pref_lang_label">Dashboard language</label>
          <select id="prefLang" class="set-control">
            <option value="en">English</option>
            <option value="zh">‰∏≠Êñá (Chinese)</option>
          </select>
        </div>

        <div class="set-field">
          <label class="set-label" for="prefIdle" id="i_settings_pref_idle_label">Auto logout (idle)</label>
          <select id="prefIdle" class="set-control">
            <option value="0">Never</option>
            <option value="5">After 5 minutes</option>
            <option value="10">After 10 minutes</option>
            <option value="15">After 15 minutes</option>
            <option value="30">After 30 minutes</option>
          </select>
          <div class="set-note" id="i_settings_pref_idle_note">
            Auto logout closes the dashboard if this tab is inactive.
          </div>
        </div>

        <div class="set-field">
          <label class="set-label" for="prefDensity" id="i_settings_pref_density_label">Table density</label>
          <select id="prefDensity" class="set-control">
            <option value="normal">Comfortable</option>
            <option value="compact">Compact (more rows)</option>
          </select>
        </div>
      </section>
    </div>

    <!-- ===== Admin tools (ADMIN only) ===== -->
    <section id="adminTools" class="set-section" style="margin-top:16px; display:none;">
      <h4 id="i_settings_admin_title">Admin tools</h4>
      <p class="set-note" id="i_settings_admin_note" style="margin-bottom:10px;">
        As <b>ADMIN</b> you can reset passwords for other accounts on this device.
      </p>

      <div class="set-field">
        <label class="set-label" for="adminUser" id="i_settings_admin_select_label">Select account</label>
        <select id="adminUser" class="set-control"></select>
      </div>

      <div class="set-field">
        <label class="set-label" for="adminNew" id="i_settings_admin_new_label">New password for selected account</label>
        <input type="password" id="adminNew" class="set-control">
      </div>

      <div class="set-field">
        <label class="set-label" for="adminNew2" id="i_settings_admin_confirm_label">Confirm new password</label>
        <input type="password" id="adminNew2" class="set-control">
      </div>

      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;">
        <button class="fx-btn ok"   id="btnAdminSetPass">Set Password</button>
        <button class="fx-btn warn" id="btnAdminResetDefaults">Restore Default Passwords</button>
      </div>

      <p class="set-note" id="i_settings_admin_note2" style="margin-top:8px;">
        üõà These changes affect only this browser / this PC.
      </p>
    </section>

    <!-- Back button moved here, bottom-right of Settings card -->
    <div class="settings-footer">
      <button class="fx-btn secondary" id="btnBackSettings">Back</button>
    </div>
  </div>
  <!-- === END SETTINGS PANEL === -->

  <!-- === FILES PANEL (SCRIPTS LIST + EDITOR) === -->
  <div id="filesPanel" class="fx-card" style="display:none; margin-top:10px;">
    <h3 id="i_files_title">Script files</h3>
    <p id="i_files_sub" style="margin-bottom:12px; opacity:.85;">
      View, upload and edit Python scripts on this agent.
    </p>

    <div class="settings-layout files-layout">
      <!-- Left side: list / search / upload -->
      <section class="set-section" style="flex:1.2 1 360px;">
        <h4 id="i_files_list_title">Scripts on agent</h4>

        <div class="set-field">
          <label class="set-label" for="filesSearch" id="i_files_search_label">Search / filter</label>
          <input id="filesSearch" class="set-control" placeholder="Filter by file name‚Ä¶">
        </div>

        <div class="set-field">
          <label class="set-label" id="i_files_upload_label">Upload new script</label>
          <div class="files-upload-row">
            <button class="fx-btn ok" id="btnFilesUpload" type="button">
              <i class="fa-solid fa-file-arrow-up"></i>
              <span id="i_files_upload_btn_label" style="margin-left:.3rem;">Upload script</span>
            </button>
            <span id="filesUploadName" class="set-note">No file selected.</span>
            <input type="file" id="fileUploadInput" accept=".py,.txt,.sh" style="display:none">
          </div>
          <p class="set-note" id="i_files_upload_note" style="margin-top:4px;">
            Files are sent to the agent API as multipart/form-data (field name: "file"). Existing files may be overwritten.
          </p>
        </div>

        <div class="files-table-wrap">
          <table id="filesTable" class="fx-table">
            <thead>
              <tr>
                <th id="i_files_col_name">File</th>
                <th id="i_files_col_size">Size</th>
                <th id="i_files_col_updated">Last modified</th>
                <th id="i_files_col_actions">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- Right side: code editor -->
      <section class="set-section" style="flex:1 1 340px; display:flex; flex-direction:column; min-height:260px;">
        <h4 id="i_files_editor_title">Editor</h4>

        <div class="set-field">
          <label class="set-label" id="i_files_editor_file_label">Selected file</label>
          <div class="set-note"><span id="editorFilename">No file selected.</span></div>
        </div>

        <textarea id="fileEditor" class="code-editor" spellcheck="false"
          placeholder="# Select a script from the list to view / edit its code"></textarea>

        <div class="settings-footer" style="margin-top:10px; justify-content:flex-end;">
          <button class="fx-btn secondary" id="btnEditorDiscard" type="button">
            <span id="i_files_editor_discard_label">Discard</span>
          </button>
          <button class="fx-btn ok" id="btnEditorSave" type="button">
            <span id="i_files_editor_save_label">Save changes</span>
          </button>
        </div>
      </section>
    </div>

    <div class="settings-footer">
      <button class="fx-btn secondary" id="btnBackFiles" type="button">
        <span id="i_files_back_label">Back</span>
      </button>
    </div>
  </div>
  <!-- === END FILES PANEL === -->
</div> <!-- end .content -->

<!-- Toasts -->
<div id="toast" class="toast"></div>

<!-- In-dashboard loading overlay -->
<div id="loading" aria-hidden="true"><div class="ring"></div></div>

<!-- Logs dialog -->
<dialog id="logDlg" class="modal" style="border:1px solid #3b3b3b;border-radius:12px;">
  <header style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #3b3b3b">
    <strong id="logTitle">Logs</strong>
    <div>
      <button class="fx-btn secondary btn-animated" id="copyLog">Copy</button>
      <button class="fx-btn btn-animated" id="closeLog">Close</button>
    </div>
  </header>
  <div id="logBox" style="padding:12px;background:#0b0b0b;font-family:ui-monospace,Consolas,Menlo,monospace;white-space:pre-wrap;max-height:65vh;overflow:auto"></div>
</dialog>

<!-- CMD dialog (read-only stream) -->
<dialog id="cmdDlg" class="modal" style="border:1px solid #3b3b3b;border-radius:12px;">
  <header style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #3b3b3b">
    <strong id="cmdTitle">CMD</strong>
    <button class="fx-btn secondary btn-animated" id="closeCmd">Close</button>
  </header>
  <div id="cmdBox" style="padding:12px;background:#0b0b0b;color:#e5e7eb;font-family:ui-monospace,Consolas,Menlo,monospace;white-space:pre-wrap;max-height:60vh;overflow:auto"></div>
</dialog>

<!-- Confirm modal -->
<div id="fxConfirm" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true" aria-labelledby="fxConfirmTitle">
    <div class="hd" id="fxConfirmTitle">Fixline says üì£</div>
    <div class="msg" id="fxConfirmMsg">Are you sure?</div>
    <div class="bar">
      <button class="fxbtn ok" id="fxConfirmOK">OK</button>
      <button class="fxbtn cancel" id="fxConfirmCancel">Cancel</button>
    </div>
  </div>
</div>

<script>
const AUTH_KEY  = 'fixline_auth';
const USER_KEY  = 'fixline_user';
const ACCOUNTS_KEY = 'fixline_accounts';
const IDLE_KEY       = 'fixline_idle_minutes';
const LAST_LOGIN_KEY = 'fixline_last_login';
const DENSITY_KEY    = 'fixline_table_density';
const THEME_KEY = 'fx_theme';   // 'light' or 'dark'
// Bridge activity events from dashboard iframe to parent (for idle logout)
(function setupIdleBridge(){
  ['mousemove','keydown','click','touchstart'].forEach(ev => {
    window.addEventListener(ev, () => {
      try {
        window.parent?.postMessage?.({ type: 'FX_ACTIVITY' }, '*');
      } catch(e){}
    }, true);
  });
})();

/* ===== Theme handling (light / dark) ===== */
function applyTheme(theme){
  const body = document.body;
  if (!body) return;

  body.classList.remove('fx-light','fx-dark');
  const mode = (theme === 'light') ? 'fx-light' : 'fx-dark';
  body.classList.add(mode);

  const cb = document.getElementById('themeToggle');
  if (cb) cb.checked = (theme === 'light');
}

function initTheme(){
  let theme = localStorage.getItem(THEME_KEY);
  if (theme !== 'light' && theme !== 'dark'){
    // default from system preference, fallback to dark
    try{
      if (window.matchMedia &&
          window.matchMedia('(prefers-color-scheme: light)').matches){
        theme = 'light';
      }else{
        theme = 'dark';
      }
    }catch(e){
      theme = 'dark';
    }
  }
  applyTheme(theme);

  const cb = document.getElementById('themeToggle');
  if (cb){
    cb.checked = (theme === 'light');
    cb.addEventListener('change', ()=>{
      const newTheme = cb.checked ? 'light' : 'dark';
      localStorage.setItem(THEME_KEY, newTheme);
      applyTheme(newTheme);
    });
  }
}

/* existing code continues after this‚Ä¶ */

// same defaults as outer wrapper (keys UPPERCASE)
const DEFAULT_ACCOUNTS = {
  "ADMIN": "Fixline@123",
  "BA55":  "Ba@01",
  "ZB1":   "Zb@1122",
  "DR1":   "Dr@2222",
  "RTM12": "Rtm@123"
};

// who can access Settings / Change Password
const SETTINGS_ALLOWED = ['ADMIN','BA55','ZB1','DR1'];

if (!sessionStorage.getItem(AUTH_KEY)) {
  location.href = 'login.html';
}

// current logged user (UPPERCASE)
const CURRENT_USER = (sessionStorage.getItem(USER_KEY) || '').toUpperCase();

function updateWelcomeUser(){
  const el = document.getElementById('welcomeUser');
  if (!el) return;

  if (!CURRENT_USER){
    el.textContent = '';
    return;
  }

  // Make ADMIN look a bit nicer; others stay as their code (BA55, ZB1, etc.)
  let name = CURRENT_USER;
  if (CURRENT_USER === 'ADMIN') name = 'Admin';

  const prefix = (LANG === 'zh') ? 'Ê¨¢Ëøé, ' : 'Welcome, ';
  el.textContent = prefix + name;
}

function loadAccounts() {
  try {
    const raw = window.localStorage.getItem(ACCOUNTS_KEY);
    if (raw) {
      const parsed = JSON.parse(raw);
      if (parsed && typeof parsed === 'object') return parsed;
    }
  } catch(e) {}
  const base = { ...DEFAULT_ACCOUNTS };
  try { window.localStorage.setItem(ACCOUNTS_KEY, JSON.stringify(base)); } catch(e) {}
  return base;
}

function saveAccounts(map) {
  try { window.localStorage.setItem(ACCOUNTS_KEY, JSON.stringify(map)); } catch(e) {}
}

function powerMenu(){ const m=document.getElementById('powerMenu'); m.style.display = (m.style.display==="block")?"none":"block"; }
/* Logout now notifies the parent wrapper to switch back to login */
function logout(){
  sessionStorage.removeItem(AUTH_KEY);
  try{ window.parent?.postMessage?.({type:'FIXLINE_LOGOUT'}, '*'); }catch(e){}
  // no need for location.href here, the wrapper handles switching frames
}
function reboot(){ notifyWarn('Reboot requested. (Hook your backend if needed)'); }
function poweroff(){ notifyError('Power off requested. (Hook your backend if needed)'); }
function sideNav(force){
  const m = document.getElementById('sideNav');
  if (!m) return;

  // Explicit open/close for hover logic
  if (force === true) {
    m.style.display = 'block';
    return;
  }
  if (force === false) {
    m.style.display = 'none';
    return;
  }

  // Fallback toggle when user clicks the button
  m.style.display = (m.style.display === 'block') ? 'none' : 'block';
}
function options(){ const m=document.getElementById('options'); m.style.display = (m.style.display==="block")?"none":"block"; }

/* === NEW: open side nav on hover, close when mouse leaves panel === */
(function setupSideHover(){
  const btn   = document.querySelector('.sideNav');
  const panel = document.getElementById('sideNav');
  if (!btn || !panel) return;

  // open when mouse enters hamburger
  btn.addEventListener('mouseenter', () => sideNav(true));

  // close when mouse leaves the menu panel
  panel.addEventListener('mouseleave', () => sideNav(false));
})();

(function startClock(){
  const d=document.querySelector('#clock .date'), t=document.querySelector('#clock .time');
  const wk=['SUN','MON','TUE','WED','THU','FRI','SAT'];
  const pad=n=>String(n).padStart(2,'0');
  const tick=()=>{ const cd=new Date(); d.textContent = `${cd.getFullYear()}-${pad(cd.getMonth()+1)}-${pad(cd.getDate())} ${wk[cd.getDay()]}`; t.textContent = `${pad(cd.getHours())}:${pad(cd.getMinutes())}:${pad(cd.getSeconds())}`; };
  tick(); setInterval(tick,1000);
})();

/* ===== Toasts ===== */
function addToast(variant, text){
  const tray=document.getElementById('toast');
  const n=document.createElement('div');
  const cls = `notification notification--${variant}`;
  n.className = cls;
  n.innerHTML = `<div class="notification__body">${text}</div><div class="notification__progress"></div>`;
  tray.appendChild(n);
  setTimeout(()=> n.remove(), 3200);
}
const notifySuccess=(m)=>addToast('success', m);
const notifyError  =(m)=>addToast('failure', m);
const notifyWarn   =(m)=>addToast('warning', m);
const notifyInfo   =(m)=>addToast('info', m);

const LS_BASE='fx_base', LS_TOKEN='fx_token', LS_INT='fx_interval';
const $ = s=>document.querySelector(s);

function httpsHttpGuard(){
  const base = ($('#base')?.value || '').trim();
  if (!base) return true;
  if (location.protocol === 'https:' && base.startsWith('http://')) {
    notifyWarn('Blocked by browser (HTTPS page to HTTP API). Use HTTPS base URL.');
    return false;
  }
  return true;
}

function getApi(){
  const base = ($('#base')?.value || '').trim();
  const tk   = ($('#token')?.value || '').trim();
  if(!base){ notifyWarn('Set Base URL first.üí°'); return null; }
  if (location.protocol === 'https:' && base.startsWith('http://')){ notifyWarn('Blocked (HTTPS to HTTP). Use HTTPS base URL.'); return null; }
  return { base: base.replace(/\/+$/,'') , tk };
}
async function apiPost(path, body){
  const A = getApi(); if(!A) throw new Error('no-base');
  const build = (useQueryToken=false) => {
    const url = A.base + path + (useQueryToken ? (path.includes('?')?'&':'?') + 'token=' + encodeURIComponent(A.tk) : '');
    const headers = useQueryToken ? {} : { 'Authorization':'Bearer '+A.tk };
    const opt = { method:'POST', headers, mode:'cors', cache:'no-store' };
    if (body !== undefined){ opt.headers['Content-Type']='application/json'; opt.body=JSON.stringify(body); }
    return { url, opt };
  };
  try{
    const {url,opt} = build(false); const r = await fetch(url, opt);
    if(!r.ok) throw new Error((await r.text()) || r.statusText);
    return r.json().catch(()=> ({}));
  }catch(err){
    if (body === undefined){
      const {url,opt} = build(true); const r2 = await fetch(url, opt);
      if(!r2.ok) throw new Error((await r2.text()) || r2.statusText);
      return r2.json().catch(()=> ({}));
    }
    throw err;
  }
}

async function apiGet(path){
  const A = getApi(); 
  if (!A) throw new Error('no-base');

  const build = (useQueryToken = false) => {
    const url = A.base + path + (
      useQueryToken && A.tk
        ? (path.includes('?') ? '&' : '?') + 'token=' + encodeURIComponent(A.tk)
        : ''
    );
    const headers = useQueryToken || !A.tk ? {} : { 'Authorization':'Bearer ' + A.tk };
    return {
      url,
      opt: {
        method:'GET',
        headers,
        mode:'cors',
        cache:'no-store'
      }
    };
  };

  try{
    const {url,opt} = build(false);
    const r = await fetch(url,opt);
    if (!r.ok) throw new Error((await r.text()) || r.statusText);
    return r;
  }catch(err){
    const {url,opt} = build(true);
    const r2 = await fetch(url,opt);
    if (!r2.ok) throw new Error((await r2.text()) || r2.statusText);
    return r2;
  }
}

/* ===== Language (EN/‰∏≠Êñá) ===== */
const LANG_KEY = 'fx_lang';
let   LANG     = localStorage.getItem(LANG_KEY) || 'en';

const I18N = {
  en: {
    titleWelcome: "Welcome to Fixline Dashboard",
    subText: "Real-time Managing Automation Scripts System.",
    agentConnection: "Agent Connection",
    kTotal: "Total Scripts", kRunning: "Running", kStalled: "Stalled", kExited: "Exited",
    actionsTitle: "IMPORTANT ACTIONS",
    btnAutoRunning: "Auto Running", btnRestartAll: "Restart All", btnStopAll: "Stop All",
    btnCopyUrl: "Copy Data URL", btnConnect: "Connect", btnRefresh: "Refresh",
    phBase: "API Base URL (e.g. https://win-xxxx.ts.net)",
    phToken: "Token (Bearer or ?token=)",
    phFilter: "Filter scripts‚Ä¶ (type)",
    intervalOptions: {
      "0":"Auto-refresh: Off",
      "1000":"Auto-refresh: 1s",
      "2000":"Auto-refresh: 2s",
      "5000":"Auto-refresh: 5s",
      "10000":"Auto-refresh: 10s",
      "30000":"Auto-refresh: 30s"
    },
    thScript:"Script", thPID:"CMD", thCPU:"CPU%", thRAM:"RAM%", thUptime:"Uptime", thStatus:"Status", thActions:"Actions",
    nodata:'No data yet. Click <b>Connect</b>.',
    liveTime:"Live time",
    overviewTitle: "FixLine Overview",
overviewSub: "Summary of your scripts and quick shortcuts.",
overviewIntro: "Use this page as a quick overview. For full control go to the Monitor page.",
overviewTip1: "Monitor and control automation scripts in real time.",
overviewTip2: "Open Monitor to start / stop scripts and view logs.",
overviewTip3: "Use the Files page to upload and edit scripts on this agent.",
overviewGoMonitor: "Open Monitor",
overviewGoFiles: "Script files",
overviewGoSettings: "Settings",
overviewStatsHint: "Stats are updated when you connect to an agent on the Monitor page.",
monitorTitle: "Monitor",
monitorSub: "Detailed view for script status, actions and live CMD/logs.",

    /* === Settings (EN) === */
    settingsTitle: "Settings",
    settingsSub: "Account security and personal preferences for this device.",
    settingsMyPwd: "My password",
    settingsLoggedInAs: "Logged in as",
    settingsCurPwd: "Current password",
    settingsNewPwd: "New password",
    settingsConfirmPwd: "Confirm new password",
    settingsStorageNote: "‚ö† Passwords are stored only in this browser (localStorage). For each PC / browser you may need to update again.",
    settingsSaveBtn: "Save",
    settingsBackBtn: "Back",
    settingsLastLogin: "Last login",

    settingsPrefsTitle: "Preferences",
    settingsPrefLang: "Dashboard language",
    settingsPrefIdle: "Auto logout (idle)",
    settingsPrefIdleNote: "Auto logout closes the dashboard if this tab is inactive.",
    settingsPrefDensity: "Table density",
    settingsDensityComfort: "Comfortable",
    settingsDensityCompact: "Compact (more rows)",

    settingsAdminTitle: "Admin tools",
    settingsAdminNote: "As ADMIN you can reset passwords for other accounts on this device.",
    settingsAdminSelect: "Select account",
    settingsAdminNewPwd: "New password for selected account",
    settingsAdminConfirmPwd: "Confirm new password",
    settingsAdminSetBtn: "Set Password",
    settingsAdminResetBtn: "Restore Default Passwords",
    settingsAdminNote2: "üõà These changes affect only this browser / this PC.",

    idleOpt0: "Never",
    idleOpt5: "After 5 minutes",
    idleOpt10:"After 10 minutes",
    idleOpt15:"After 15 minutes",
    idleOpt30:"After 30 minutes",

    navOverview: "Overview",
    navFiles: "Files",
    navSetting: "Settings",
    navMonitor: "Monitor",
    navNotif: "Notification",
    topChangePass: "Change Password",

    settingsPwdStrength: "Password strength",
    settingsPwdWeak: "Weak",
    settingsPwdMedium: "Medium",
    settingsPwdStrong: "Strong",

    // Files (EN)
    filesTitle: "Script files",
    filesSub: "View, upload and edit Python scripts on this agent.",
    filesListTitle: "Scripts on agent",
    filesSearchLabel: "Search / filter",
    filesSearchPlaceholder: "Filter by file name‚Ä¶",
    filesUploadLabel: "Upload new script",
    filesUploadButton: "Upload script",
    filesUploadNote: "Files are sent to the agent API as multipart/form-data (field name: \"file\"). Existing files may be overwritten.",
    filesColName: "File",
    filesColSize: "Size",
    filesColUpdated: "Last modified",
    filesColActions: "Actions",
    filesEditorTitle: "Editor",
    filesEditorFileLabel: "Selected file",
    filesEditorNoFile: "No file selected.",
    filesEditorDiscard: "Discard",
    filesEditorSave: "Save changes",
    filesBackBtn: "Back",
    filesNoFiles: "No scripts returned from API."
  },

  zh: {
    titleWelcome: "Ê¨¢Ëøé‰ΩøÁî® FixLine ‰ª™Ë°®Áõò",
    subText: "ÂÆûÊó∂ÁÆ°ÁêÜËá™Âä®ÂåñËÑöÊú¨Á≥ªÁªü„ÄÇ",
    agentConnection: "‰ª£ÁêÜËøûÊé•",
    kTotal: "ËÑöÊú¨ÊÄªÊï∞", kRunning: "ËøêË°å‰∏≠", kStalled: "Âç°‰Ωè", kExited: "Â∑≤ÈÄÄÂá∫",
    actionsTitle: "ÈáçË¶ÅÊìç‰Ωú",
    btnAutoRunning: "Ëá™Âä®ËøêË°å", btnRestartAll: "ÂÖ®ÈÉ®ÈáçÂêØ", btnStopAll: "ÂÖ®ÈÉ®ÂÅúÊ≠¢",
    btnCopyUrl: "Â§çÂà∂Êï∞ÊçÆÂú∞ÂùÄ", btnConnect: "ËøûÊé•", btnRefresh: "Âà∑Êñ∞",
    phBase: "API Âü∫Á°ÄÂú∞ÂùÄÔºàÂ¶Ç https://win-xxxx.ts.netÔºâ",
    phToken: "‰ª§ÁâåÔºàBearer Êàñ ?token=Ôºâ",
    phFilter: "ËøáÊª§ËÑöÊú¨‚Ä¶ÔºàËæìÂÖ•Á±ªÂûãÔºâ",
    intervalOptions: {
      "0":"Ëá™Âä®Âà∑Êñ∞ÔºöÂÖ≥Èó≠",
      "1000":"Ëá™Âä®Âà∑Êñ∞Ôºö1Áßí",
      "2000":"Ëá™Âä®Âà∑Êñ∞Ôºö2Áßí",
      "5000":"Ëá™Âä®Âà∑Êñ∞Ôºö5Áßí",
      "10000":"Ëá™Âä®Âà∑Êñ∞Ôºö10Áßí",
      "30000":"Ëá™Âä®Âà∑Êñ∞Ôºö30Áßí"
    },
    thScript:"ËÑöÊú¨", thPID:"CMD", thCPU:"CPU%", thRAM:"ÂÜÖÂ≠ò%", thUptime:"ËøêË°åÊó∂Èïø", thStatus:"Áä∂ÊÄÅ", thActions:"Êìç‰Ωú",
    nodata:'ÊöÇÊó†Êï∞ÊçÆ„ÄÇËØ∑ÁÇπÂáª <b>ËøûÊé•</b>„ÄÇ',
    liveTime:"ÂÆûÊó∂Êó∂Èó¥",
    overviewTitle: "FixLine ÊÄªËßà",
overviewSub: "ËÑöÊú¨Ê¶ÇÂÜµÂíåÂø´Êç∑ÂÖ•Âè£„ÄÇ",
overviewIntro: "Ê≠§È°µÈù¢Áî®‰∫éÂø´ÈÄüÊÄªËßà„ÄÇÂ¶ÇÈúÄÂÆåÊï¥ÊéßÂà∂ÔºåËØ∑ÊâìÂºÄ‚ÄúÁõëËßÜÂô®‚ÄùÈ°µ„ÄÇ",
overviewTip1: "ÂÆûÊó∂Êü•ÁúãÂπ∂ÊéßÂà∂Ëá™Âä®ÂåñËÑöÊú¨„ÄÇ",
overviewTip2: "Âú®‚ÄúÁõëËßÜÂô®‚Äù‰∏≠ÂêØÂä® / ÂÅúÊ≠¢ËÑöÊú¨Âπ∂Êü•ÁúãÊó•Âøó„ÄÇ",
overviewTip3: "Âú®‚ÄúÊñá‰ª∂‚ÄùÈ°µ‰∏ä‰º†ÊàñÁºñËæë‰ª£ÁêÜ‰∏äÁöÑËÑöÊú¨„ÄÇ",
overviewGoMonitor: "ÊâìÂºÄÁõëËßÜÂô®",
overviewGoFiles: "ËÑöÊú¨Êñá‰ª∂",
overviewGoSettings: "ËÆæÁΩÆ",
overviewStatsHint: "ÂΩì‰Ω†Âú®‚ÄúÁõëËßÜÂô®‚Äù‰∏≠ËøûÊé•‰ª£ÁêÜÊó∂ÔºåËøôÈáåÁöÑÁªüËÆ°‰ºöÊõ¥Êñ∞„ÄÇ",
monitorTitle: "ÁõëËßÜÂô®",
monitorSub: "ËÑöÊú¨Áä∂ÊÄÅ„ÄÅÊìç‰Ωú‰ª•Âèä CMD / Êó•ÂøóÁöÑËØ¶ÁªÜËßÜÂõæ„ÄÇ",

    /* === Settings (ZH) === */
    settingsTitle: "ËÆæÁΩÆ",
    settingsSub: "Ê≠§ËÆæÂ§áÁöÑË¥¶Âè∑ÂÆâÂÖ®Âíå‰∏™‰∫∫ÂÅèÂ•Ω„ÄÇ",
    settingsMyPwd: "ÊàëÁöÑÂØÜÁ†Å",
    settingsLoggedInAs: "ÂΩìÂâçÁôªÂΩïË¥¶Âè∑",
    settingsCurPwd: "ÂΩìÂâçÂØÜÁ†Å",
    settingsNewPwd: "Êñ∞ÂØÜÁ†Å",
    settingsConfirmPwd: "Á°ÆËÆ§Êñ∞ÂØÜÁ†Å",
    settingsStorageNote: "‚ö† ÂØÜÁ†ÅÂè™‰øùÂ≠òÂú®Êú¨ÊµèËßàÂô®ÔºàlocalStorageÔºâ‰∏≠„ÄÇÊõ¥Êç¢ÁîµËÑë / ÊµèËßàÂô®ÂêéÈúÄË¶ÅÈáçÊñ∞ËÆæÁΩÆ„ÄÇ",
    settingsSaveBtn: "‰øùÂ≠ò",
    settingsBackBtn: "ËøîÂõû",
    settingsLastLogin: "‰∏äÊ¨°ÁôªÂΩï",

    settingsPrefsTitle: "ÂÅèÂ•ΩËÆæÁΩÆ",
    settingsPrefLang: "‰ª™Ë°®ÁõòËØ≠Ë®Ä",
    settingsPrefIdle: "Ëá™Âä®ÁôªÂá∫ÔºàÁ©∫Èó≤Ôºâ",
    settingsPrefIdleNote: "Â¶ÇÊûúÊ≠§Ê†áÁ≠æÈ°µÈïøÊó∂Èó¥Êó†Êìç‰ΩúÔºåÂ∞ÜËá™Âä®ÈÄÄÂá∫‰ª™Ë°®Áõò„ÄÇ",
    settingsPrefDensity: "Ë°®Ê†ºË°åË∑ù",
    settingsDensityComfort: "ËàíÈÄÇ",
    settingsDensityCompact: "Á¥ßÂáëÔºàÊòæÁ§∫Êõ¥Â§öË°åÔºâ",

    settingsAdminTitle: "ÁÆ°ÁêÜÂëòÂ∑•ÂÖ∑",
    settingsAdminNote: "‰Ωú‰∏∫ ADMINÔºå‰Ω†ÂèØ‰ª•‰∏∫Ê≠§ËÆæÂ§á‰∏äÁöÑÂÖ∂‰ªñË¥¶Âè∑ÈáçÁΩÆÂØÜÁ†Å„ÄÇ",
    settingsAdminSelect: "ÈÄâÊã©Ë¥¶Âè∑",
    settingsAdminNewPwd: "ÈÄâ‰∏≠Ë¥¶Âè∑ÁöÑÊñ∞ÂØÜÁ†Å",
    settingsAdminConfirmPwd: "Á°ÆËÆ§Êñ∞ÂØÜÁ†Å",
    settingsAdminSetBtn: "ËÆæÁΩÆÂØÜÁ†Å",
    settingsAdminResetBtn: "ÊÅ¢Â§çÈªòËÆ§ÂØÜÁ†Å",
    settingsAdminNote2: "üõà Ëøô‰∫õ‰øÆÊîπÂè™ÂΩ±ÂìçÂΩìÂâçÊµèËßàÂô® / ËøôÂè∞ÁîµËÑë„ÄÇ",

    idleOpt0: "‰ªé‰∏ç",
    idleOpt5: "Á©∫Èó≤ 5 ÂàÜÈíüÂêé",
    idleOpt10:"Á©∫Èó≤ 10 ÂàÜÈíüÂêé",
    idleOpt15:"Á©∫Èó≤ 15 ÂàÜÈíüÂêé",
    idleOpt30:"Á©∫Èó≤ 30 ÂàÜÈíüÂêé",

    navOverview: "ÊÄªËßà",
    navFiles: "Êñá‰ª∂",
    navSetting: "ËÆæÁΩÆ",
    navMonitor: "ÁõëËßÜÂô®",
    navNotif: "ÈÄöÁü•",
    topChangePass: "‰øÆÊîπÂØÜÁ†Å",

    settingsPwdStrength: "ÂØÜÁ†ÅÂº∫Â∫¶",
    settingsPwdWeak: "Âº±",
    settingsPwdMedium: "‰∏≠",
    settingsPwdStrong: "Âº∫",

    // Files (ZH)
    filesTitle: "ËÑöÊú¨Êñá‰ª∂",
    filesSub: "Âú®Ê≠§‰ª£ÁêÜ‰∏äÊü•Áúã„ÄÅ‰∏ä‰º†ÂíåÁºñËæë Python ËÑöÊú¨„ÄÇ",
    filesListTitle: "‰ª£ÁêÜ‰∏äÁöÑËÑöÊú¨",
    filesSearchLabel: "ÊêúÁ¥¢ / ËøáÊª§",
    filesSearchPlaceholder: "ÊåâÊñá‰ª∂ÂêçËøáÊª§‚Ä¶",
    filesUploadLabel: "‰∏ä‰º†Êñ∞ËÑöÊú¨",
    filesUploadButton: "‰∏ä‰º†ËÑöÊú¨",
    filesUploadNote: "Êñá‰ª∂‰ª• multipart/form-dataÔºàÂ≠óÊÆµÂêç \"file\"ÔºâÂèëÈÄÅÂà∞‰ª£ÁêÜ APIÔºåÈáçÂêçÊñá‰ª∂ÂèØËÉΩ‰ºöË¢´Ë¶ÜÁõñ„ÄÇ",
    filesColName: "Êñá‰ª∂",
    filesColSize: "Â§ßÂ∞è",
    filesColUpdated: "ÊúÄÂêé‰øÆÊîπÊó∂Èó¥",
    filesColActions: "Êìç‰Ωú",
    filesEditorTitle: "ÁºñËæëÂô®",
    filesEditorFileLabel: "Â∑≤ÈÄâÊã©ÁöÑÊñá‰ª∂",
    filesEditorNoFile: "Êú™ÈÄâÊã©Êñá‰ª∂„ÄÇ",
    filesEditorDiscard: "ÊîæÂºÉ‰øÆÊîπ",
    filesEditorSave: "‰øùÂ≠ò‰øÆÊîπ",
    filesBackBtn: "ËøîÂõû",
    filesNoFiles: "API Êú™ËøîÂõû‰ªª‰ΩïËÑöÊú¨Êñá‰ª∂„ÄÇ"
  }
};
const t = (k)=> (I18N[LANG] && I18N[LANG][k]) || I18N.en[k] || k;

function applyLang(){
  const S = I18N[LANG] || I18N.en;
  document.documentElement.lang = LANG;

  const $id = (id)=>document.getElementById(id);

  // Main dashboard top texts
  $id('i_title').textContent = S.titleWelcome;
  $id('i_sub').textContent   = S.subText;
  $id('i_agent').textContent = S.agentConnection;

  $id('i_k_total').textContent   = S.kTotal;
  $id('i_k_running').textContent = S.kRunning;
  $id('i_k_stalled').textContent = S.kStalled;
  $id('i_k_exited').textContent  = S.kExited;

  $id('i_actions_title').textContent = S.actionsTitle;

  $id('adopt').textContent      = S.btnAutoRunning;
  $id('restartAll').textContent = S.btnRestartAll;
  $id('stopAll').textContent    = S.btnStopAll;
  $id('copyCurl').textContent   = S.btnCopyUrl;
  $id('connect').textContent    = S.btnConnect;
  $id('refresh').textContent    = S.btnRefresh;

  $id('base').placeholder   = S.phBase;
  $id('token').placeholder  = S.phToken;
  $id('filter').placeholder = S.phFilter;

  $id('th_script').textContent  = S.thScript;
  $id('th_pid').textContent     = S.thPID;     // shows "CMD"
  $id('th_cpu').textContent     = S.thCPU;
  $id('th_ram').textContent     = S.thRAM;
  $id('th_uptime').textContent  = S.thUptime;
  $id('th_status').textContent  = S.thStatus;
  $id('th_actions').textContent = S.thActions;

  const ll = $id('i_livetime_label'); if (ll) ll.textContent = S.liveTime;

  // Language dropdown label + flag
  $id('langLabel').textContent = (LANG==='zh') ? '‰∏≠Êñá' : 'English';
  const lf = $id('langFlag');
  if (lf) lf.className = 'flag ' + (LANG==='zh' ? 'flag-cn' : 'flag-gb');

  document.querySelectorAll('.lang-item').forEach(i =>
    i.classList.toggle('active', i.dataset.lang===LANG)
  );

  // ===== Settings texts =====
  if ($id('i_settings_title'))        $id('i_settings_title').textContent        = S.settingsTitle;
  if ($id('i_settings_sub'))          $id('i_settings_sub').textContent          = S.settingsSub;
  if ($id('i_settings_mypass'))       $id('i_settings_mypass').textContent       = S.settingsMyPwd;
  if ($id('i_settings_loggedin'))     $id('i_settings_loggedin').textContent     = S.settingsLoggedInAs;
  if ($id('i_settings_curpwd'))       $id('i_settings_curpwd').textContent       = S.settingsCurPwd;
  if ($id('i_settings_newpwd'))       $id('i_settings_newpwd').textContent       = S.settingsNewPwd;
  if ($id('i_settings_confirmpwd'))   $id('i_settings_confirmpwd').textContent   = S.settingsConfirmPwd;
  if ($id('i_settings_storage_note')) $id('i_settings_storage_note').textContent = S.settingsStorageNote;

  if ($id('i_settings_prefs'))               $id('i_settings_prefs').textContent               = S.settingsPrefsTitle;
  if ($id('i_settings_pref_lang_label'))     $id('i_settings_pref_lang_label').textContent     = S.settingsPrefLang;
  if ($id('i_settings_pref_idle_label'))     $id('i_settings_pref_idle_label').textContent     = S.settingsPrefIdle;
  if ($id('i_settings_pref_idle_note'))      $id('i_settings_pref_idle_note').textContent      = S.settingsPrefIdleNote;
  if ($id('i_settings_pref_density_label'))  $id('i_settings_pref_density_label').textContent  = S.settingsPrefDensity;

  if ($id('i_settings_admin_title'))         $id('i_settings_admin_title').textContent         = S.settingsAdminTitle;
  if ($id('i_settings_admin_note'))          $id('i_settings_admin_note').textContent          = S.settingsAdminNote;
  if ($id('i_settings_admin_select_label'))  $id('i_settings_admin_select_label').textContent  = S.settingsAdminSelect;
  if ($id('i_settings_admin_new_label'))     $id('i_settings_admin_new_label').textContent     = S.settingsAdminNewPwd;
  if ($id('i_settings_admin_confirm_label')) $id('i_settings_admin_confirm_label').textContent = S.settingsAdminConfirmPwd;
  if ($id('i_settings_admin_note2'))         $id('i_settings_admin_note2').textContent         = S.settingsAdminNote2;

  const saveBtn = $id('btnSavePass');
  if (saveBtn) saveBtn.textContent = S.settingsSaveBtn;

  const backBtn = $id('btnBackSettings');
  if (backBtn) backBtn.textContent = S.settingsBackBtn;

  // Idle dropdown labels
  const idleSel = $id('prefIdle');
  if (idleSel){
    const o0  = idleSel.querySelector('option[value="0"]');
    const o5  = idleSel.querySelector('option[value="5"]');
    const o10 = idleSel.querySelector('option[value="10"]');
    const o15 = idleSel.querySelector('option[value="15"]');
    const o30 = idleSel.querySelector('option[value="30"]');
    if (o0)  o0.textContent  = S.idleOpt0;
    if (o5)  o5.textContent  = S.idleOpt5;
    if (o10) o10.textContent = S.idleOpt10;
    if (o15) o15.textContent = S.idleOpt15;
    if (o30) o30.textContent = S.idleOpt30;
  }

    // Files panel
  if ($id('i_files_title'))        $id('i_files_title').textContent        = S.filesTitle || 'Script files';
  if ($id('i_files_sub'))          $id('i_files_sub').textContent          = S.filesSub || '';
  if ($id('i_files_list_title'))   $id('i_files_list_title').textContent   = S.filesListTitle || 'Scripts on agent';
  if ($id('i_files_search_label')) $id('i_files_search_label').textContent = S.filesSearchLabel || 'Search / filter';

  const fs = $id('filesSearch');
  if (fs && S.filesSearchPlaceholder) fs.placeholder = S.filesSearchPlaceholder;

  if ($id('i_files_upload_label'))      $id('i_files_upload_label').textContent      = S.filesUploadLabel || 'Upload new script';
  if ($id('i_files_upload_btn_label'))  $id('i_files_upload_btn_label').textContent  = S.filesUploadButton || 'Upload script';
  if ($id('i_files_upload_note'))       $id('i_files_upload_note').textContent       = S.filesUploadNote || '';

  if ($id('i_files_col_name'))    $id('i_files_col_name').textContent    = S.filesColName || 'File';
  if ($id('i_files_col_size'))    $id('i_files_col_size').textContent    = S.filesColSize || 'Size';
  if ($id('i_files_col_updated')) $id('i_files_col_updated').textContent = S.filesColUpdated || 'Last modified';
  if ($id('i_files_col_actions')) $id('i_files_col_actions').textContent = S.filesColActions || 'Actions';

  if ($id('i_files_editor_title'))       $id('i_files_editor_title').textContent       = S.filesEditorTitle || 'Editor';
  if ($id('i_files_editor_file_label'))  $id('i_files_editor_file_label').textContent  = S.filesEditorFileLabel || 'Selected file';
  if ($id('editorFilename'))             $id('editorFilename').textContent             = S.filesEditorNoFile || 'No file selected.';
  if ($id('filesUploadName'))            $id('filesUploadName').textContent            = S.filesEditorNoFile || 'No file selected.';
  if ($id('i_files_editor_discard_label'))$id('i_files_editor_discard_label').textContent = S.filesEditorDiscard || 'Discard';
  if ($id('i_files_editor_save_label'))   $id('i_files_editor_save_label').textContent   = S.filesEditorSave || 'Save changes';
  if ($id('i_files_back_label'))          $id('i_files_back_label').textContent          = S.filesBackBtn || 'Back';

  // Density dropdown labels
  const densSel = $id('prefDensity');
  if (densSel){
    const dn = densSel.querySelector('option[value="normal"]');
    const dc = densSel.querySelector('option[value="compact"]');
    if (dn) dn.textContent = S.settingsDensityComfort;
    if (dc) dc.textContent = S.settingsDensityCompact;
  }

  // Nav labels
  const navMap = [
    ['navOverview','navOverview'],
    ['navFiles','navFiles'],
    ['navSetting','navSetting'],
    ['navMonitor','navMonitor'],
    ['navNotif','navNotif']
  ];
  navMap.forEach(([id,key])=>{
    const el = $id(id);
    if (el && S[key]) el.textContent = S[key];
  });

  // "Change Password" item in top-right menu
  const topChange = $id('topChangePass');
  if (topChange && S.topChangePass){
    topChange.innerHTML = '<i class="fa-solid fa-unlock"></i> ' + S.topChangePass;
  }

  // Update "Welcome, USER" label in header
  updateWelcomeUser();

  // If password strength text is visible, re-render it in this language
  if (window.FX_UPDATE_STRENGTH){
    const pwdEl = $id('setNew');
    if (pwdEl && pwdEl.value){
      window.FX_UPDATE_STRENGTH(pwdEl.value);
    }
  }
}
function setLang(l){ LANG = l; localStorage.setItem(LANG_KEY,l); applyLang(); }

const langRoot   = document.getElementById('lang');
const langToggle = document.getElementById('langToggle');
function toggleLangOpen(open){
  const isOpen = open==null ? !langRoot.classList.contains('open') : open;
  langRoot.classList.toggle('open', isOpen);
  langToggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
}
langToggle.addEventListener('click', (e)=>{ e.stopPropagation(); toggleLangOpen(); });
document.addEventListener('click', (e)=>{ if(!langRoot.contains(e.target)) toggleLangOpen(false); });
document.querySelectorAll('.lang-item').forEach(btn=>{ btn.addEventListener('click', ()=>{ setLang(btn.dataset.lang); toggleLangOpen(false); }); });

let timer=null, currentRows=[];
let sortKey='name', sortDir=1;
const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

function applyTableDensity(mode){
  const root = document.body;
  if (!root) return;
  root.classList.toggle('fx-compact-table', mode === 'compact');
}

function fxShowPanel(panelId){
  const overview = document.getElementById('overviewPanel');
  const settings = document.getElementById('settingsPanel');
  const files    = document.getElementById('filesPanel');
  const monitor  = document.getElementById('monitorPanel');

  // Hide special panels
  [settings, files, monitor].forEach(el => {
    if (!el) return;
    el.style.display = 'none';
    el.classList.remove('fullscreen');
  });

  // Overview is visible only when no special panel is requested
  if (overview){
    overview.style.display = panelId ? 'none' : 'block';
  }

  if (!panelId) return;

  if (panelId === 'settingsPanel' && settings){
    settings.style.display = 'block';
    settings.classList.add('fullscreen');
  } else if (panelId === 'filesPanel' && files){
    files.style.display = 'block';
    files.classList.add('fullscreen');
  } else if (panelId === 'monitorPanel' && monitor){
    monitor.style.display = 'block';
    monitor.classList.add('fullscreen');
  }
}

/* ===== Confirm modal helper (top-drop) ===== */
function fxConfirm(message){
  return new Promise((resolve)=>{
    const root = document.getElementById('fxConfirm');
    const msg  = document.getElementById('fxConfirmMsg');
    const ok   = document.getElementById('fxConfirmOK');
    const no   = document.getElementById('fxConfirmCancel');

    msg.textContent = message;
    root.classList.add('on');
    root.setAttribute('aria-hidden','false');

    const done = (val)=>{
      root.classList.remove('on');
      root.setAttribute('aria-hidden','true');
      ok.onclick = no.onclick = null;
      document.removeEventListener('keydown', onKey);
      resolve(val);
    };
    const onKey = (e)=>{ if(e.key==='Escape') done(false); if(e.key==='Enter')  done(true); };
    ok.onclick = ()=>done(true);
    no.onclick = ()=>done(false);
    document.addEventListener('keydown', onKey);
    root.addEventListener('click', (e)=>{ if(e.target===root) done(false); }, {once:true});
  });
}

function applySortIndicators(){
  document.querySelectorAll('th.sortable').forEach(th=>{
    th.classList.remove('asc','desc');
    if(th.dataset.key===sortKey) th.classList.add(sortDir===1?'asc':'desc');
  });
}
function sortRows(rows){
  const key = sortKey;
  return rows.slice().sort((a,b)=>{
    const va = (a[key] ?? ''), vb = (b[key] ?? '');
    if (key==='name' || key==='status') return String(va).localeCompare(String(vb)) * sortDir;
    return (((+va)||0) - ((+vb)||0)) * sortDir;
  });
}
function renderRows(rows){
  currentRows = rows||[];
  const filter = (document.getElementById('filter')?.value || '').trim().toLowerCase();

  const filtered = currentRows.filter(x=> !filter || (x.name||'').toLowerCase().includes(filter));
  const view = sortRows(filtered);

  const total   = currentRows.length;
  const running = currentRows.filter(x => x.status==='running' || x.status==='adopted').length;
  const stalled = currentRows.filter(x => x.status==='stalled').length;
  const exited  = currentRows.filter(x => x.status==='exited').length;

  const kTotal   = document.getElementById('k_total');
  const kRun     = document.getElementById('k_run');
  const kStalled = document.getElementById('k_stalled');
  const kExited  = document.getElementById('k_exited');

  if (kTotal)   kTotal.textContent   = total;
  if (kRun)     kRun.textContent     = running;
  if (kStalled) kStalled.textContent = stalled;
  if (kExited)  kExited.textContent  = exited;

  const ovTotal   = document.getElementById('ov_total');
  const ovRun     = document.getElementById('ov_run');
  const ovStalled = document.getElementById('ov_stalled');
  const ovExited  = document.getElementById('ov_exited');

  if (ovTotal)   ovTotal.textContent   = total;
  if (ovRun)     ovRun.textContent     = running;
  if (ovStalled) ovStalled.textContent = stalled;
  if (ovExited)  ovExited.textContent  = exited;

  const tb=document.getElementById('tbody'); tb.innerHTML='';
  if(view.length===0){
    const tr=document.createElement('tr');
    tr.innerHTML = `<td colspan="7">${t('nodata')}</td>`;
    tb.appendChild(tr);
    applySortIndicators();
    return;
  }

  view.forEach(x=>{
    const cpu = clamp(+x.cpu||0, 0, 100);
    const mem = clamp(+x.mem||0, 0, 100);
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><strong>${x.name}</strong><div style="opacity:.7; font-size:12px;">${x.path??''}</div></td>
      <td><button class="fx-btn secondary btn-animated" data-cmd="${x.id}" data-name="${x.name}">CMD</button></td>
      <td class="pct" style="--w:${cpu}%"><span>${cpu.toFixed(1)}</span></td>
      <td class="pct" style="--w:${mem}%"><span>${mem.toFixed(1)}</span></td>
      <td>${fmtUptime(x.uptime||0)}</td>
      <td>${pill(x.status)}</td>
      <td>
        <button class="fx-btn ok btn-animated" data-start="${x.id}" data-name="${x.name}">Start</button>
        <button class="fx-btn warn btn-animated" data-restart="${x.id}" data-name="${x.name}">Restart</button>
        <button class="fx-btn danger btn-animated" data-stop="${x.id}" data-name="${x.name}">Stop</button>
        <button class="fx-btn secondary btn-animated" data-logs="${x.id}" data-name="${x.name}">Logs</button>
      </td>`;
    tb.appendChild(tr);
  });

  document.querySelectorAll('[data-cmd]').forEach(b=> b.onclick = ()=> openCmd(b.dataset.cmd, b.dataset.name));
  document.querySelectorAll('[data-start]').forEach(b=>b.onclick=async()=>{ if(!(await fxConfirm(`Start "${b.dataset.name}"?`))) return; runCmd('START', b.dataset.start, b.dataset.name); });
  document.querySelectorAll('[data-restart]').forEach(b=>b.onclick=async()=>{ if(!(await fxConfirm(`Restart "${b.dataset.name}"?`))) return; runCmd('RESTART', b.dataset.restart, b.dataset.name); });
  document.querySelectorAll('[data-stop]').forEach(b=>b.onclick=async()=>{ if(!(await fxConfirm(`STOP "${b.dataset.name}"?`))) return; runCmd('STOP', b.dataset.stop, b.dataset.name); });
  document.querySelectorAll('[data-logs]').forEach(b=>b.onclick=()=> openLogs(b.dataset.logs, b.dataset.name));

  applySortIndicators();
}
function pill(st){ const cls={running:'p-run',stalled:'p-stalled',exited:'p-exited',unknown:'p-unknown',adopted:'p-run'}[st]||'p-unknown'; const text=st?st[0].toUpperCase()+st.slice(1):'Unknown'; return `<span class="pill ${cls}">${text}</span>`; }
function fmtUptime(s){ s=Math.max(0,s|0); const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), ss=s%60; return `${h}h ${m}m ${ss}s`; }

function showLoading(on){ const el=document.getElementById('loading'); if(el) el.classList.toggle('on', !!on); }

function loadOverview(){
  const A = getApi(); if(!A) return Promise.resolve();
  showLoading(true);
  const url = A.base + '/api/overview?token=' + encodeURIComponent(A.tk);
  return fetch(url, { cache:'no-store' })
    .then(r => r.json())
    .then(rows => { renderRows(rows || []); })
    .catch(e=>{ console.error(e); notifyError('Refresh failed: ' + e.message); })
    .finally(()=> showLoading(false));
}

function runCmd(action, id, name){
  const base = (document.getElementById('base')?.value || '').trim();
  if (!base){ notifyWarn('Set Base URL first.'); return; }
  (async () => {
    try{
      if (action==='START'){ await apiPost('/api/start/' + encodeURIComponent(id)); }
      else if (action==='STOP'){ await apiPost('/api/stop/' + encodeURIComponent(id)); }
      else if (action==='RESTART'){ await apiPost('/api/restart/' + encodeURIComponent(id)); }
      notifySuccess(`${action} sent for "${name}".`);
      loadOverview();
    }catch(e){ notifyError('Command failed: ' + (e?.message || e)); }
  })();
}

function openLogs(id, name){
  const base = (document.getElementById('base')?.value || '').trim();
  const tk   = (document.getElementById('token')?.value || '').trim();
  if (!base) { notifyWarn('Set Base URL first.'); return; }

  let wsUrl;
  try {
    const u = new URL(base);
    wsUrl = (u.protocol==='https:'?'wss://':'ws://') + u.host + '/api/logs/' + encodeURIComponent(id) + '?token=' + encodeURIComponent(tk);
  } catch {
    wsUrl = (base.startsWith('https')?'wss://':'ws://') + base.replace(/^https?:\/\//,'') + '/api/logs/' + encodeURIComponent(id) + '?token=' + encodeURIComponent(tk);
  }

  document.getElementById('logTitle').textContent = 'Logs ‚Äî ' + name;
  document.getElementById('logBox').textContent = '';
  document.getElementById('logDlg').showModal();

  const ws = new WebSocket(wsUrl);
  ws.onmessage = (e)=>{ const box=document.getElementById('logBox'); box.textContent += (e.data||'')+'\n'; box.scrollTop = box.scrollHeight; };
  ws.onerror   = ()=> notifyError('Log stream error');
}

/* === CMD dialog (read-only, with logs fallback) === */
function openCmd(id, name){
  const base = (document.getElementById('base')?.value || '').trim();
  const tk   = (document.getElementById('token')?.value || '').trim();
  if (!base) { notifyWarn('Set Base URL first.'); return; }

  const makeWS = (pathWithQuery='')=>{
    try{
      const u = new URL(base);
      const proto = (u.protocol === 'https:') ? 'wss://' : 'ws://';
      return proto + u.host + pathWithQuery;
    }catch{
      const host = base.replace(/^https?:\/\//,'');
      const proto = base.startsWith('https') ? 'wss://' : 'ws://';
      return proto + host + pathWithQuery;
    }
  };

  const endpoints = [
    makeWS('/api/cmd/'  + encodeURIComponent(id) + (tk ? ('?token=' + encodeURIComponent(tk)) : '')),
    makeWS('/api/cmd/'  + encodeURIComponent(id)),
    makeWS('/api/logs/' + encodeURIComponent(id) + (tk ? ('?token=' + encodeURIComponent(tk)) : '')),
  ];

  const title = document.getElementById('cmdTitle');
  const box   = document.getElementById('cmdBox');
  title.textContent = 'CMD ‚Äî ' + name;
  box.textContent   = 'Connecting‚Ä¶\n';
  document.getElementById('cmdDlg').showModal();

  let ws = null;
  let connected = false;
  let attempt = 0;

  const next = ()=>{
    attempt++;
    if (attempt >= endpoints.length){
      box.textContent += '[connection closed]\n';
      notifyError('CMD connection error');   // toast only once, after ALL attempts
      return;
    }
    connectAttempt(attempt);
  };

  const connectAttempt = (idx)=>{
    const url = endpoints[idx];
    const usingLogsFallback = (idx === 2);
    try{
      ws = new WebSocket(url);
    }catch(_){
      return next();
    }

    ws.onopen = ()=>{
      connected = true;
      box.textContent += usingLogsFallback
        ? '[connected to LOGS fallback ‚Äî read-only]\n'
        : '[connected]\n';
    };

    ws.onmessage = (e)=>{
      box.textContent += (e.data ?? '') + '\n';
      box.scrollTop = box.scrollHeight;
    };

    // swallow intermediate errors; we'll notify only if all attempts fail
    ws.onerror = ()=>{ /* no-op until final fail */ };

    ws.onclose = ()=>{
      if (!connected) next();
      else box.textContent += '[connection closed]\n';
    };

    // 2.5s guard to move on if a server accepts but never opens
    const guard = setTimeout(()=>{
      if (!connected && ws && ws.readyState < 2){
        try{ ws.close(); }catch(_){}
      }
    }, 2500);
    ws.addEventListener('open', ()=> clearTimeout(guard));
  };

  connectAttempt(0);

  document.getElementById('closeCmd').onclick = ()=>{
    try{ ws && ws.close(); }catch(_){}
    document.getElementById('cmdDlg').close();
  };
}

async function restartAll(){
  try{
    let r;
    try { r = await apiPost('/api/restart-all'); }
    catch(e){ if(String(e).includes('404')) r = await apiPost('/api/restart_all'); else throw e; }
    notifySuccess(`Restarted ${r.ok} script(s).` + (r.fail ? ` ${r.fail} failed.` : ''));
    setTimeout(()=>loadOverview(), 600);
  }catch(e){ notifyError('Restart-all failed: ' + e.message); }
}
async function stopAll(){
  try{
    let r;
    try { r = await apiPost('/api/stop-all'); }
    catch(e){ if(String(e).includes('404')) r = await apiPost('/api/stop_all'); else throw e; }
    notifySuccess(`Stopped ${r.ok} script(s).` + (r.fail ? ` ${r.fail} failed.` : ''));
    setTimeout(()=>loadOverview(), 600);
  }catch(e){ notifyError('Stop-all failed: ' + e.message); }
}
async function toggleAutoAll(on=true){
  await loadOverview();
  let ok=0, fail=0;
  for(const s of currentRows){
    try { await apiPost('/api/scripts/'+encodeURIComponent(s.id)+'/toggle', {autorestart:on}); ok++; }
    catch { fail++; }
  }
  notifySuccess(`Auto Running ${on?'enabled':'disabled'} for ${ok} script(s).` + (fail? ` ${fail} failed.` : ''));
  setTimeout(()=>loadOverview(), 400);
}

/* ===== Wire actions with CONFIRM modal ===== */
document.getElementById('connect').onclick = ()=>{
  if(!httpsHttpGuard()) return;
  localStorage.setItem(LS_BASE, (document.getElementById('base')?.value||'').trim());
  localStorage.setItem(LS_TOKEN, (document.getElementById('token')?.value||'').trim());
  localStorage.setItem(LS_INT,   (document.getElementById('interval')?.value||'0'));
  loadOverview().then(()=> setupAuto() ).catch(()=>{});
  notifySuccess('Connected.‚úÖ');
};
document.getElementById('refresh').onclick = ()=> loadOverview();

document.getElementById('restartAll').onclick = async ()=>{ if(!(await fxConfirm('Restart ALL scripts?'))) return; await restartAll(); };
document.getElementById('stopAll').onclick   = async ()=>{ if(!(await fxConfirm('STOP ALL scripts?'))) return; await stopAll(); };
document.getElementById('adopt').onclick     = async (e)=>{ const enable=!e.altKey; const msg = enable ? 'Enable Auto Running for ALL?' : 'Disable Auto Running for ALL?'; if(!(await fxConfirm(msg))) return; await toggleAutoAll(enable); };

document.getElementById('copyCurl').onclick = ()=>{ const base = (document.getElementById('base')?.value || '').trim(); const u = base ? (base.replace(/\/+$/,'') + '/api/overview') : location.href; navigator.clipboard.writeText(u); notifySuccess('Data URL copied.'); };
document.getElementById('copyLog').onclick  = ()=>{ navigator.clipboard.writeText(document.getElementById('logBox').textContent||''); notifySuccess('Copied.'); };
document.getElementById('closeLog').onclick = ()=> document.getElementById('logDlg').close();
document.getElementById('filter').addEventListener('input', ()=> renderRows(currentRows));

document.querySelectorAll('th.sortable').forEach(th=>{
  th.addEventListener('click', ()=>{ const k = th.dataset.key; if (sortKey===k){ sortDir*=-1; } else { sortKey=k; sortDir=1; } renderRows(currentRows); });
});

document.addEventListener('keydown', (e)=>{ if (e.key.toLowerCase()==='r'){ loadOverview(); } if (e.key==='/'){ e.preventDefault(); document.getElementById('filter').focus(); } });

// === SETTINGS / CHANGE PASSWORD LOGIC (NEW) =================
function initSettingsUI(){
  const panel      = document.getElementById('settingsPanel');
  if (!panel) return;

  const userLabel  = document.getElementById('settingsUser');
  const lastLogin  = document.getElementById('lastLoginInfo');
  const cur        = document.getElementById('setCur');
  const np         = document.getElementById('setNew');
  const np2        = document.getElementById('setNew2');
  const btnSave    = document.getElementById('btnSavePass');
  const btnBack    = document.getElementById('btnBackSettings');
  const pwStrength = document.getElementById('pwStrength');

  const prefLang    = document.getElementById('prefLang');
  const prefIdle    = document.getElementById('prefIdle');
  const prefDensity = document.getElementById('prefDensity');

  const adminTools  = document.getElementById('adminTools');
  const adminUser   = document.getElementById('adminUser');
  const adminNew    = document.getElementById('adminNew');
  const adminNew2   = document.getElementById('adminNew2');
  const btnAdminSet = document.getElementById('btnAdminSetPass');
  const btnAdminDef = document.getElementById('btnAdminResetDefaults');

  const isAdmin = (CURRENT_USER === 'ADMIN');

  function canUseSettings(){
    return SETTINGS_ALLOWED.includes(CURRENT_USER);
  }

  function formatLocalDate(iso){
    if (!iso) return '‚Äì';
    const d = new Date(iso);
    if (!isFinite(d.getTime())) return '‚Äì';
    const pad = n => String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} `
         + `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  function readIdleMinutes(){
    try{
      const raw = localStorage.getItem(IDLE_KEY);
      const v = parseInt(raw,10);
      return isNaN(v) ? 0 : Math.max(0,v);
    }catch(e){ return 0; }
  }

  function updateStrength(pwd){
    if (!pwStrength) return;

    const S = I18N[LANG] || I18N.en;

    if (!pwd){
      pwStrength.textContent = '';
      return;
    }
    let score = 0;
    if (pwd.length >= 8) score++;
    if (/[A-Z]/.test(pwd)) score++;
    if (/[a-z]/.test(pwd)) score++;
    if (/\d/.test(pwd)) score++;
    if (/[^A-Za-z0-9]/.test(pwd)) score++;

    let label, color;
    if (score <= 2){ label = S.settingsPwdWeak;   color = '#f97373'; }
    else if (score <= 3){ label = S.settingsPwdMedium; color = '#facc6b'; }
    else { label = S.settingsPwdStrong; color = '#4ade80'; }

    pwStrength.innerHTML = S.settingsPwdStrength + ': '
      + '<span style="color:'+color+'">'+label+'</span>';
  }

  // expose so applyLang() can re-run it on language change
  window.FX_UPDATE_STRENGTH = updateStrength;

  function setupAdminTools(){
    if (!adminTools) return;
    if (!isAdmin){
      adminTools.style.display = 'none';
      return;
    }
    adminTools.style.display = 'block';
    if (adminUser){
      adminUser.innerHTML = '';
      const accounts = loadAccounts();
      Object.keys(accounts).sort().forEach(k => {
        const opt = document.createElement('option');
        opt.value = k;
        opt.textContent = k;
        adminUser.appendChild(opt);
      });
    }
  }

  function resetForm(){
    if (userLabel) userLabel.textContent = CURRENT_USER || '-';

    if (lastLogin){
      const iso = localStorage.getItem(LAST_LOGIN_KEY);
      const Slocal = I18N[LANG] || I18N.en;
      lastLogin.textContent = (Slocal.settingsLastLogin || 'Last login') +
        ': ' + formatLocalDate(iso);
    }

    if (cur) cur.value = '';
    if (np)  np.value  = '';
    if (np2) np2.value = '';
    if (adminNew)  adminNew.value  = '';
    if (adminNew2) adminNew2.value = '';
    if (pwStrength) pwStrength.textContent = '';

    if (prefLang){
      prefLang.value = LANG || 'en';
    }
    if (prefIdle){
      const idle = readIdleMinutes();
      prefIdle.value = String(idle);
      if (!prefIdle.querySelector(`option[value="${idle}"]`)){
        prefIdle.value = '0';
      }
    }
    if (prefDensity){
      const d = localStorage.getItem(DENSITY_KEY) || 'normal';
      prefDensity.value = d;
    }
  }

  function openSettings(){
    if (!canUseSettings()){
      notifyWarn('This account cannot access Settings.');
      return;
    }
    resetForm();
    setupAdminTools();

    fxShowPanel('settingsPanel');
    sideNav(false);
    panel.scrollIntoView({behavior:'smooth', block:'start'});
  }

  function closeSettings(){
    fxShowPanel(null);
  }

  // expose for other code (top menu / nav)
  window.FX_OPEN_SETTINGS  = openSettings;
  window.FX_CLOSE_SETTINGS = closeSettings;

  // Back button
  if (btnBack){
    btnBack.addEventListener('click', (e)=>{
      e.preventDefault();
      closeSettings();
    });
  }

  // Password strength live update
  if (np){
    np.addEventListener('input', ()=> updateStrength(np.value));
  }

  // Save my own password
  if (btnSave){
    btnSave.addEventListener('click', (e)=>{
      e.preventDefault();
      if (!canUseSettings()){
        notifyWarn('This account cannot access Settings.');
        return;
      }

      const curVal  = cur.value  || '';
      const newVal  = np.value   || '';
      const new2Val = np2.value  || '';

      if (!curVal || !newVal || !new2Val){
        notifyWarn('Please fill in all fields.');
        return;
      }
      if (newVal !== new2Val){
        notifyWarn('New passwords do not match.');
        return;
      }
      if (newVal.length < 8 || !/[A-Za-z]/.test(newVal) || !/\d/.test(newVal)){
        notifyWarn('Password must be at least 8 characters and include letters & numbers.');
        return;
      }

      const accounts = loadAccounts();
      const key = CURRENT_USER;

      if (!accounts[key] || accounts[key] !== curVal){
        notifyError('Current password is not correct.');
        return;
      }

      accounts[key] = newVal;
      saveAccounts(accounts);
      notifySuccess('Password updated. Next login will use the new password.');
      resetForm();
      closeSettings();
    });
  }

  // ===== Preferences =====
  if (prefLang){
    prefLang.addEventListener('change', ()=>{
      setLang(prefLang.value);
    });
  }

  if (prefIdle){
    prefIdle.addEventListener('change', ()=>{
      const v = parseInt(prefIdle.value,10) || 0;
      localStorage.setItem(IDLE_KEY, String(Math.max(0, v)));
      notifyInfo(v ? `Auto logout set to ${v} minute(s).` : 'Auto logout disabled.');
    });
  }

  if (prefDensity){
    prefDensity.addEventListener('change', ()=>{
      const mode = prefDensity.value === 'compact' ? 'compact' : 'normal';
      localStorage.setItem(DENSITY_KEY, mode);
      applyTableDensity(mode);
    });
  }

  // ===== Admin tools =====
  if (btnAdminSet){
    btnAdminSet.addEventListener('click', async (e)=>{
      e.preventDefault();
      if (!isAdmin){
        notifyWarn('Only ADMIN can use these tools.');
        return;
      }

      const target = adminUser ? adminUser.value : '';
      const nv  = adminNew ? (adminNew.value || '') : '';
      const nv2 = adminNew2 ? (adminNew2.value || '') : '';

      if (!target || !nv || !nv2){
        notifyWarn('Please fill in all admin fields.');
        return;
      }
      if (nv !== nv2){
        notifyWarn('New passwords do not match.');
        return;
      }
      if (nv.length < 8 || !/[A-Za-z]/.test(nv) || !/\d/.test(nv)){
        notifyWarn('Password must be at least 8 characters and include letters & numbers.');
        return;
      }

      if (!(await fxConfirm(`Set a new password for "${target}"?`))) return;

      const accounts = loadAccounts();
      accounts[target] = nv;
      saveAccounts(accounts);
      notifySuccess(`Password for "${target}" updated. Next login will use the new password.`);
      if (adminNew)  adminNew.value  = '';
      if (adminNew2) adminNew2.value = '';
    });
  }

  if (btnAdminDef){
    btnAdminDef.addEventListener('click', async (e)=>{
      e.preventDefault();
      if (!isAdmin){
        notifyWarn('Only ADMIN can use these tools.');
        return;
      }

      const ok = await fxConfirm(
        'Restore ALL account passwords back to default values? This will overwrite any changes made on this device.'
      );
      if (!ok) return;

      const fresh = { ...DEFAULT_ACCOUNTS };
      saveAccounts(fresh);
      notifySuccess('All account passwords reset to defaults for this browser.');
      setupAdminTools();
      if (adminNew)  adminNew.value  = '';
      if (adminNew2) adminNew2.value = '';
    });
  }

  // ===== Navigation wiring =====
  const navSetting = document.getElementById('navSetting');
  if (navSetting){
    navSetting.addEventListener('click', (e)=>{
      e.preventDefault();
      openSettings();
    });
  }

  const topChange = document.getElementById('topChangePass');
  if (topChange){
    topChange.addEventListener('click', (e)=>{
      e.preventDefault();
      openSettings();
      const opt = document.getElementById('options');
      if (opt) opt.style.display = 'none';
    });
  }

  // Overview + Notification just go back to the main dashboard
  ['navOverview','navNotif'].forEach(id=>{
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('click', (e)=>{
      e.preventDefault();
      fxShowPanel(null);
    });
  });
}

// === FILES PANEL (scripts & editor) =========================
function initFilesUI(){
  const panel       = document.getElementById('filesPanel');
  if (!panel) return;

  const searchInput = document.getElementById('filesSearch');
  const tableBody   = document.querySelector('#filesTable tbody');
  const uploadInput = document.getElementById('fileUploadInput');
  const uploadBtn   = document.getElementById('btnFilesUpload');
  const uploadName  = document.getElementById('filesUploadName');
  const editor      = document.getElementById('fileEditor');
  const editorName  = document.getElementById('editorFilename');
  const btnSave     = document.getElementById('btnEditorSave');
  const btnDiscard  = document.getElementById('btnEditorDiscard');
  const btnBack     = document.getElementById('btnBackFiles');

  let files       = [];
  let currentId   = null;
  let currentText = '';
  let dirty       = false;

  function fmtBytes(bytes){
    const n = Number(bytes);
    if (!isFinite(n) || n < 0) return '‚Äî';
    if (n < 1024) return n + ' B';
    const kb = n / 1024;
    if (kb < 1024) return kb.toFixed(1) + ' KB';
    const mb = kb / 1024;
    if (mb < 1024) return mb.toFixed(1) + ' MB';
    const gb = mb / 1024;
    return gb.toFixed(1) + ' GB';
  }

  function fmtDate(val){
    if (!val) return '‚Äî';
    let d;
    if (typeof val === 'number'){
      d = new Date(val < 1e12 ? val * 1000 : val);
    }else{
      d = new Date(val);
    }
    if (!isFinite(d.getTime())) return '‚Äî';
    const pad = n => String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function markDirty(on){
    dirty = !!on;
    if (btnSave){
      btnSave.disabled      = !dirty;
      btnSave.style.opacity = dirty ? '1' : '.6';
      btnSave.style.cursor  = dirty ? 'pointer' : 'default';
    }
  }

  function refreshTable(){
    if (!tableBody) return;
    const q = (searchInput?.value || '').trim().toLowerCase();
    const S = I18N[LANG] || I18N.en;
    const noText = S.filesNoFiles || 'No scripts returned from API.';

    let view = files.slice().sort((a,b)=> String(a.name||'').localeCompare(String(b.name||'')));
    if (q){
      view = view.filter(f =>
        (f.name && f.name.toLowerCase().includes(q)) ||
        (f.path && f.path.toLowerCase().includes(q))
      );
    }

    tableBody.innerHTML = '';
    if (!view.length){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="4" style="text-align:center; opacity:.75;">${noText}</td>`;
      tableBody.appendChild(tr);
      return;
    }

    view.forEach(f => {
      const displayName = f.name || f.path || f.id;
      const pathPart = f.path && f.path !== f.name
        ? `<div class="file-path">${f.path}</div>` : '';
      const id = String(f.id ?? f.name ?? displayName);

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><strong>${displayName}</strong>${pathPart}</td>
        <td>${fmtBytes(f.size)}</td>
        <td>${fmtDate(f.mtime || f.modified || f.updated_at)}</td>
        <td>
          <button class="fx-btn secondary btn-animated" data-file-open="${id}">Open</button>
          <button class="fx-btn danger btn-animated" style="margin-left:6px;" data-file-delete="${id}">Delete</button>
        </td>`;
      tableBody.appendChild(tr);
    });

    tableBody.querySelectorAll('[data-file-open]').forEach(btn => {
      btn.addEventListener('click', () =>
        openFile(btn.getAttribute('data-file-open'))
      );
    });

    tableBody.querySelectorAll('[data-file-delete]').forEach(btn => {
      btn.addEventListener('click', () =>
        deleteFile(btn.getAttribute('data-file-delete'))
      );
    });
  }

  async function loadFiles(){
    try{
      showLoading(true);
      const res = await apiGet('/api/files');
      let data = [];
      try{ data = await res.json(); }catch(_){ data = []; }
      if (!Array.isArray(data)) data = [];
      files = data;
      refreshTable();
    }catch(e){
      console.error(e);
      notifyError('Failed to load files: ' + (e.message || e));
    }finally{
      showLoading(false);
    }
  }

  async function openFile(id){
    if (!id) return;

    if (dirty){
      const ok = await fxConfirm('Discard unsaved changes in editor?');
      if (!ok) return;
    }

    try{
      showLoading(true);
      const res  = await apiGet('/api/files/' + encodeURIComponent(id));
      const text = await res.text();

      currentId   = id;
      currentText = text || '';
      if (editor) editor.value = currentText;

      if (editorName){
        const meta = files.find(f => String(f.id ?? f.name) === String(id));
        editorName.textContent = meta ? (meta.path || meta.name || id) : id;
      }

      markDirty(false);
    }catch(e){
      console.error(e);
      notifyError('Failed to open file: ' + (e.message || e));
    }finally{
      showLoading(false);
    }
  }
    async function deleteFile(id){
    if (!id) return;

    // Find file info for nice name in confirm dialog
    const meta = files.find(f => String(f.id ?? f.name) === String(id));
    const displayName = meta ? (meta.path || meta.name || id) : id;

    const ok = await fxConfirm(
      `Delete script "${displayName}" from this agent?\nThis cannot be undone.`
    );
    if (!ok) return;

    const A = getApi();
    if (!A) return;

    const path = '/api/files/' + encodeURIComponent(id);

    const build = (useQueryToken) => {
      const url = A.base + path + (
        useQueryToken && A.tk
          ? (path.includes('?') ? '&' : '?') + 'token=' + encodeURIComponent(A.tk)
          : ''
      );
      const headers = useQueryToken || !A.tk ? {} : { 'Authorization':'Bearer '+A.tk };
      return {
        url,
        opt: {
          method: 'DELETE',
          headers
        }
      };
    };

    showLoading(true);
    try{
      // try Authorization header first
      let {url,opt} = build(false);
      let r = await fetch(url,opt);
      if (!r.ok){
        // fallback: token in query string
        ({url,opt} = build(true));
        r = await fetch(url,opt);
        if (!r.ok) throw new Error((await r.text()) || r.statusText);
      }

      // Remove from local list
      files = files.filter(f => String(f.id ?? f.name) !== String(id));

      // If this file was open in editor, clear editor
      if (currentId === id){
        currentId   = null;
        currentText = '';
        const S = I18N[LANG] || I18N.en;
        if (editor)      editor.value = '';
        if (editorName)  editorName.textContent =
          (S.filesEditorNoFile || 'No file selected.');
        markDirty(false);
      }

      notifySuccess(`"${displayName}" deleted.`);
      refreshTable();
    }catch(e){
      console.error(e);
      notifyError('Delete failed: ' + (e.message || e));
    }finally{
      showLoading(false);
    }
  }

  async function saveFile(){
    if (!currentId){
      notifyWarn('Select a script from the list first.');
      return;
    }
    const nextText = editor ? (editor.value || '') : '';
    if (nextText === currentText){
      markDirty(false);
      notifyInfo('No changes to save.');
      return;
    }

    try{
      showLoading(true);
      await apiPost('/api/files/' + encodeURIComponent(currentId), { code: nextText });
      currentText = nextText;
      markDirty(false);
      notifySuccess('File saved.');
      loadFiles();
    }catch(e){
      console.error(e);
      notifyError('Save failed: ' + (e.message || e));
    }finally{
      showLoading(false);
    }
  }

  async function uploadFile(file){
    if (!file) return;

    const ok = await fxConfirm(`Upload "${file.name}" to the agent?`);
    if (!ok) return;

    const A = getApi(); 
    if (!A) return;

    showLoading(true);
    const fd = new FormData();
    fd.append('file', file);
    const path = '/api/files/upload';

    const build = (useQuery)=> {
      const url = A.base + path + (
        useQuery && A.tk
          ? (path.includes('?') ? '&' : '?') + 'token=' + encodeURIComponent(A.tk)
          : ''
      );
      const headers = useQuery || !A.tk ? {} : { 'Authorization':'Bearer '+A.tk };
      return { url, opt:{ method:'POST', headers, body:fd } };
    };

    try{
      let {url,opt} = build(false);
      let r = await fetch(url,opt);
      if (!r.ok) throw new Error((await r.text()) || r.statusText);
    }catch(err){
      try{
        const {url,opt} = build(true);
        const r2 = await fetch(url,opt);
        if (!r2.ok) throw new Error((await r2.text()) || r2.statusText);
      }catch(err2){
        console.error(err2);
        notifyError('Upload failed: ' + (err2.message || err2));
        showLoading(false);
        return;
      }
    }

    notifySuccess('Upload completed.');
    showLoading(false);
    await loadFiles();
  }

  function openPanel(){
    fxShowPanel('filesPanel');
    sideNav(false);
    loadFiles();
  }

  function closePanel(){
    fxShowPanel(null);
  }

  // === Wire events ===
  if (searchInput){
    searchInput.addEventListener('input', ()=> refreshTable());
  }

  if (uploadBtn && uploadInput){
    uploadBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      uploadInput.click();
    });
    uploadInput.addEventListener('change', ()=>{
      const f = uploadInput.files && uploadInput.files[0];
      const S = I18N[LANG] || I18N.en;
      if (uploadName){
        uploadName.textContent = f
          ? f.name
          : (S.filesEditorNoFile || 'No file selected.');
      }
      if (f) uploadFile(f);
      uploadInput.value = '';
    });
  }

  if (editor){
    editor.addEventListener('input', ()=>{
      if (!dirty && editor.value !== currentText) markDirty(true);
      else if (dirty && editor.value === currentText) markDirty(false);
    });
  }

  if (btnSave){
    btnSave.addEventListener('click', (e)=>{
      e.preventDefault();
      saveFile();
    });
    markDirty(false);
  }

  if (btnDiscard){
    btnDiscard.addEventListener('click', async (e)=>{
      e.preventDefault();
      if (!dirty) return;
      const ok = await fxConfirm('Discard unsaved changes?');
      if (!ok) return;
      if (editor) editor.value = currentText || '';
      markDirty(false);
    });
  }

  if (btnBack){
    btnBack.addEventListener('click', (e)=>{
      e.preventDefault();
      closePanel();
    });
  }

  const navFiles = document.getElementById('navFiles');
  if (navFiles){
    navFiles.addEventListener('click', (e)=>{
      e.preventDefault();
      openPanel();
    });
  }

  // Expose for console / other code if needed
  window.FX_OPEN_FILES  = openPanel;
  window.FX_CLOSE_FILES = closePanel;
}

// === OVERVIEW PANEL: shortcut buttons to other pages ==============
function initOverviewUI(){
  const btnMon = document.getElementById('btnGoMonitor');
  if (btnMon){
    btnMon.addEventListener('click', (e)=>{
      e.preventDefault();
      fxShowPanel('monitorPanel');
      sideNav(false);
    });
  }

  const btnFiles = document.getElementById('btnGoFiles');
  if (btnFiles){
    btnFiles.addEventListener('click', (e)=>{
      e.preventDefault();
      if (window.FX_OPEN_FILES) window.FX_OPEN_FILES();
      else fxShowPanel('filesPanel');
      sideNav(false);
    });
  }

  const btnSet = document.getElementById('btnGoSettings');
  if (btnSet){
    btnSet.addEventListener('click', (e)=>{
      e.preventDefault();
      if (window.FX_OPEN_SETTINGS) window.FX_OPEN_SETTINGS();
      else fxShowPanel('settingsPanel');
      sideNav(false);
    });
  }
}

// === MONITOR PANEL (nav + back) ===============================
function initMonitorUI() {
  const navMonitor = document.getElementById('navMonitor');
  if (navMonitor) {
    navMonitor.addEventListener('click', (e) => {
      e.preventDefault();
      fxShowPanel('monitorPanel');  // show Monitor full-screen
      sideNav(false);               // close the side nav drawer
    });
  }

  const btnBack = document.getElementById('btnBackMonitor');
  if (btnBack) {
    btnBack.addEventListener('click', (e) => {
      e.preventDefault();
      fxShowPanel(null);           // go back to Overview
    });
  }
}
// ============================================================

function setupAuto(){
  if(timer) clearInterval(timer);
  const ms=+document.getElementById('interval').value||0;
  if(ms>0){ timer=setInterval(()=>loadOverview().catch(()=>{}),ms); notifySuccess('Auto-refresh enabled.'); }
}
document.getElementById('interval').addEventListener('change', setupAuto);

(function boot(){
  const b  = localStorage.getItem(LS_BASE)||''; 
  const t  = localStorage.getItem(LS_TOKEN)||''; 
  const iv = localStorage.getItem(LS_INT)||'0';

  if (document.getElementById('base'))     document.getElementById('base').value     = b;
  if (document.getElementById('token'))    document.getElementById('token').value    = t;
  if (document.getElementById('interval')) document.getElementById('interval').value = iv;

  initTheme();

  // optional: remember compact/normal rows across reloads
  try{
    const savedDensity = localStorage.getItem(DENSITY_KEY) || 'normal';
    applyTableDensity(savedDensity);
  }catch(e){}

  applyLang();
  initSettingsUI();
  initFilesUI();
  initMonitorUI();   // wire the MONITOR page
  initOverviewUI();

  if (b && t) { 
    loadOverview().catch(()=>{}); 
    setupAuto(); 
  }
})();
</script>
</body>
</html>
</template>

<script>
(function(){
  const AUTH_KEY = 'fixline_auth';
  const REM_KEY  = 'fixline_remember';
  const IDLE_KEY       = 'fixline_idle_minutes';
  const LAST_LOGIN_KEY = 'fixline_last_login';

  // === Account config (all login users) ======================
  const ACCOUNTS_KEY = 'fixline_accounts';

  // store keys in UPPERCASE (login is case-insensitive)
  const DEFAULT_ACCOUNTS = {
    "ADMIN": "Fixline@123",
    "BA55":  "Ba@01",
    "ZB1":   "Zb@1122",
    "DR1":   "Dr@2222",
    "RTM12": "Rtm@123"
  };

  function loadAccounts() {
    try {
      const raw = window.localStorage.getItem(ACCOUNTS_KEY);
      if (raw) {
        const parsed = JSON.parse(raw);
        if (parsed && typeof parsed === 'object') return parsed;
      }
    } catch(e) {}
    // if empty/broken, reset defaults
    const base = { ...DEFAULT_ACCOUNTS };
    try { window.localStorage.setItem(ACCOUNTS_KEY, JSON.stringify(base)); } catch(e) {}
    return base;
  }

  function saveAccounts(map) {
    try { window.localStorage.setItem(ACCOUNTS_KEY, JSON.stringify(map)); } catch(e) {}
  }
  // ===========================================================
  const loginFrame = document.getElementById('loginFrame');
  const dashFrame  = document.getElementById('dashFrame');

  loginFrame.srcdoc = document.getElementById('loginTpl').innerHTML;

  function showLoader(ms = 1200, after){
    const L = document.getElementById('fxLoader');
    L.classList.add('on');
    setTimeout(() => {
      L.classList.remove('on');
      if (after) after();
    }, ms);
  }

  function showApp(){
    if (!dashFrame.dataset.loaded){
      dashFrame.srcdoc = document.getElementById('dashTpl').innerHTML;
      dashFrame.dataset.loaded = '1';
    }
    loginFrame.style.display = 'none';
    dashFrame.style.display  = 'block';
  }

  // Listen for logout + activity pings from inside the dashboard iframe
  window.addEventListener('message', (ev) => {
    if (ev?.data?.type === 'FIXLINE_LOGOUT'){
      try { sessionStorage.removeItem(AUTH_KEY); } catch(e){}
      showLoader(600, () => {
        dashFrame.style.display = 'none';
        loginFrame.style.display = 'block';
        loginFrame.srcdoc = document.getElementById('loginTpl').innerHTML;
        dashFrame.removeAttribute('data-loaded');
        dashFrame.srcdoc = '';
      });
    } else if (ev?.data?.type === 'FX_ACTIVITY') {
      // reset idle timer when user interacts inside dashboard iframe
      if (typeof resetActivity === 'function') {
        resetActivity();
      }
    }
  });

  // Intercept login form submit inside the login iframe
  loginFrame.addEventListener('load', () => {
    try{
      const doc  = loginFrame.contentDocument;
      const win  = loginFrame.contentWindow;
      const form = doc.getElementById('loginForm');
      if (!form) return;

      // Prefill from Remember me
      try{
        const raw = window.localStorage.getItem(REM_KEY);
        if (raw){
          const saved = JSON.parse(raw);
          if (saved && saved.remember){
            const uField = doc.getElementById('user');
            const pField = doc.getElementById('pass');
            const chk    = doc.getElementById('remember');
            if (uField && typeof saved.u === 'string') uField.value = saved.u;
            if (pField && typeof saved.p === 'string') pField.value = saved.p;
            if (chk) chk.checked = true;
          }
        }
      }catch(e){}

      // --- LOGIN submit (multi-account) ----------------------
      form.addEventListener('submit', (ev) => {
        ev.preventDefault();
        ev.stopImmediatePropagation();

        const wrap = doc.getElementById('vbtn');
        if (wrap){
          wrap.classList.add('play');
          setTimeout(() => wrap.classList.remove('play'), 900);
        }

        const uRaw = (doc.getElementById('user')?.value || '').trim();
        const p    = (doc.getElementById('pass')?.value || '');
        const remember = !!doc.getElementById('remember')?.checked;

        const usernameKey = uRaw.toUpperCase();   // case-insensitive
        const accounts    = loadAccounts();

        if (accounts[usernameKey] && accounts[usernameKey] === p){
          // Remember-me
          try{
            if (remember){
              window.localStorage.setItem(REM_KEY, JSON.stringify({u:uRaw,p,remember:true}));
            }else{
              window.localStorage.removeItem(REM_KEY);
            }
          }catch(e){}

          // Per-tab auth + store CURRENT USER
          sessionStorage.setItem(AUTH_KEY,'1');
          sessionStorage.setItem('fixline_user', usernameKey);
          try{
           window.localStorage.setItem(LAST_LOGIN_KEY, new Date().toISOString());
          }catch(e){}
          showLoader(1200, showApp);
        } else {
          if (typeof win.toast === 'function'){
            win.toast('warning','Invalid username or password. ‚ö†Ô∏è');
          }
        }
      }, true);
      // -------------------------------------------------------
    }catch(e){}
  });

  // If the dashboard iframe ever navigates to login.html, treat as logout
  dashFrame.addEventListener('load', () => {
    try{
      const href = dashFrame.contentWindow.location?.href || '';
      if (/login\.html(\?|#|$)/i.test(href)) {
        sessionStorage.removeItem(AUTH_KEY);
        showLoader(600, () => {
          dashFrame.style.display = 'none';
          loginFrame.style.display = 'block';
          loginFrame.srcdoc = document.getElementById('loginTpl').innerHTML;
          dashFrame.removeAttribute('data-loaded');
          dashFrame.srcdoc = '';
        });
      }
    }catch(e){}
  });

  // When user refreshes this tab, if we still have auth in *this tab*,
  // skip login and go straight to dashboard.
    // ===== Idle auto-logout (based on IDLE_KEY from dashboard) =====
  let idleMinutes = 0;
  let lastActivity = Date.now();

  function readIdleSetting(){
    try{
      const raw = window.localStorage.getItem(IDLE_KEY);
      const v = parseInt(raw, 10);
      idleMinutes = isNaN(v) ? 0 : Math.max(0, v);
    }catch(e){
      idleMinutes = 0;
    }
  }

  function resetActivity(){
    lastActivity = Date.now();
  }

  function checkIdle(){
    if (!sessionStorage.getItem(AUTH_KEY)) return; // not logged in
    if (!idleMinutes) return;                      // 0 = off
    const diff = Date.now() - lastActivity;
    if (diff >= idleMinutes * 60 * 1000){
      // Auto logout flow (same as manual logout)
      sessionStorage.removeItem(AUTH_KEY);
      sessionStorage.removeItem('fixline_user');
      showLoader(600, () => {
        dashFrame.style.display = 'none';
        loginFrame.style.display = 'block';
        loginFrame.srcdoc = document.getElementById('loginTpl').innerHTML;
        dashFrame.removeAttribute('data-loaded');
        dashFrame.srcdoc = '';
      });
    }
  }

  ['mousemove','keydown','click','touchstart'].forEach(ev => {
    window.addEventListener(ev, resetActivity, true);
  });

  window.addEventListener('storage', (e) => {
    if (e.key === IDLE_KEY) readIdleSetting();
  });

  readIdleSetting();
  setInterval(checkIdle, 30000);
  if (sessionStorage.getItem(AUTH_KEY)) {
    showLoader(400, showApp);
  }
})();
</script>
</body>
</html>
